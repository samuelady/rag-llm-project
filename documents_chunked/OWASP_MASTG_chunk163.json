{"text": "a whole. Nexttothat,itisgoodtovetwhetherallbestpracticesforsoftwareengineeringareapplied. 504\\nDynamic Analysis Thedynamicanalysisofthissectioncomprisesoftwoparts: theactuallicenseverificationandcheckingwhichlibraries areinvolvedincaseofmissingsources. Itneedtobevalidatedwhetherthecopyrightsofthelicenseshavebeenadheredto. Thisoftenmeansthattheapplication shouldhaveanaboutorEULAsectioninwhichthecopy-rightstatementsarenotedasrequiredbythelicenseofthethird partylibrary. Listing Application Libraries When performing app analysis, it is important to also analyze the app dependencies (usually in form of libraries or so- called iOS Frameworks) and ensure that they don’t contain any vulnerabilities. Even when you don’t have the source code, you can still identify some of the app dependencies using tools likeobjection, MobSF or the otool -L command. Objectionistherecommendedtool,sinceitprovidesthemostaccurateresultsanditiseasytouse. Itcontainsamodule toworkwithiOSBundles,whichofferstwocommands: list_bundlesandlist_frameworks. Thelist_bundlescommandlistsalloftheapplication’sbundlesthatarenotrelatedtoFrameworks. Theoutputcontains executablename,bundleid,versionofthelibraryandpathtothelibrary. ...itudehacks.DVIAswiftv2.developon (iPhone:13.2.3)[usb] #iosbundleslist_bundles Executable Bundle Version Path ##MakeSureThatFreeSecurityFeaturesAreActivated >**Platform:**ios > >**MASVSV1:**MSTG-CODE-9 > >**MASVSV2:**MASVS-CODE-4 ###Overview ###StaticAnalysis Youcanuseradare2tocheckthebinarysecurityfeatures. Let'susethe[DamnVulnerableiOSAppDVIAv1](https://github.com/prateek147/DVIA/)asanexample.Openitsmainbinarywithradare2: ```bash r2DamnVulnerableIOSApp Andrunthefollowingcommands: [0x1000180c8]>i~pic,canary canary true pic true [0x1000180c8]>is~release,retain 124 0x002951e00x1000891e0LOCAL FUNC0 imp.dispatch_release 149 0x00294e800x100088e80LOCAL FUNC0 imp.objc_autorelease 150 0x00294e8c0x100088e8cLOCAL FUNC0 imp.objc_autoreleasePoolPop 151 0x00294e980x100088e98LOCAL FUNC0 imp.objc_autoreleasePoolPush 152 0x00294ea40x100088ea4LOCAL FUNC0 imp.objc_autoreleaseReturnValue 165 0x00294f400x100088f40LOCAL FUNC0 imp.objc_release 167 0x00294f580x100088f58LOCAL FUNC0 imp.objc_retainAutorelease 168 0x00294f640x100088f64LOCAL FUNC0 imp.objc_retainAutoreleaseReturnValue 169 0x00294f700x100088f70LOCAL FUNC0 imp.objc_retainAutoreleasedReturnValue Allthefeaturesareenabledintheseexamples: • PIE(PositionIndependentExecutable): indicatedbytheflagpic true. – Appliestoallappsindependentlyofthelanguageused. – Appliesonlytothemainexecutable(MH_EXECUTE),nottodynamiclibraries(MH_DYLIB). • StackCanary: indicatedbytheflagcanary true. – AppliestoappscontainingObjective-Ccode. – NotnecessarilyrequiredforpureSwiftapps(Swiftismemorysafebydesign). – EspeciallyimportantforappscontainingC/C++code,astheyprovidedirectaccesstomemoryandpointers, makingthemmorevulnerabletobufferoverflows. 505\\n• ARC (Automatic Reference Counting): indicated by symbols such as objc_autorelease or objc_retainAutore- lease. – ImportantforbinariescontainingObjective-Ccode. – ForbinarieswrittenpurelyinSwift,ARCisenabledbydefault. – ARC is not relevant for binaries written purely in C/C++, as it’s a memory management feature specific to Objective-CandSwift. Dynamic Analysis Thesecheckscanbeperformeddynamicallyusingobjection. Here’soneexample: com.yourcompany.PPClienton (iPhone:13.2.3)[usb] #iosinfobinary Name Type Encrypted PIE ARC Canary StackExec RootSafe --- masvs_category:MASVS-RESILIENCE platform:ios --- #iOSAnti-ReversingDefenses ##Overview Thischaptercoversdefense-in-depthmeasuresrecommendedforappsthatprocess,orgiveaccessto,sensitivedataorfunctionality.Researchshows that[many ↪ AppStoreappsoftenincludethesemeasures](https://seredynski.com/articles/a-security-review-of-1-300-appstore-applications \"Asecurityreviewof1,300 ↪ AppStoreapplications-5April2020\"). Thesemeasuresshouldbeappliedasneeded,basedonanassessmentoftheriskscausedbyunauthorizedtamperingwiththe appand/orreverseengineeringofthe ↪ code. -Appsmustneverusethesemeasuresasareplacementforsecuritycontrols,andarethereforeexpectedtofulfillother baselinesecuritymeasuressuchasthe ↪ restoftheMASVSsecuritycontrols. -Appsshouldcombinethesemeasurescleverlyinsteadofusingthemindividually.Thegoalistodiscouragereverseengineersfrom performingfurtheranalysis. -Integratingsomeofthecontrolsintoyourappmightincreasethecomplexityofyourappandevenhavean impactonitsperformance. YoucanlearnmoreaboutprinciplesandtechnicalrisksofreverseengineeringandcodemodificationintheseOWASPdocuments: -[OWASPArchitecturalPrinciplesThatPreventCodeModificationorReverse ↪ Engineering](https://wiki.owasp.org/index.php/OWASP_Reverse_Engineering_and_Code_Modification_Prevention_Project \"OWASPArchitecturalPrinciplesThat ↪ PreventCodeModificationorReverseEngineering\") -[OWASPTechnicalRisksofReverseEngineeringandUnauthorizedCode ↪ Modification](https://wiki.owasp.org/index.php/Technical_Risks_of_Reverse_Engineering_and_Unauthorized_Code_Modification \"OWASPTechnicalRisksofReverse ↪ EngineeringandUnauthorizedCodeModification\") ###GeneralDisclaimer The**lackofanyofthesemeasuresdoesnotcauseavulnerability**-instead,theyaremeanttoincreasetheapp'sresilienceagainstreverseengineeringand ↪ specificclient-sideattacks. Noneofthesemeasurescanassurea100%effectiveness,asthereverseengineerwillalwayshavefullaccesstothe deviceandwillthereforealwayswin(given ↪ enoughtimeandresources)! Forexample,preventingdebuggingisvirtuallyimpossible.Iftheappispubliclyavailable,itcanberunonanuntrusted devicethatisunderfullcontrolof ↪ theattacker.Averydeterminedattackerwilleventuallymanagetobypassalltheapp'santi-debugging controlsbypatchingtheappbinaryorbydynamically ↪ modifyingtheapp'sbehavioratruntimewithtoolssuchasFrida. ###JailbreakDetection Jailbreakdetectionmechanismsareaddedtoreverseengineeringdefensetomakerunningtheapponajailbrokendevicemoredifficult. Thisblockssomeofthe ↪ toolsandtechniquesreverseengineersliketouse.Likemostothertypesofdefense,jailbreakdetectionisnotveryeffective byitself,butscattering ↪ checksthroughouttheapp'ssourcecodecanimprovetheeffectivenessoftheoverallanti-tamperingscheme. >YoucanlearnmoreaboutJailbreak/RootDetectionintheresearchstudy [\"Jailbreak/RootDetectionEvasionStudyoniOSand ↪ Android\"](https://github.com/crazykid95/Backup-Mobile-Security-Report/blob/master/Jailbreak-Root-Detection-Evasion-Study-on-iOS-and-Android.pdf ↪ \"Jailbreak/RootDetectionEvasionStudyoniOSandAndroid\")byDanaGeistandMaratNigmatullin. ####CommonJailbreakDetectionChecks Herewepresentthreetypicaljailbreakdetectiontechniques: **File-basedChecks:** Theappmightbecheckingforfilesanddirectoriestypicallyassociatedwithjailbreaks,suchas: ```default /Applications/Cydia.app /Applications/FakeCarrier.app /Applications/Icy.app /Applications/IntelliScreen.app /Applications/MxTube.app /Applications/RockApp.app /Applications/SBSettings.app /Applications/WinterBoard.app /Applications/blackra1n.app 506\\n/Library/MobileSubstrate/DynamicLibraries/LiveClock.plist /Library/MobileSubstrate/DynamicLibraries/Veency.plist /Library/MobileSubstrate/MobileSubstrate.dylib /System/Library/LaunchDaemons/com.ikey.bbot.plist /System/Library/LaunchDaemons/com.saurik.Cydia.Startup.plist /bin/bash /bin/sh /etc/apt /etc/ssh/sshd_config /private/var/lib/apt /private/var/lib/cydia /private/var/mobile/Library/SBSettings/Themes /private/var/stash /private/var/tmp/cydia.log /var/tmp/cydia.log /usr/bin/sshd /usr/libexec/sftp-server /usr/libexec/ssh-keysign /usr/sbin/sshd /var/cache/apt /var/lib/apt /var/lib/cydia /usr/sbin/frida-server /usr/bin/cycript /usr/local/bin/cycript /usr/lib/libcycript.dylib /var/log/syslog CheckingFilePermissions: Theappmightbetryingtowritetoalocationthat’soutsidetheapplication’ssandbox. Forinstance,itmayattemptto createafilein,forexample,the/privatedirectory. Ifthefileiscreatedsuccessfully,theappcanassumethatthedevice hasbeenjailbroken. do{ letpathToFileInRestrictedDirectory =\"/private/jailbreak.txt\" try\"Thisisatest.\".write(toFile:pathToFileInRestrictedDirectory,atomically:true,encoding:String.Encoding.utf8) tryFileManager.default.removeItem(atPath:pathToFileInRestrictedDirectory) //Deviceisjailbroken }catch { //Deviceisnotjailbroken } CheckingProtocolHandlers: Theappmightbeattemptingtocallwell-knownprotocolhandlerssuchascydia://(availablebydefaultafterinstalling Cydia). ifleturl=URL(string:\"cydia://package/com.example.package\"),UIApplication.shared.canOpenURL(url){ //Deviceisjailbroken } Automated Jailbreak Detection Bypass ThequickestwaytobypasscommonJailbreakdetectionmechanismsisobjection. Youcanfindtheimplementationofthe jailbreakbypassinthejailbreak.tsscript. Manual Jailbreak Detection Bypass Iftheautomatedbypassesaren’teffectiveyouneedtogetyourhandsdirtyandreverseengineertheappbinariesuntil youfindthepiecesofcoderesponsibleforthedetectionandeitherpatchthemstaticallyorapplyruntimehookstodisable them. Step1: ReverseEngineering: Whenyouneedtoreverseengineerabinarylookingforjailbreakdetection,themostobviouswayistosearchforknown strings,suchas“jail”or“jailbreak”. Notethatthiswon’tbealwayseffective,especiallywhenresiliencemeasuresarein placeorsimplywhenthethedeveloperhasavoidedsuchobviousterms. Example: DownloadtheDamnVulnerableiOSapplication(DVIA-v2),unzipit,loadthemainbinaryintoradare2andwait fortheanalysistocomplete. 507\\nr2-A./DVIA-v2-swift/Payload/DVIA-v2.app/DVIA-v2 Nowyoucanlistthebinary’ssymbolsusingtheiscommandandapplyacase-insensitivegrep(~+)forthestring“jail”. [0x1001a9790]>is~+jail ... 2230 0x001949a80x1001949a8GLOBALFUNC0 DVIA_v2.JailbreakDetectionViewController.isJailbroken.allocator__Bool 7792 0x0016d2d80x10016d2d8LOCAL FUNC0 +[JailbreakDetectionisJailbroken] ... Asyoucansee,there’saninstancemethodwiththesignature-[JailbreakDetectionVC isJailbroken]. Step2: DynamicHooks: NowyoucanuseFridatobypassjailbreakdetectionbyperformingtheso-calledearlyinstrumentation,thatis,byreplacing functionimplementationrightatstartup. Usefrida-traceonyourhostcomputer: frida-trace -U-f/Applications/DamnVulnerableIOSApp.app/DamnVulnerableIOSApp -m\"-[JailbreakDetectionVCisJailbroken]\" This will start the app, trace calls to -[JailbreakDetectionVC isJailbroken], and create a JavaScript hook for each matchingelement. Open./__handlers__/__JailbreakDetectionVC_isJailbroken_.jswithyourfavouritteeditorand edit the onLeave callback function. You can simply replace the return value using retval.replace() to always return 0: onLeave:function (log,retval,state){ console.log(\"Function[JailbreakDetectionVCisJailbroken]originallyreturned:\"+retval); retval.replace(0); console.log(\"Changingthereturnvalueto:\"+retval); } Thiswillprovidethefollowingoutput: $frida-trace -U-f/Applications/DamnVulnerableIOSApp.app/DamnVulnerableIOSApp -m\"-[JailbreakDetectionVCisJailbroken]:\" Instrumentingfunctions... `... -[JailbreakDetectionVCisJailbroken]:Loadedhandlerat \"./__handlers__/__JailbreakDetectionVC_isJailbroken_.js\" Startedtracing1function.PressCtrl+Ctostop. Function[JailbreakDetectionVCisJailbroken]originallyreturned:0x1 Changingthereturnvalueto:0x0 Anti-Debugging Detection Exploringapplicationsusingadebuggerisaverypowerfultechniqueduringreversing. Youcannotonlytrackvariables containingsensitivedataandmodifythecontrolflowoftheapplication,butalsoreadandmodifymemoryandregisters. There are several anti-debugging techniques applicable to iOS which can be categorized as preventive or as reactive. When properly distributed throughout the app, these techniques act as a supportive measure to increase the overall resilience. • Preventivetechniquesactasafirstlineofdefensetoimpedethedebuggerfromattachingtotheapplicationatall. • Reactivetechniquesallowtheapplicationtodetectthepresenceofadebuggerandhaveachancetodivergefrom normalbehavior. Using ptrace Asseeninchapter“TamperingandReverseEngineeringoniOS”,theiOSXNUkernelimplementsaptracesystemcall that’s lacking most of the functionality required to properly", "metadata": {"doc_id": "OWASP_MASTG", "chunk_id": 163}}