{"text": ".setEndDate(endDate) .build(); KeyPairGeneratorkeyPairGenerator =KeyPairGenerator.getInstance(\"RSA\", \"AndroidKeyStore\"); keyPairGenerator.initialize(keyPairGeneratorSpec); KeyPairkeyPair =keyPairGenerator.generateKeyPair(); This sample creates the RSA key pair with a key size of 4096-bit (i.e. modulus size). Elliptic Curve (EC) keys can also begeneratedinasimilarway. HoweverasofAndroid11(APIlevel30),AndroidKeyStoredoesnotsupportencryptionor decryptionwithECkeys. Theycanonlybeusedforsignatures. AsymmetricencryptionkeycanbegeneratedfromthepassphrasebyusingthePasswordBasedKeyDerivationFunction version 2 (PBKDF2). This cryptographic protocol is designed to generate cryptographic keys, which can be used for cryptographypurpose. Inputparametersforthealgorithmareadjustedaccordingtoweakkeygenerationfunctionsection. Thecodelistingbelowillustrateshowtogenerateastrongencryptionkeybasedonapassword. public static SecretKey generateStrongAESKey(char[]password,intkeyLength) { //Initializeobjectsandvariablesforlateruse intiterationCount =10000; intsaltLength =keyLength /8; SecureRandomrandom =newSecureRandom(); //Generatethesalt byte[]salt =newbyte[saltLength]; random.nextBytes(salt); KeySpeckeySpec =newPBEKeySpec(password.toCharArray(),salt,iterationCount,keyLength); SecretKeyFactorykeyFactory =SecretKeyFactory.getInstance(\"PBKDF2WithHmacSHA1\"); byte[]keyBytes =keyFactory.generateSecret(keySpec).getEncoded(); return newSecretKeySpec(keyBytes,\"AES\"); } Theabovemethodrequiresacharacterarraycontainingthepasswordandtheneededkeylengthinbits,forinstancea128 or256-bitAESkey. Wedefineaniterationcountof10,000roundswhichwillbeusedbythePBKDF2algorithm. Increasing the number of iterations significantly increases the workload for a brute-force attack on the password, however it can affectperformanceasmorecomputationalpowerisrequiredforkeyderivation. Wedefinethesaltsizeequaltothekey lengthdividedby8inordertoconvertfrombitstobytesandweusetheSecureRandomclasstorandomlygenerateasalt. Thesaltneedstobekeptconstanttoensurethesameencryptionkeyisgeneratedtimeaftertimeforthesamesupplied password. NotethatyoucanstorethesaltprivatelyinSharedPreferences. Itisrecommendedtoexcludethesaltfrom theAndroidbackupmechanismtopreventsynchronizationincaseofhigherriskdata. 222\\nNote that if you take a rooted device or a patched (e.g. repackaged) application into account as a threat to the data,itmightbebettertoencryptthesaltwithakeythatisplacedintheAndroidKeystore. ThePassword-Based Encryption(PBE)keyisgeneratedusingtherecommendedPBKDF2WithHmacSHA1algorithm,untilAndroid8.0(API level26). ForhigherAPIlevels,itisbesttousePBKDF2withHmacSHA256,whichwillendupwithalongerhashvalue. Note: thereisawidespreadfalsebelievethattheNDKshouldbeusedtohidecryptographicoperationsandhardcoded keys. However,usingthismechanismisnoteffective. Attackerscanstillusetoolstofindthemechanismusedandmake dumpsofthekeyinmemory. Next,thecontrolflowcanbeanalyzedwithe.g.radare2andthekeysextractedwiththe help of Frida or the combination of both: r2frida (see sections “Disassembling Native Code”, “Memory Dump” and “In- MemorySearch”inthechapter“TamperingandReverseEngineeringonAndroid”formoredetails). FromAndroid7.0(API level24)onward,itisnotallowedtouseprivateAPIs,instead: publicAPIsneedtobecalled,whichfurtherimpactsthe effectivenessofhidingitawayasdescribedintheAndroidDevelopersBlog Random number generation Cryptographyrequiressecurepseudorandomnumbergeneration(PRNG).StandardJavaclassesasjava.util.Random donotprovidesufficientrandomnessandinfactmaymakeitpossibleforanattackertoguessthenextvaluethatwillbe generated,andusethisguesstoimpersonateanotheruseroraccesssensitiveinformation. Ingeneral,SecureRandomshouldbeused. However,iftheAndroidversionsbelowAndroid4.4(APIlevel19)aresupported, additionalcareneedstobetakeninordertoworkaroundthebuginAndroid4.1-4.3(APIlevel16-18)versionsthatfailed toproperlyinitializethePRNG. MostdevelopersshouldinstantiateSecureRandomviathedefaultconstructorwithoutanyarguments. Otherconstructors areformoreadvancedusesand,ifusedincorrectly,canleadtodecreasedrandomnessandsecurity. ThePRNGprovider backingSecureRandomusestheSHA1PRNGfromAndroidOpenSSL(Conscrypt)provider. Testing Symmetric Cryptography Platform: android MASVSV1: MSTG-CRYPTO-1 MASVSV2: MASVS-CRYPTO-1 Overview Static Analysis Identify all the instances of symmetric key encryption in code and look for any mechanism which loads or provides a symmetrickey. Youcanlookfor: • symmetricalgorithms(suchasDES,AES,etc.) • specifications for a key generator (such as KeyGenParameterSpec, KeyPairGeneratorSpec, KeyPairGenerator, KeyGenerator,KeyProperties,etc.) • classesimportingjava.security.*,javax.crypto.*,android.security.*,android.security.keystore.* Checkalsothelistofcommoncryptographicconfigurationissues. Foreachidentifiedinstanceverifyiftheusedsymmetrickeys: • arenotpartoftheapplicationresources • cannotbederivedfromknownvalues • arenothardcodedincode Foreachhardcodedsymmetrickey, verifythatisnotusedinsecurity-sensitivecontextsastheonlymethodofencryp- tion. 223\\nAsanexampleweillustratehowtolocatetheuseofahardcodedencryptionkey. Firstdisassembleanddecompilethe apptoobtainJavacode,e.g.byusingjadx. NowsearchthefilesfortheusageoftheSecretKeySpecclass,e.g.bysimplyrecursivelygreppingonthemorusingjadx searchfunction: grep -r\"SecretKeySpec\" ThiswillreturnallclassesusingtheSecretKeySpecclass. Nowexaminethosefilesandtracewhichvariablesareusedto passthekeymaterial. Thefigurebelowshowstheresultofperformingthisassessmentonaproductionreadyapplication. WecanclearlylocatetheuseofastaticencryptionkeythatishardcodedandinitializedinthestaticbytearrayEncrypt. keyBytes. Dynamic Analysis Youcanusemethodtracingoncryptographicmethodstodetermineinput/outputvaluessuchasthekeysthatarebeing used. Monitor file system access while cryptographic operations are being performed to assess where key material is writtentoorreadfrom. Forexample,monitorthefilesystembyusingtheAPImonitorofRMS-RuntimeMobileSecurity. Testing the Configuration of Cryptographic Standard Algorithms Platform: android MASVSV1: MSTG-CRYPTO-2,MSTG-CRYPTO-3,MSTG-CRYPTO-4 MASVSV2: MASVS-CRYPTO-1 Overview Static Analysis Identifyalltheinstancesofthecryptographicprimitivesincode. Identifyallcustomcryptographyimplementations. You canlookfor: • classesCipher,Mac,MessageDigest,Signature 224\\n• interfacesKey,PrivateKey,PublicKey,SecretKey • functionsgetInstance,generateKey • exceptionsKeyStoreException,CertificateException,NoSuchAlgorithmException • classeswhichusesjava.security.*,javax.crypto.*,android.security.*andandroid.security.keystore. *packages. IdentifythatallcallstogetInstanceusedefaultproviderofsecurityservicesbynotspecifyingit(itmeansAndroidOpenSSL akaConscrypt). ProvidercanonlybespecifiedinKeyStorerelatedcode(inthatsituationKeyStoreshouldbeprovided asprovider). Ifotherproviderisspecifieditshouldbeverifiedaccordingtosituationandbusinesscase(i.e.Android APIversion),andprovidershouldbeexaminedagainstpotentialvulnerabilities. Ensurethatthebestpracticesoutlinedinthe“CryptographyforMobileApps”chapterarefollowed. Lookatinsecureand deprecatedalgorithmsandcommonconfigurationissues. Dynamic Analysis Youcanusemethodtracingoncryptographicmethodstodetermineinput/outputvaluessuchasthekeysthatarebeing used. Monitor file system access while cryptographic operations are being performed to assess where key material is writtentoorreadfrom. Forexample,monitorthefilesystembyusingtheAPImonitorofRMS-RuntimeMobileSecurity. Testing Random Number Generation Platform: android MASVSV1: MSTG-CRYPTO-6 MASVSV2: MASVS-CRYPTO-1 Overview Static Analysis Identifyalltheinstancesofrandomnumbergeneratorsandlookforeithercustomorwell-knowninsecureclasses. For instance, java.util.Randomproducesanidenticalsequenceofnumbersforeachgivenseedvalue; consequently, the sequenceofnumbersispredictable. Insteadawell-vettedalgorithmshouldbechosenthatiscurrentlyconsideredtobe strongbyexpertsinthefield,andawell-testedimplementationswithadequatelengthseedsshouldbeused. IdentifyallinstancesofSecureRandomthatarenotcreatedusingthedefaultconstructor. Specifyingtheseedvaluemay reducerandomness. Prefertheno-argumentconstructorofSecureRandomthatusesthesystem-specifiedseedvalueto generatea128-byte-longrandomnumber. Ingeneral,ifaPRNGisnotadvertisedasbeingcryptographicallysecure(e.g.java.util.Random),thenitisprobablya statisticalPRNGandshouldnotbeusedinsecurity-sensitivecontexts. Pseudo-randomnumbergeneratorscanproduce predictablenumbersifthegeneratorisknownandtheseedcanbeguessed. A128-bitseedisagoodstartingpointfor producinga“randomenough”number. Onceanattackerknowswhattypeofweakpseudo-randomnumbergenerator(PRNG)isused,itcanbetrivialtowritea proof-of-concepttogeneratethenextrandomvaluebasedonpreviouslyobservedones,asitwasdoneforJavaRandom. In case of very weak custom random generators it may be possible to observe the pattern statistically. Although the recommendedapproachwouldanywaybetodecompiletheAPKandinspectthealgorithm(seeStaticAnalysis). Ifyouwanttotestforrandomness,youcantrytocapturealargesetofnumbersandcheckwiththeBurp’ssequencerto seehowgoodthequalityoftherandomnessis. Dynamic Analysis Youcanusemethodtracingonthementionedclassesandmethodstodetermineinput/outputvaluesbeingused. 225\\nTesting the Purposes of Keys Platform: android MASVSV1: MSTG-CRYPTO-5 MASVSV2: MASVS-CRYPTO-2 Overview Static Analysis Identifyallinstanceswherecryptographyisused. Youcanlookfor: • classesCipher,Mac,MessageDigest,Signature • interfacesKey,PrivateKey,PublicKey,SecretKey • functionsgetInstance,generateKey • exceptionsKeyStoreException,CertificateException,NoSuchAlgorithmException • classesimportingjava.security.*,javax.crypto.*,android.security.*,android.security.keystore.* Foreachidentifiedinstance,identifyitspurposeanditstype. Itcanbeused: • forencryption/decryption-toensuredataconfidentiality • forsigning/verifying-toensureintegrityofdata(aswellasaccountabilityinsomecases) • formaintenance-toprotectkeysduringcertainsensitiveoperations(suchasbeingimportedtotheKeyStore) Additionally,youshouldidentifythebusinesslogicwhichusesidentifiedinstancesofcryptography. Duringverificationthefollowingchecksshouldbeperformed: • areallkeysusedaccordingtothepurposedefinedduringitscreation? (itisrelevanttoKeyStorekeys,whichcan haveKeyPropertiesdefined) • forasymmetrickeys,istheprivatekeybeingexclusivelyusedforsigningandthepublickeyencryption? • aresymmetrickeysusedformultiplepurposes? Anewsymmetrickeyshouldbegeneratedifit’susedinadifferent context. • iscryptographyusedaccordingtoitsbusinesspurpose? Dynamic Analysis Youcanusemethodtracingoncryptographicmethodstodetermineinput/outputvaluessuchasthekeysthatarebeing used. Monitor file system access while cryptographic operations are being performed to assess where key material is writtentoorreadfrom. Forexample,monitorthefilesystembyusingtheAPImonitorofRMS-RuntimeMobileSecurity. 226\\nAndroid Local Authentication Overview During local authentication, an app authenticates the user against credentials stored locally on the device. In other words, the user “unlocks” the app or some inner", "metadata": {"doc_id": "OWASP_MASTG", "chunk_id": 90}}