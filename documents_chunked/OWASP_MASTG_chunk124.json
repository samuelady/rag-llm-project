{"text": "prototype and test debug builds of your applications during the development process,butactuallyitisnotanemulator. Differencebetweenasimulatorandanemulatorispreviouslydiscussedin “Emulation-basedDynamicAnalysis”section. Whiledevelopinganddebugginganapplication,theXcodetoolchaingeneratesx86code,whichcanbeexecutedinthe iOS simulator. However, for a release build, only ARM code is generated (incompatible with the iOS simulator). That’s why applications downloaded from the Apple App Store cannot be used for any kind of application analysis on the iOS simulator. 341\\nCorellium CorelliumisacommercialtoolwhichoffersvirtualiOSdevicesrunningactualiOSfirmware,beingtheonlypubliclyavail- able iOS emulator ever. Since it is a proprietary product, not much information is available about the implementation. Corelliumhasnocommunitylicensesavailable,thereforewewon’tgointomuchdetailregardingitsuse. Corellium allows you to launch multiple instances of a device (jailbroken or not) which are accessible as local devices (withasimpleVPNconfiguration). Ithastheabilitytotakeandrestoresnapshotsofthedevicestate,andalsooffersa convenientweb-basedshelltothedevice. Finallyandmostimportantly,duetoits“emulator”nature,youcanexecute applicationsdownloadedfromtheAppleAppStore,enablinganykindofapplicationanalysisasyouknowitfromrealiOS (jailbroken)devices. NotethatinordertoinstallanIPAonCorelliumdevicesithastobeunencryptedandsignedwithavalidAppledeveloper certificate. Seemoreinformationhere. Unicorn Unicornisalightweight,multi-architectureCPUemulatorframeworkbasedonQEMUandgoesbeyonditbyaddinguseful features especially made for CPU emulation. Unicorn provides the basic infrastructure needed to execute processor instructions. InthissectionwewilluseUnicorn’sPythonbindingstosolvetheUnCrackableAppforiOSLevel1challenge. TouseUnicorn’sfullpower,wewouldneedtoimplementallthenecessaryinfrastructurewhichgenerallyisreadilyavail- ablefromtheoperatingsystem,e.g.binaryloader,linkerandotherdependenciesoruseanotherhigherlevelframeworks such as Qiling which leverages Unicorn to emulate CPU instructions, but understands the OS context. However, this is superfluousforthisverylocalizedchallengewhereonlyexecutingasmallpartofthebinarywillsuffice. Whileperformingmanualanalysisin“ReviewingDisassembledNativeCode”section,wedeterminedthatthefunctionat address0x1000080d4isresponsiblefordynamicallygeneratingthesecretstring. Aswe’reabouttosee,allthenecessary codeisprettymuchself-containedinthebinary,makingthisaperfectscenariotouseaCPUemulatorlikeUnicorn. 342\\nIfweanalyzethatfunctionandthesubsequentfunctioncalls,wewillobservethatthereisnoharddependencyonany externallibraryandneitherit’sperforminganysystemcalls. Theonlyaccessexternaltothefunctionsoccursforinstance ataddress0x1000080f4,whereavalueisbeingstoredtoaddress0x10000dbf0,whichmapstothe__datasection. Therefore, in order to correctly emulate this section of the code, apart from the __text section (which contains the instructions)wealsoneedtoloadthe__datasection. TosolvethechallengeusingUnicornwewillperformthefollowingsteps: • Get the ARM64 version of the binary by running lipo -thin arm64 <app_binary> -output uncrackable.arm64 (ARMv7canbeusedaswell). • Extractthe__textand__datasectionfromthebinary. • Createandmapthememorytobeusedasstackmemory. • Creatememoryandloadthe__textand__datasection. • Executethebinarybyprovidingthestartandendaddress. • Finally,dumpthereturnvaluefromthefunction,whichinthiscaseisoursecretstring. To extract the content of __text and __data section from the Mach-O binary we will useLIEF, which provides a conve- nientabstractiontomanipulatemultipleexecutablefileformats. Beforeloadingthesesectionstomemory,weneedto determinetheirbaseaddresses,e.g.byusingGhidra,Radare2orIDAPro. 343\\nFromtheabovetable,wewillusethebaseaddress0x10000432cfor__textand0x10000d3e8for__datasectiontoload thematinthememory. WhileallocatingmemoryforUnicorn,thememoryaddressesshouldbe4kpagealignedandalsotheallocatedsize shouldbeamultipleof1024. Thefollowingscriptemulatesthefunctionat0x1000080d4anddumpsthesecretstring: importlief fromunicornimport * fromunicorn.arm64_constimport * ##---Extract__textand__datasectioncontentfromthebinary--- binary =lief.parse(\"uncrackable.arm64\") text_section =binary.get_section(\"__text\") text_content =text_section.content data_section =binary.get_section(\"__data\") data_content =data_section.content ##---SetupUnicornforARM64execution--- arch =\"arm64le\" emu=Uc(UC_ARCH_ARM64,UC_MODE_ARM) ##---CreateStackmemory--- addr =0x40000000 size =1024*1024 emu.mem_map(addr,size) emu.reg_write(UC_ARM64_REG_SP,addr +size -1) ##---Loadtextsection-- base_addr =0x100000000 tmp_len =1024*1024 text_section_load_addr =0x10000432c emu.mem_map(base_addr,tmp_len) emu.mem_write(text_section_load_addr,bytes(text_content)) ##---Loaddatasection--- data_section_load_addr =0x10000d3e8 emu.mem_write(data_section_load_addr,bytes(data_content)) ##---Hackforstack_chk_guard--- ##withoutthiswillthrowinvalidmemoryreadat0x0 emu.mem_map(0x0,1024) emu.mem_write(0x0,b\"00\") ##---Executefrom0x1000080d4to0x100008154--- 344\\nemu.emu_start(0x1000080d4,0x100008154) ret_value =emu.reg_read(UC_ARM64_REG_X0) ##---Dumpreturnvalue--- print(emu.mem_read(ret_value, 11)) Youmaynoticethatthereisanadditionalmemoryallocationataddress0x0,thisisasimplehackaroundstack_- chk_guardcheck. Withoutthis,therewillbeainvalidmemoryreaderrorandbinarycannotbeexecuted. Withthis hack,theprogramwillaccessthevalueat0x0anduseitforthestack_chk_guardcheck. Tosummarize,usingUnicorndorequiresomeadditionalsetupbeforeexecutingthebinary,butoncedone,thistoolcan help to provide deep insights into the binary. It provides the flexibility to execute the full binary or a limited part of it. UnicornalsoexposesAPIstoattachhookstotheexecution. Usingthesehooksyoucanobservethestateoftheprogram atanypointduringtheexecutionorevenmanipulatetheregisterorvariablevaluesandforcefullyexploreotherexecution branchesinaprogram. AnotheradvantagewhenrunningabinaryinUnicornisthatyoudon’tneedtoworryaboutvarious checkslikeroot/jailbreakdetectionordebuggerdetectionetc. Monitoring System Logs Platform: ios Manyappsloginformative(andpotentiallysensitive)messagestotheconsolelog. Thelogalsocontainscrashreports andotherusefulinformation. YoucancollectconsolelogsthroughtheXcodeDeviceswindowasfollows: 1. LaunchXcode. 2. Connectyourdevicetoyourhostcomputer. 3. ChooseWindow->DevicesandSimulators. 4. ClickonyourconnectediOSdeviceintheleftsectionoftheDeviceswindow. 5. Reproducetheproblem. 6. ClickontheOpenConsolebuttonlocatedintheupperright-handareaoftheDeviceswindowtoviewtheconsole logsonaseparatewindow. Tosavetheconsoleoutputtoatextfile,gotothetoprightsideoftheConsolewindowandclickontheSavebutton. 345\\nYoucanalsoconnecttothedeviceshellasexplainedinAccessingtheDeviceShell,installsocatviaapt-getandrunthe followingcommand: iPhone:~root#socat -UNIX-CONNECT:/var/run/lockdown/syslog.sock ======================== ASLisheretoserveyou >watch OK Jun 713:42:14iPhonechmod[9705]<Notice>:MS:Notice:Injecting: (null)[chmod] (1556.00) Jun 713:42:14iPhonereadlink[9706]<Notice>:MS:Notice:Injecting: (null) [readlink] (1556.00) Jun 713:42:14iPhonerm[9707]<Notice>:MS:Notice:Injecting: (null)[rm] (1556.00) Jun 713:42:14iPhonetouch[9708]<Notice>:MS:Notice:Injecting: (null)[touch] (1556.00) ... Repackaging Apps Platform: ios Ifyouneedtotestonanon-jailbrokendeviceyoushouldlearnhowtorepackageanapptoenabledynamictestingon it. UseacomputerwithmacOStoperformallthestepsindicatedinthearticle“PatchingiOSApplications”fromtheobjection Wiki. Onceyou’redoneyou’llbeabletopatchanIPAbycallingtheobjectioncommand: objectionpatchipa --source my-app.ipa --codesign-signature 0C2E8200Dxxxx Finally, the app needs to be installed (sideloaded) and run with debugging communication enabled. Perform the steps fromthearticle“RunningPatchediOSApplications”fromtheobjectionWiki(usingios-deploy). ios-deploy --bundle Payload/my-app.app -W-d Referto“InstallingApps”tolearnaboutotherinstallationmethods. Someofthemdoesn’trequireyoutohaveamacOS. Thisrepackagingmethodisenoughformostusecases. Formoreadvancedrepackaging,referto“iOSTampering andReverseEngineering-Patching,RepackagingandRe-Signing”. 346\\nLibrary Injection Platform: ios IfyouwanttouseFridaonnon-jailbrokendevicesyou’llneedtoincludeFridaGadget.dylib. Downloaditfirst: curl -Ohttps://build.frida.re/frida/ios/lib/FridaGadget.dylib Copy FridaGadget.dylib into the app directory and use optool to add a load command to the “UnCrackable Level 1” binary. $unzipUnCrackable-Level1.ipa $cpFridaGadget.dylibPayload/UnCrackable\\Level\\1.app/ $optoolinstall -cload -p\"@executable_path/FridaGadget.dylib\" -tPayload/UnCrackable\\Level\\1.app/UnCrackable\\Level\\1 FoundFATHeader Foundthinheader... Foundthinheader... InsertingaLC_LOAD_DYLIBcommandforarchitecture:arm SuccessfullyinsertedaLC_LOAD_DYLIBcommandforarm InsertingaLC_LOAD_DYLIBcommandforarchitecture:arm64 SuccessfullyinsertedaLC_LOAD_DYLIBcommandforarm64 WritingexecutabletoPayload/UnCrackableLevel1.app/UnCrackableLevel1... Patching Example: Making an App Debuggable Bydefault,anappavailableontheAppleAppStoreisnotdebuggable. InordertodebuganiOSapplication,itmusthave theget-task-allowentitlementenabled. Thisentitlementallowsotherprocesses(likeadebugger)toattachtotheapp. Xcodeisnotaddingtheget-task-allowentitlementinadistributionprovisioningprofile;itisonlywhitelistedandadded inadevelopmentprovisioningprofile. Thus,todebuganiOSapplicationobtainedfromtheAppStore,itneedstobere-signedwithadevelopmentprovisioning profilewiththeget-task-allowentitlement. Howtore-signanapplicationisdiscussedinthenextsection. Process Exploration Platform: ios Whentestinganapp,processexplorationcanprovidethetesterwithdeepinsightsintotheappprocessmemory. Itcan beachievedviaruntimeinstrumentationandallowstoperformtaskssuchas: • Retrievingthememorymapandloadedlibraries. • Searchingforoccurrencesofcertaindata. • Afterdoingasearch,obtainingthelocationofacertainoffsetinthememorymap. • Performingamemorydumpandinspectorreverseengineerthebinarydataoffline. • ReverseengineeringabinaryorFrameworkwhileit’srunning. As you can see, these tasks are rather supportive and/or passive, they’ll help us collect data and information that will supportothertechniques.", "metadata": {"doc_id": "OWASP_MASTG", "chunk_id": 124}}