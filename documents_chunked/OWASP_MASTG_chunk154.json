{"text": "you may use the Notes app and long press the links you’ve written in ordertotestcustomURLschemes. Remembertoexittheeditingmodeinordertobeabletoopenthem. Notethatyou canclickorlongpresslinksincludingcustomURLschemesonlyiftheappisinstalled,ifnottheywon’tbehighlightedas clickablelinks. Using Frida IfyousimplywanttoopentheURLschemeyoucandoitusingFrida: $frida -UiGoat-Swift [iPhone::iGoat-Swift]->function openURL(url){ varUIApplication =ObjC.classes.UIApplication.sharedApplication(); vartoOpen =ObjC.classes.NSURL.URLWithString_(url); return UIApplication.openURL_(toOpen); } [iPhone::iGoat-Swift]->openURL(\"tel://234234234\") true InthisexamplefromFridaCodeSharetheauthorusesthenon-publicAPILSApplicationWorkspace.openSensitiveURL:withOptions: toopentheURLs(fromtheSpringBoardapp): function openURL(url){ varw=ObjC.classes.LSApplicationWorkspace.defaultWorkspace(); vartoOpen =ObjC.classes.NSURL.URLWithString_(url); return w.openSensitiveURL_withOptions_(toOpen,null); } Notethattheuseofnon-publicAPIsisnotpermittedontheAppStore,that’swhywedon’teventestthesebutwe areallowedtousethemforourdynamicanalysis. Identifying and Hooking the URL Handler Method Ifyoucan’tlookintotheoriginalsourcecodeyouwillhavetofindoutyourselfwhichmethoddoestheappusetohandle theURLschemerequeststhatitreceives. YoucannotknowifitisanObjective-CmethodoraSwiftone,orevenifthe appisusingadeprecatedone. Crafting the Link Yourself and Letting Safari Open It ForthiswewillusetheObjCmethodobserverfromFridaCodeShare,whichisanextremelyhandyscriptthatallowsyou toquicklyobserveanycollectionofmethodsorclassesjustbyprovidingasimplepattern. Inthiscaseweareinterestedintoallmethodscontaining“openURL”,thereforeourpatternwillbe*[* *openURL*]: • Thefirstasteriskwillmatchallinstance-andclass+methods. • ThesecondmatchesallObjective-Cclasses. • ThethirdandforthallowtomatchanymethodcontainingthestringopenURL. $frida -UiGoat-Swift --codesharemrmacete/objc-method-observer [iPhone::iGoat-Swift]->observeSomething(\"*[**openURL*]\"); Observing -[_UIDICActivityItemProvideractivityViewController:openURLAnnotationForActivityType:] Observing -[CNQuickActionsManager_openURL:] Observing -[SUClientControlleropenURL:] Observing -[SUClientControlleropenURL:inClientWithIdentifier:] Observing -[FBSSystemServiceopenURL:application:options:clientPort:withResult:] Observing -[iGoat_Swift.AppDelegate application:openURL:options:] Observing -[PrefsUILinkLabelopenURL:] Observing -[UIApplicationopenURL:] Observing -[UIApplication_openURL:] Observing -[UIApplicationopenURL:options:completionHandler:] Observing -[UIApplicationopenURL:withCompletionHandler:] Observing -[UIApplication_openURL:originatingView:completionHandler:] Observing -[SUApplicationapplication:openURL:sourceApplication:annotation:] ... 460\\nThelistisverylongandincludesthemethodswehavealreadymentioned. IfwetriggernowoneURLscheme,forexample “igoat://”fromSafariandaccepttoopenitintheappwewillseethefollowing: [iPhone::iGoat-Swift]->(0x1c4038280) -[iGoat_Swift.AppDelegate application:openURL:options:] application:<UIApplication:0x101d0fad0> openURL:igoat:// options:{ UIApplicationOpenURLOptionsOpenInPlaceKey =0; UIApplicationOpenURLOptionsSourceApplicationKey =\"com.apple.mobilesafari\"; } 0x18b5030d8 UIKit!__58-[UIApplication_applicationOpenURLAction:payload:origin:]_block_invoke 0x18b502a94 UIKit!-[UIApplication_applicationOpenURLAction:payload:origin:] ... 0x1817e1048 libdispatch.dylib!_dispatch_client_callout 0x1817e86c8 libdispatch.dylib!_dispatch_block_invoke_direct$VARIANT$mp 0x18453d9f4 FrontBoardServices!__FBSSERIALQUEUE_IS_CALLING_OUT_TO_A_BLOCK__ 0x18453d698 FrontBoardServices!-[FBSSerialQueue_performNext] RET:0x1 Nowweknowthat: • Themethod-[iGoat_Swift.AppDelegateapplication:openURL:options:] getscalled. Aswehaveseenbefore, itistherecommendedwayanditisnotdeprecated. • ItreceivesourURLasaparameter: igoat://. • Wealsocanverifythesourceapplication: com.apple.mobilesafari. • We can also know from where it was called, as expected from -[UIApplication _applicationOpenURLAc- tion:payload:origin:]. • Themethodreturns0x1whichmeansYES(thedelegatesuccessfullyhandledtherequest). ThecallwassuccessfulandweseenowthattheiGoatappwasopen: 461\\nNotice that we can also see that the caller (source application) was Safari if we look in the upper-left corner of the screenshot. Dynamically Opening the Link from the App Itself It is also interesting to see which other methods get called on the way. To change the result a little bit we will call the sameURLschemefromtheiGoatappitself. WewilluseagainObjCmethodobserverandtheFridaREPL: $frida -UiGoat-Swift --codesharemrmacete/objc-method-observer [iPhone::iGoat-Swift]->function openURL(url){ varUIApplication =ObjC.classes.UIApplication.sharedApplication(); 462\\nvartoOpen =ObjC.classes.NSURL.URLWithString_(url); return UIApplication.openURL_(toOpen); } [iPhone::iGoat-Swift]->observeSomething(\"*[**openURL*]\"); [iPhone::iGoat-Swift]->openURL(\"iGoat://?contactNumber=123456789&message=hola\") (0x1c409e460) -[__NSXPCInterfaceProxy__LSDOpenProtocolopenURL:options:completionHandler:] openURL:iGoat://?contactNumber=123456789&message=hola options:nil completionHandler:<__NSStackBlock__:0x16fc89c38> 0x183befbec MobileCoreServices!-[LSApplicationWorkspaceopenURL:withOptions:error:] 0x10ba6400c ... RET:nil ... (0x101d0fad0) -[UIApplicationopenURL:] openURL:iGoat://?contactNumber=123456789&message=hola 0x10a610044 ... RET:0x1 true (0x1c4038280) -[iGoat_Swift.AppDelegate application:openURL:options:] application:<UIApplication:0x101d0fad0> openURL:iGoat://?contactNumber=123456789&message=hola options:{ UIApplicationOpenURLOptionsOpenInPlaceKey =0; UIApplicationOpenURLOptionsSourceApplicationKey =\"OWASP.iGoat-Swift\"; } 0x18b5030d8 UIKit!__58-[UIApplication_applicationOpenURLAction:payload:origin:]_block_invoke 0x18b502a94 UIKit!-[UIApplication_applicationOpenURLAction:payload:origin:] ... RET:0x1 The output is truncated for better readability. This time you see that UIApplicationOpenURLOptionsSourceApplica- tionKeyhaschangedtoOWASP.iGoat-Swift,whichmakessense. Inaddition,alonglistofopenURL-likemethodswere called. Considering this information can be very useful for some scenarios as it will help you to decide what you next stepswillbe,e.g.whichmethodyouwillhookortamperwithnext. Opening a Link by Navigating to a Page and Letting Safari Open It You can now test the same situation when clicking on a link contained on a page. Safari will identify and process the URL scheme and choose which action to execute. Opening this link “https://telegram.me/fridadotre” will trigger this behavior. 463\\nFirstofallweletfrida-tracegeneratethestubsforus: $frida-trace -UTelegram -m\"*[**restorationHandler*]\" -i\"*open*Url*\" -m\"*[**application*URL*]\" -m\"*[*openURL]\" ... 7310ms -[UIApplication _applicationOpenURLAction:0x1c44ff900payload:0x10c5ee4c0origin:0x0] 7311ms |-[AppDelegateapplication:0x105a59980openURL:0x1c46ebb80options:0x1c0e222c0] 7312ms |$S10TelegramUI15openExternalUrl7account7context3url05forceD016presentationData 18applicationContext20navigationController12dismissInputy0A4Core7AccountC_AA14Open URLContextOSSSbAA012PresentationK0CAA0a11ApplicationM0C7Display010NavigationO0CSgyyctF() Nowwecansimplymodifybyhandthestubsweareinterestedin: • TheObjective-Cmethodapplication:openURL:options:: //__handlers__/__AppDelegate_application_openUR_3679fadc.js onEnter:function (log,args,state){ log(\"-[AppDelegateapplication: \" +args[2]+ \"openURL: \" +args[3]+\"options:\" +args[4]+\"]\"); log(\"\\tapplication:\" +ObjC.Object(args[2]).toString()); 464\\nlog(\"\\topenURL:\" +ObjC.Object(args[3]).toString()); log(\"\\toptions:\" +ObjC.Object(args[4]).toString()); }, • TheSwiftmethod$S10TelegramUI15openExternalUrl...: //__handlers__/TelegramUI/_S10TelegramUI15openExternalUrl7_b1a3234e.js onEnter:function (log,args,state){ log(\"TelegramUI.openExternalUrl(account,url, presentationData,\" + \"applicationContext,navigationController, dismissInput)\"); log(\"\\taccount:\" +ObjC.Object(args[1]).toString()); log(\"\\turl:\" +ObjC.Object(args[2]).toString()); log(\"\\tpresentationData:\" +args[3]); log(\"\\tapplicationContext:\" +ObjC.Object(args[4]).toString()); log(\"\\tnavigationController:\" +ObjC.Object(args[5]).toString()); }, Thenexttimewerunit,weseethefollowingoutput: $frida-trace -UTelegram -m\"*[**restorationHandler*]\" -i\"*open*Url*\" -m\"*[**application*URL*]\" -m\"*[*openURL]\" 8144 ms -[UIApplication_applicationOpenURLAction:0x1c44ff900 payload:0x10c5ee4c0 origin:0x0] 8145 ms |-[AppDelegateapplication:0x105a59980 openURL:0x1c46ebb80 options:0x1c0e222c0] 8145 ms | application:<Application:0x105a59980> 8145 ms | openURL:tg://resolve?domain=fridadotre 8145 ms | options :{ UIApplicationOpenURLOptionsOpenInPlaceKey =0; UIApplicationOpenURLOptionsSourceApplicationKey =\"com.apple.mobilesafari\"; } 8269 ms | |TelegramUI.openExternalUrl(account,url,presentationData, applicationContext,navigationController,dismissInput) 8269 ms | | account:nil 8269 ms | | url:tg://resolve?domain=fridadotre 8269 ms | | presentationData:0x1c4c51741 8269 ms | | applicationContext:nil 8269 ms | | navigationController:TelegramUI.PresentationData 8274 ms |-[UIApplicationapplicationOpenURL:0x1c46ebb80] Thereyoucanobservethefollowing: • Itcallsapplication:openURL:options: fromtheappdelegateasexpected. • ThesourceapplicationisSafari(“com.apple.mobilesafari”). • application:openURL:options: handlestheURLbutdoesnotopenit,itcallsTelegramUI.openExternalUrlfor that. •", "metadata": {"doc_id": "OWASP_MASTG", "chunk_id": 154}}