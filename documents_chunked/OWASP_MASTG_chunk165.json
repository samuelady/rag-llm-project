{"text": "-hmac.length))]; NSMutableData*digestBuffer =[NSMutableDatadataWithLength:CC_SHA256_DIGEST_LENGTH]; CCHmac(kCCHmacAlgSHA256,[actualDatabytes],(CC_LONG)[keylength],[actualDatabytes],(CC_LONG)[actualDatalength],[digestBuffermutableBytes]); return [hmacisEqual:digestBuffer]; 1. ExtractsthemessageandthehmacbytesasseparateNSData. 2. Repeatssteps1-3oftheprocedureforgeneratinganHMAContheNSData. 3. ComparestheextractedHMACbytestotheresultofstep1. Note: iftheappalsoencryptsfiles,makesurethatitencryptsandthencalculatestheHMACasdescribedinAuthenticated Encryption. Bypass: 1. Retrievethedatafromthedevice,asdescribedinthe“DeviceBinding”section. 2. Altertheretrieveddataandreturnittostorage. Reverse Engineering Tools Detection Thepresenceoftools, frameworksandappscommonlyusedbyreverseengineersmayindicateanattempttoreverse engineer the app. Some of these tools can only run on a jailbroken device, while others force the app into debugging modeordependonstartingabackgroundserviceonthemobilephone. Therefore,therearedifferentwaysthatanapp mayimplementtodetectareverseengineeringattackandreacttoit,e.g.byterminatingitself. Youcandetectpopularreverseengineeringtoolsthathavebeeninstalledinanunmodifiedformbylookingforassociated applicationpackages,files,processes,orothertool-specificmodificationsandartifacts. Inthefollowingexamples,we’ll discussdifferentwaystodetecttheFridainstrumentationframework,whichisusedextensivelyinthisguideandalsoin therealworld. Othertools,suchasCydiaSubstrateorCycript,canbedetectedsimilarly. Notethatinjection,hookingand DBI(DynamicBinaryInstrumentation)toolscanoftenbedetectedimplicitly,throughruntimeintegritychecks,whichare discussedbelow. 512\\nBypass: Thefollowingstepsshouldguideyouwhenbypassingdetectionofreverseengineeringtools: 1. Patch the anti reverse engineering functionality. Disable the unwanted behavior by patching the binary through usageofradare2/iaitoorGhidra. 2. UseFridaorCydiaSubstratetohookfilesystemAPIsontheObjective-C/Swiftornativelayers. Returnahandleto theoriginalfile,notthemodifiedfile. Refertothechapter“TamperingandReverseEngineeringoniOS”forexamplesofpatchingandcodeinjection. Frida Detection Fridarunsunderthenameoffrida-serverinitsdefaultconfiguration(injectedmode)onajailbrokendevice. Whenyou explicitlyattachtoatargetapp(e.g.viafrida-traceortheFridaCLI),Fridainjectsafrida-agentintothememoryofthe app. Therefore, you may expect to find it there after attaching to the app (and not before). On Android, verifying this isprettystraightforwardasyoucansimplygrepforthestring“frida”inthememorymapsoftheprocessIDintheproc directory(/proc/<pid>/maps). However,oniOStheprocdirectoryisnotavailable,butyoucanlisttheloadeddynamic librariesinanappwiththefunction_dyld_image_count. Fridamayalsorunintheso-calledembeddedmode,whichalsoworksfornon-jailbrokendevices. Itconsistsofembedding afrida-gadgetintotheIPAandforcingtheapptoloaditasoneofitsnativelibraries. The application’s static content, including its ARM-compiled binary and its external libraries, is stored inside the <Application>.app directory. If you inspect the content of the /var/containers/Bundle/Application/<UUID>/ <Application>.appdirectory,you’llfindtheembeddedfrida-gadgetasFridaGadget.dylib. iPhone:/var/containers/Bundle/Application/AC5DC1FD-3420-42F3-8CB5-E9D77C4B287A/SwiftSecurity.app/Frameworksroot#ls -alh total87M drwxr-xr-x10_installd_installd 320Nov1906:08./ drwxr-xr-x11_installd_installd 352Nov1906:08../ -rw-r--r-- 1_installd_installd 70MNov1606:37FridaGadget.dylib -rw-r--r-- 1_installd_installd3.8MNov1606:37libswiftCore.dylib -rw-r--r-- 1_installd_installd 71KNov1606:37libswiftCoreFoundation.dylib -rw-r--r-- 1_installd_installd136KNov1606:38libswiftCoreGraphics.dylib -rw-r--r-- 1_installd_installd 99KNov1606:37libswiftDarwin.dylib -rw-r--r-- 1_installd_installd189KNov1606:37libswiftDispatch.dylib -rw-r--r-- 1_installd_installd1.9MNov1606:38libswiftFoundation.dylib -rw-r--r-- 1_installd_installd 76KNov1606:37libswiftObjectiveC.dylib LookingatthesetracesthatFridaleavesbehind,youmightalreadyimaginethatdetectingFridawouldbeatrivialtask. Andwhileitistrivialtodetecttheselibraries,itisequallytrivialtobypasssuchadetection. Detectionoftoolsisacat andmousegameandthingscangetmuchmorecomplicated. Thefollowingtableshortlypresentsasetofsometypical Fridadetectionmethodsandashortdiscussionontheireffectiveness. SomeofthefollowingdetectionmethodsareimplementedintheiOSSecuritySuite. 513\\nMethod Description Discussion CheckTheEnvironmentFor Artifactscanbepackagedfiles, Inspectingrunningservicesisnot RelatedArtifacts binaries,libraries,processes,and possibleforaniOSappona temporaryfiles. ForFrida,thiscould non-jailbrokendevice. TheSwift bethefrida-serverrunninginthe methodCommandLineisnot target(jailbroken)system(the availableoniOStoqueryfor daemonresponsibleforexposing informationaboutrunningprocesses, FridaoverTCP)orthefridalibraries butthereareunofficialways,suchas loadedbytheapp. byusingNSTask. Neverthelesswhen usingthismethod,theappwillbe rejectedduringtheAppStorereview process. ThereisnootherpublicAPI availabletoqueryforrunning processesorexecutesystem commandswithinaniOSApp. Evenif itwouldbepossible,bypassingthis wouldbeaseasyasjustrenamingthe correspondingFridaartifact (frida-server/frida-gadget/frida-agent). AnotherwaytodetectFrida,wouldbe towalkthroughthelistofloaded librariesandcheckforsuspicious ones(e.g.thoseincluding“frida”in theirnames),whichcanbedoneby using_dyld_get_image_name. CheckingForOpenTCPPorts Thefrida-serverprocessbindstoTCP Thismethoddetectsfrida-serverinits port27042bydefault. Testing defaultmode,butthelisteningport whetherthisportisopenisanother canbechangedviaacommandline methodofdetectingthedaemon. argument,sobypassingthisisvery trivial. CheckingForPortsResponding frida-serverusestheD-Bus Thisisafairlyrobustmethodof ToD-BusAuth protocoltocommunicate,soyoucan detectingfrida-server,butFrida expectittorespondtoD-BusAUTH. offersalternativemodesofoperation SendaD-BusAUTHmessagetoevery thatdon’trequirefrida-server. openportandcheckforananswer, hopingthatfrida-serverwillreveal itself. Pleaserememberthatthistableisfarfromexhaustive. Forexample,twootherpossibledetectionmechanismsare: • namedpipes(usedbyfrida-serverforexternalcommunication),or • detectingtrampolines(see“PreventbypassingofSSLcertificatepinninginiOSapplications”forfurtherexplanation andsamplecodefordetectionoftrampolinesinaniOSapp) Both would help to detect Substrate or Frida’s Interceptor but, for example, won’t be effective against Frida’s Stalker. Rememberthatthesuccessofeachofthesedetectionmethodswilldependonwhetheryou’reusingajailbrokendevice, thespecificversionofthejailbreakandmethodand/ortheversionofthetoolitself. Attheend,thisispartofthecatand mousegameofprotectingdatabeingprocessedonanuncontrolledenvironment(theenduser’sdevice). Emulator Detection The goal of emulator detection is to increase the difficulty of running the app on an emulated device. This forces the reverse engineer to defeat the emulator checks or utilize the physical device, thereby barring the access required for large-scaledeviceanalysis. 514\\nAsdiscussedinthesectionTestingontheiOSSimulatorinthebasicsecuritytestingchapter,theonlyavailablesimulator istheonethatshipswithXcode. Simulatorbinariesarecompiledtox86codeinsteadofARMcodeandappscompiled forarealdevice(ARMarchitecture)don’truninthesimulator,hencesimulationprotectionwasnotsomuchaconcern regardingiOSappsincontrasttoAndroidwithawiderangeofemulationchoicesavailable. However, since its release, Corellium (commercial tool) has enabled real emulation, setting itself apart from the iOS simulator. Inadditiontothat,beingaSaaSsolution,Corelliumenableslarge-scaledeviceanalysiswiththelimitingfactor justbeingavailablefunds. WithAppleSilicon(ARM)hardwarewidelyavailable,traditionalchecksforthepresenceofx86/x64architecturemight notsuffice. Onepotentialdetectionstrategyistoidentifyfeaturesandlimitationsavailableforcommonlyusedemulation solutions. For instance, Corellium doesn’t support iCloud, cellular services, camera, NFC, Bluetooth, App Store access or GPU hardware emulation (Metal). Therefore, smartly combining checks involving any of these features could be an indicatorforthepresenceofanemulatedenvironment. Pairingtheseresultswiththeonesfrom3rdpartyframeworkssuchasiOSSecuritySuite,Trusteerorano-codesolution suchasAppdome(commercialsolution)willprovideagoodlineofdefenseagainstattacksutilizingemulators. Obfuscation Thechapter“MobileAppTamperingandReverseEngineering”introducesseveralwell-knownobfuscationtechniquesthat canbeusedinmobileappsingeneral. Name Obfuscation Thestandardcompilergeneratesbinarysymbolsbasedonclassandfunctionnamesfromthesourcecode. Therefore,if noobfuscationwasapplied,symbolnamesremainmeaningfulandcanbeeasilyreadstraightfromtheappbinary. For instance, afunctionwhichdetectsajailbreakcanbelocatedbysearchingforrelevantkeywords(e.g.“jailbreak”). The listingbelowshowsthedisassembledfunctionJailbreakDetectionViewController.jailbreakTest4Tappedfromthe DamnVulnerableiOSApp(DVIA-v2). __T07DVIA_v232JailbreakDetectionViewControllerC20jailbreakTest4TappedyypF: stp x22,x21,[sp,#-0x30]! mov rbp,rsp Aftertheobfuscationwecanobservethatthesymbol’snameisnolongermeaningfulasshownonthelistingbelow. __T07DVIA_v232zNNtWKQptikYUBNBgfFVMjSkvRdhhnbyyFySbyypF: stp x22,x21,[sp,#-0x30]! mov rbp,rsp Nevertheless,thisonlyappliestothenamesoffunctions,classesandfields. Theactualcoderemainsunmodified,soan attackercanstillreadthedisassembledversionofthefunctionandtrytounderstanditspurpose(e.g.toretrievethelogic ofasecurityalgorithm). Instruction Substitution This technique replaces standard binary operators like addition or subtraction with more complex representations. For exampleanadditionx = a + bcanberepresentedasx = -(-a) - (-b). However, usingthesamereplacementrepre- sentation could be easily reversed, so it is recommended to add multiple substitution techniques for a single case and introducearandomfactor. Thistechniqueisvulnerabletodeobfuscation,butdependingonthecomplexityanddepthof thesubstitutions,applyingitcanstillbetimeconsuming. Control Flow Flattening Controlflowflatteningreplacesoriginalcodewithamorecomplexrepresentation. Thetransformationbreaksthebodyof afunctionintobasicblocksandputsthemallinsideasingleinfiniteloopwithaswitchstatementthatcontrolstheprogram flow. This makes the program flow significantly harder to follow because it removes the natural conditional constructs thatusuallymakethecodeeasiertoread. Theimageshowshowcontrolflowflatteningalterscode. See“ObfuscatingC++programsviacontrolflowflattening”for moreinformation. 515\\nDead Code Injection Thistechniquemakestheprogram’scontrolflowmorecomplexbyinjectingdeadcodeintotheprogram. Deadcodeisa stubofcodethatdoesn’taffecttheoriginalprogram’sbehaviourbutincreasestheoverheadforthereverseengineering process. String Encryption Applications are often compiled with hardcoded keys, licences,", "metadata": {"doc_id": "OWASP_MASTG", "chunk_id": 165}}