{"text": "ThankstoApple’sconfusingprovisioningandcode-signingsystem,re-signinganappismorechallengingthanyouwould expect. iOSwon’trunanappunlessyougettheprovisioningprofileandcodesignatureheaderexactlyright. Thisrequires learningmanyconcepts-certificatetypes,BundleIDs,applicationIDs,teamidentifiers,andhowApple’sbuildtoolsconnect them. GettingtheOStorunabinarythathasn’tbeenbuiltviathedefaultmethod(Xcode)canbeadauntingprocess. We’lluseoptool,Apple’sbuildtools,andsomeshellcommands. OurmethodisinspiredbyVincentTan’sSwizzlerproject. TheNCCgrouphasdescribedanalternativerepackagingmethod. Toreproducethestepslistedbelow,downloadUnCrackableiOSAppLevel1fromtheOWASPMobileTestingGuiderepos- itory. Our goal is to make the UnCrackable app load FridaGadget.dylib during startup so we can instrument the app withFrida. PleasenotethatthefollowingstepsapplytomacOSonly,asXcodeisonlyavailableformacOS. Getting a Developer Provisioning Profile and Certificate TheprovisioningprofileisaplistfilesignedbyApple,whichaddsyourcode-signingcertificatetoitslistofacceptedcertifi- catesononeormoredevices. Inotherwords,thisrepresentsAppleexplicitlyallowingyourapptorunforcertainreasons, such as debugging on selected devices (development profile). The provisioning profile also includes the entitlements grantedtoyourapp. Thecertificatecontainstheprivatekeyyou’llusetosign. Dependingonwhetheryou’reregisteredasaniOSdeveloper,youcanobtainacertificateandprovisioningprofileinone ofthefollowingways: WithaniOSdeveloperaccount: Ifyou’vedevelopedanddeployediOSappswithXcodebefore,youalreadyhaveyourowncode-signingcertificateinstalled. Usethesecuritycommand(macOSonly)tolistyoursigningidentities: $securityfind-identity -v 1)61FA3547E0AF42A11E233F6A2B255E6B6AF262CE \"iPhoneDistribution:CompanyNameLtd.\" 2)8004380F331DCA22CC1B47FB1A805890AE41C938 \"iPhoneDeveloper:BernhardMüller(RV852WND79)\" LogintotheAppleDeveloperportaltoissueanewAppID,thenissueanddownloadtheprofile. AnAppIDisatwo-part string: aTeamIDsuppliedbyAppleandabundleIDsearchstringthatyoucansettoanarbitraryvalue, suchascom. example.myapp. Note that you can use a single App ID to re-sign multiple apps. Make sure you create adevelopment profileandnotadistributionprofilesothatyoucandebugtheapp. Intheexamplesbelow,Iusemysigningidentity,whichisassociatedwithmycompany’sdevelopmentteam. Icreated theAppID“sg.vp.repackaged”andtheprovisioningprofile“AwesomeRepackaging”fortheseexamples. Iendedupwith thefileAwesomeRepackaging.mobileprovision-replacethiswithyourownfilenameintheshellcommandsbelow. WithaRegularAppleID: Applewillissueafreedevelopmentprovisioningprofileevenifyou’renotapayingdeveloper. Youcanobtaintheprofile viaXcodeandyourregularAppleaccount: simplycreateanemptyiOSprojectandextractembedded.mobileprovision from the app container, which is in the Xcode subdirectory of your home directory: ~/Library/Developer/Xcode/ DerivedData/<ProjectName>/Build/Products/Debug-iphoneos/<ProjectName>.app/. TheNCCblogpost“iOSinstru- mentationwithoutjailbreak”explainsthisprocessingreatdetail. Once you’ve obtained the provisioning profile, you can check its contents with the security command. You’ll find the entitlementsgrantedtotheappintheprofile,alongwiththeallowedcertificatesanddevices. You’llneedtheseforcode- signing,soextractthemtoaseparateplistfileasshownbelow. Havealookatthefilecontentstomakesureeverything isasexpected. $securitycms -D-iAwesomeRepackaging.mobileprovision >profile.plist $/usr/libexec/PlistBuddy -x-c'Print:Entitlements' profile.plist >entitlements.plist $catentitlements.plist <?xmlversion=\"1.0\" encoding=\"UTF-8\"?> <!DOCTYPEplistPUBLIC \"-//Apple//DTDPLIST1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"> <plist version=\"1.0\"> <dict> <key>application-identifier</key> 338\\n<string>LRUD9L355Y.sg.vantagepoint.repackage</string> <key>com.apple.developer.team-identifier</key> <string>LRUD9L355Y</string> <key>get-task-allow</key> <true/> <key>keychain-access-groups</key> <array> <string>LRUD9L355Y.*</string> </array> </dict> </plist> Notetheapplicationidentifier,whichisacombinationoftheTeamID(LRUD9L355Y)andBundleID(sg.vantagepoint.repackage). ThisprovisioningprofileisonlyvalidfortheappthathasthisAppID.Theget-task-allowkeyisalsoimportant: when settotrue,otherprocesses,suchasthedebuggingserver,areallowedtoattachtotheapp(consequently,thiswould besettofalseinadistributionprofile). Method Hooking Platform: ios Frida Insection“ExecutionTracing”we’veusedfrida-tracewhennavigatingtoawebsiteinSafariandfoundthattheinitWith- URL:methodiscalledtoinitializeanewURLrequestobject. WecanlookupthedeclarationofthismethodontheApple DeveloperWebsite: -(instancetype)initWithURL:(NSURL *)url; UsingthisinformationwecanwriteaFridascriptthatinterceptstheinitWithURL:methodandprintstheURLpassedto themethod. Thefullscriptisbelow. Makesureyoureadthecodeandinlinecommentstounderstandwhat’sgoingon. importsys importfrida ##JavaScripttobeinjected frida_code =\"\"\" //ObtainareferencetotheinitWithURL:methodoftheNSURLRequestclass varURL=ObjC.classes.NSURLRequest[\"-initWithURL:\"]; //Interceptthemethod Interceptor.attach(URL.implementation,{ onEnter:function(args){ //GetahandleonNSString varNSString=ObjC.classes.NSString; //ObtainareferencetotheNSLogfunction,anduseittoprinttheURLvalue //args[2]referstothefirstmethodargument(NSURL*url) varNSLog=newNativeFunction(Module.findExportByName('Foundation','NSLog'),'void',['pointer','...']); //WeshouldalwaysinitializeanautoreleasepoolbeforeinteractingwithObjective-CAPIs varpool=ObjC.classes.NSAutoreleasePool.alloc().init(); try{ //CreatesaJSbindinggivenaNativePointer. varmyNSURL=newObjC.Object(args[2]); //CreateanimmutableObjCstringobjectfromaJSstringobject. varstr_url=NSString.stringWithString_(myNSURL.toString()); //CalltheiOSNSLogfunctiontoprinttheURLtotheiOSdevicelogs NSLog(str_url); //UseFrida'sconsole.logtoprinttheURLtoyourterminal console.log(str_url); }finally{ pool.release(); } } }); \"\"\" 339\\nprocess =frida.get_usb_device().attach(\"Safari\") script =process.create_script(frida_code) script.load() sys.stdin.read() StartSafariontheiOSdevice. RuntheabovePythonscriptonyourconnectedhostandopenthedevicelog(asexplained inthesection“MonitoringSystemLogs”fromthechapter“iOSBasicSecurityTesting”). TryopeninganewURLinSafari, e.g.https://github.com/OWASP/owasp-mastg;youshouldseeFrida’soutputinthelogsaswellasinyourterminal. Of course, this example illustrates only one of the things you can do with Frida. To unlock the tool’s full potential, you should learn to use its JavaScript API. The documentation section of the Frida website has a tutorial and examples for usingFridaoniOS. Getting Loaded Classes and Methods dynamically Platform: ios IntheFridaREPLObjective-CruntimetheObjCcommandcanbeusedtoaccessinformationwithintherunningapp. Within theObjCcommandthefunctionenumerateLoadedClassesliststheloadedclassesforagivenapplication. $frida -U-fcom.iOweApp [iPhone::com.iOweApp]->ObjC.enumerateLoadedClasses() { \"/System/Library/Frameworks/CoreFoundation.framework/CoreFoundation\":[ \"__NSBlockVariable__\", \"__NSGlobalBlock__\", \"__NSFinalizingBlock__\", \"__NSAutoBlock__\", \"__NSMallocBlock__\", \"__NSStackBlock__\" ], \"/private/var/containers/Bundle/Application/F390A491-3524-40EA-B3F8-6C1FA105A23A/iOweApp.app/iOweApp\":[ \"JailbreakDetection\", \"CriticalLogic\", \"ViewController\", \"AppDelegate\" ] } UsingObjC.classes.<classname>.$ownMethodsthemethodsdeclaredineachclasscanbelisted. [iPhone::com.iOweApp]->ObjC.classes.JailbreakDetection.$ownMethods [ \"+isJailbroken\" ] [iPhone::com.iOweApp]->ObjC.classes.CriticalLogic.$ownMethods [ \"+doSha256:\", \"-a:\", \"-AES128Operation:data:key:iv:\", 340\\n\"-coreLogic\", \"-bat\", \"-b:\", \"-hexString:\" ] Sandbox Inspection Platform: ios On iOS, each application gets a sandboxed folder to store its data. As per the iOS security model, an application’s sandboxed folder cannot be accessed by another application. Additionally, the users do not have direct access to the iOSfilesystem,thuspreventingbrowsingorextractionofdatafromthefilesystem. IniOS<8.3therewereapplications availablewhichcanbeusedtobrowsethedevice’sfilesystem,suchasiExplorerandiFunBox,butintherecentversionof iOS(>8.3)thesandboxingrulesaremorestringentandtheseapplicationsdonotworkanymore. Asaresult,ifyouneed toaccessthefilesystemitcanonlybeaccessedonajailbrokendevice. Aspartofthejailbreakingprocess,theapplication sandboxprotectionisdisabledandthusenablinganeasyaccesstosandboxedfolders. Thecontentsofanapplication’ssandboxedfolderhasalreadybeendiscussedin“AccessingAppDataDirectories”inthe chapteriOSBasicSecurityTesting. Thischaptergivesanoverviewofthefolderstructureandwhichdirectoriesyoushould analyze. Information Gathering - API Usage Platform: ios TheiOSplatformprovidesmanybuilt-inlibrariesforfrequentlyusedfunctionalitiesinapplications,forexamplecryptog- raphy,Bluetooth,NFC,networkandlocationlibraries. Determiningthepresenceoftheselibrariesinanapplicationcan giveusvaluableinformationaboutitsunderlyingworking. For instance, if an application is importing the CC_SHA256 function, it indicates that the application will be performing somekindofhashingoperationusingtheSHA256algorithm. FurtherinformationonhowtoanalyzeiOS’scryptographic APIsisdiscussedinthesection“iOSCryptographicAPIs”. Similarly,theaboveapproachcanbeusedtodeterminewhereandhowanapplicationisusingBluetooth. Forinstance,an applicationperformingcommunicationusingtheBluetoothchannelmustusefunctionsfromtheCoreBluetoothframework suchasCBCentralManagerorconnect. UsingtheiOSBluetoothdocumentationyoucandeterminethecriticalfunctions andstartanalysisaroundthosefunctionimports. Emulation-based Analysis Platform: ios iOS Simulator Apple provides a simulator app within Xcode which provides a real iOS device looking user interface for iPhone, iPad or Apple Watch. It allows you to rapidly prototype and test debug builds of your applications during the development process,butactuallyitisnotanemulator. Differencebetweenasimulatorandanemulatorispreviouslydiscussedin “Emulation-basedDynamicAnalysis”section. Whiledevelopinganddebugginganapplication,theXcodetoolchaingeneratesx86code,whichcanbeexecutedinthe iOS simulator. However, for a release build, only ARM code is generated (incompatible with the iOS simulator). That’s why applications downloaded from the Apple App Store cannot be used for any kind of application analysis", "metadata": {"doc_id": "OWASP_MASTG", "chunk_id": 123}}