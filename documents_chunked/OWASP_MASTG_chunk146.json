{"text": "nscurl can be used. A permutation of different settings will be executed and verified against the specified endpoint. If the default ATS secure connection test is passing, ATS can be used in its default secure configuration. If thereareanyfailsinthenscurloutput,pleasechangetheserversideconfigurationofTLStomaketheserversidemore secure,ratherthanweakeningtheconfigurationinATSontheclient. Seethearticle“IdentifyingtheSourceofBlocked Connections”intheAppleDeveloperDocumentationformoredetails. Refertosection“VerifyingtheTLSSettings”inchapterTestingNetworkCommunicationfordetails. Testing Custom Certificate Stores and Certificate Pinning Platform: ios MASVSV1: MSTG-NETWORK-4 MASVSV2: MASVS-NETWORK-2 Overview Static Analysis Verifythattheservercertificateispinned. Pinningcanbeimplementedonvariouslevelsintermsofthecertificatetree presentedbytheserver: 1. Includingserver’scertificateintheapplicationbundleandperformingverificationoneachconnection. Thisrequires anupdatemechanismswheneverthecertificateontheserverisupdated. 2. Limitingcertificateissuertoe.g.oneentityandbundlingtheintermediateCA’spublickeyintotheapplication. In thiswaywelimittheattacksurfaceandhaveavalidcertificate. 3. OwningandmanagingyourownPKI.TheapplicationwouldcontaintheintermediateCA’spublickey. Thisavoids updatingtheapplicationeverytimeyouchangethecertificateontheserver,duetoe.g.expiration. Notethatusing yourownCAwouldcausethecertificatetobeself-singed. ThelatestapproachrecommendedbyAppleistospecifyapinnedCApublickeyintheInfo.plistfileunderAppTransport SecuritySettings. YoucanfindanexampleintheirarticleIdentityPinning: Howtoconfigureservercertificatesforyour app. Another common approach is to use the connection:willSendRequestForAuthenticationChallenge: method of NSURLConnectionDelegatetocheckifthecertificateprovidedbytheserverisvalidandmatchesthecertificatestored intheapp. YoucanfindmoredetailsintheHTTPSServerTrustEvaluationtechnicalnote. Thefollowingthird-partylibrariesincludepinningfunctionality: • TrustKit: hereyoucanpinbysettingthepublickeyhashesinyourInfo.plistorprovidethehashesinadictionary. SeetheirREADMEformoredetails. • AlamoFire: hereyoucandefineaServerTrustPolicyperdomainforwhichyoucandefineaPinnedCertificat- esTrustEvaluator. Seeitsdocumentationformoredetails. • AFNetworking: hereyoucansetanAFSecurityPolicytoconfigureyourpinning. Dynamic Analysis Server certificate pinning FollowtheinstructionsfromtheDynamicAnalysissectionof“TestingEndpointIdentityVerification. Ifdoingsodoesn’t leadtotrafficbeingproxied,itmaymeanthatcertificatepinningisactuallyimplementedandallsecuritymeasuresare inplace. Doesthesamehappenforalldomains? 431\\nAs a quick smoke test, you can try to bypass certificate pinning using objection as described in “Bypassing Certificate Pinning”. PinningrelatedAPIsbeinghookedbyobjectionshouldappearinobjection’soutput. However,keepinmindthat: • theAPIsmightnotbecomplete. • ifnothingishooked,thatdoesn’tnecessarilymeanthattheappdoesn’timplementpinning. Inbothcases,theapporsomeofitscomponentsmightimplementcustompinninginawaythatissupportedbyobjection. Pleasecheckthestaticanalysissectionforspecificpinningindicatorsandmorein-depthtesting. Client certificate validation Someapplications usemTLS (mutual TLS),meaning that theapplication verifiesthe server’s certificateand the server verifies the client’s certificate. You can notice this if there is an error in Burp Alerts tab indicating that client failed to negotiateconnection. Thereareacoupleofthingsworthnoting: 1. Theclientcertificatecontainsaprivatekeythatwillbeusedforthekeyexchange. 2. Usuallythecertificatewouldalsoneedapasswordtouse(decrypt)it. 3. Thecertificatecanbestoredinthebinaryitself,datadirectoryorintheKeychain. The most common and improper way of using mTLS is to store the client certificate within the application bundle and hardcodethepassword. Thisobviouslydoesnotbringmuchsecurity,becauseallclientswillsharethesamecertificate. Second way of storing the certificate (and possibly password) is to use the Keychain. Upon first login, the application shoulddownloadthepersonalcertificateandstoreitsecurelyintheKeychain. Sometimesapplicationshaveonecertificatethatishardcodedanduseitforthefirstloginandthenthepersonalcertificate isdownloaded. Inthiscase,checkifit’spossibletostillusethe‘generic’certificatetoconnecttotheserver. Onceyouhaveextractedthecertificatefromtheapplication(e.g.usingFrida),additasclientcertificateinBurp,andyou willbeabletointerceptthetraffic. Testing Endpoint Identity Verification Platform: ios MASVSV1: MSTG-NETWORK-3 MASVSV2: MASVS-NETWORK-1 432\\nOverview Static Analysis UsingTLStotransportsensitiveinformationoverthenetworkisessentialforsecurity. However,encryptingcommunication betweenamobileapplicationanditsbackendAPIisnottrivial. Developersoftendecideonsimplerbutlesssecuresolutions (e.g.,thosethatacceptanycertificate)tofacilitatethedevelopmentprocess,andsometimestheseweaksolutionsmake itintotheproductionversion,potentiallyexposinguserstoman-in-the-middleattacks. Thesearesomeoftheissuesshouldbeaddressed: • CheckiftheapplinksagainstanSDKolderthaniOS9.0. InthatcaseATSisdisablednomatterwhichversionof theOStheapprunson. • Verifythatacertificatecomesfromatrustedsource,i.e.atrustedCA(CertificateAuthority). • Determinewhethertheendpointserverpresentstherightcertificate. Makesurethatthehostnameandthecertificateitselfareverifiedcorrectly. Examplesandcommonpitfallsareavailable intheofficialAppledocumentation. Wehighlyrecommendsupportingstaticanalysiswiththedynamicanalysis. Ifyoudon’thavethesourcecodeortheapp isdifficulttoreverseengineer,havingasoliddynamicanalysisstrategycandefinitelyhelp. Inthatcaseyouwon’tknowif theappusesloworhigh-levelAPIsbutyoucanstilltestfordifferenttrustevaluationscenarios(e.g.“doestheappaccept aself-signedcertificate?”). Dynamic Analysis OurtestapproachistograduallyrelaxsecurityoftheSSLhandshakenegotiationandcheckwhichsecuritymechanisms areenabled. 1. HavingBurpsetupasaproxy,makesurethatthereisnocertificateaddedtothetruststore(Settings->General ->Profiles)andthattoolslikeSSLKillSwitcharedeactivated. Launchyourapplicationandcheckifyoucansee thetrafficinBurp. Anyfailureswillbereportedunder‘Alerts’tab. Ifyoucanseethetraffic,itmeansthatthereis nocertificatevalidationperformedatall. Ifhowever,youcan’tseeanytrafficandyouhaveaninformationabout SSLhandshakefailure,followthenextpoint. 2. Now,installtheBurpcertificate,asexplainedinBurp’suserdocumentation. Ifthehandshakeissuccessfulandyou canseethetrafficinBurp,itmeansthatthecertificateisvalidatedagainstthedevice’struststore,butnopinning isperformed. If executing the instructions from the previous step doesn’t lead to traffic being proxied, it may mean that certificate pinningisactuallyimplementedandallsecuritymeasuresareinplace. However,youstillneedtobypassthepinningin ordertotesttheapplication. Pleaserefertothesection“BypassingCertificatePinning”formoreinformationonthis. Testing Data Encryption on the Network Platform: ios MASVSV1: MSTG-NETWORK-1 MASVSV2: MASVS-NETWORK-1 Overview Allthepresentedcasesmustbecarefullyanalyzedasawhole. Forexample, eveniftheappdoesnotpermitcleartext trafficinitsInfo.plist,itmightactuallystillbesendingHTTPtraffic. Thatcouldbethecaseifit’susingalow-levelAPI(for whichATSisignored)orabadlyconfiguredcross-platformframework. IMPORTANT:Youshouldapplytheseteststotheappmaincodebutalsotoanyappextensions,frameworksorWatch appsembeddedwithintheappaswell. 433\\nFormoreinformationrefertothearticle“PreventingInsecureNetworkConnections”and“Fine-tuneyourAppTransport Securitysettings”intheAppleDeveloperDocumentation. Static Analysis Testing Network Requests over Secure Protocols First, you should identify all network requests in the source code and ensure that no plain HTTP URLs are used. Make surethatsensitiveinformationissentoversecurechannelsbyusingURLSession(whichusesthestandardURLLoading SystemfromiOS)orNetwork(forsocket-levelcommunicationusingTLSandaccesstoTCPandUDP). Check for Low-Level Networking API Usage IdentifythenetworkAPIsusedbytheappandseeifitusesanylow-levelnetworkingAPIs. Apple Recommendation: Prefer High-Level Frameworks in Your App: “ATSdoesn’tapplytocallsyourapp makes to lower-level networking interfaces like the Network framework or CFNetwork. In these cases, you take responsibility for ensuring the security of the connection. You can construct a secure connection this way, but mistakes are both easy to make and costly. It’s typically safest to rely on the URL Loading System instead” (see source). Iftheappusesanylow-levelAPIssuchasNetworkorCFNetwork,youshouldcarefullyinvestigateiftheyarebeingused securely. Forappsusingcross-platformframeworks(e.g.Flutter,Xamarin,...)andthirdpartyframeworks(e.g.Alamofire) youshouldanalyzeifthey’rebeingconfiguredandusedsecurelyaccordingtotheirbestpractices. Makesurethattheapp: • verifiesthechallengetypeandthehostnameandcredentialswhenperformingservertrustevaluation. • doesn’tignoreTLSerrors. • doesn’tuseanyinsecureTLSconfigurations(see“TestingtheTLSSettings”) Thesechecksareorientative,wecannotnamespecificAPIssinceeveryappmightuseadifferentframework. Pleaseuse thisinformationasareferencewheninspectingthecode. Testing for Cleartext Traffic EnsurethattheappisnotallowingcleartextHTTPtraffic. SinceiOS9.0cleartextHTTPtrafficisblockedbydefault(due toAppTransportSecurity(ATS))buttherearemultiplewaysinwhichanapplicationcanstillsendit: • Configuring ATS to enable cleartext traffic by setting the NSAllowsArbitraryLoads attribute to true (or YES) on NSAppTransportSecurityintheapp’sInfo.plist. • RetrievetheInfo.plist • CheckthatNSAllowsArbitraryLoadsisnotsettotruegloballyofforanydomain. • If the application opens third party web sites in WebViews, then from iOS 10 onwards NSAllowsArbitraryLoad- sInWebContentcanbeusedtodisableATSrestrictionsforthecontentloadedinwebviews. Apple", "metadata": {"doc_id": "OWASP_MASTG", "chunk_id": 146}}