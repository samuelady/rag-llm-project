{"text": "deeplinkdemo://load.html. However,wedon’t knowthecorrespondinghandlermethodyet,northeparametersitpotentiallyaccepts. [Step1]FridaHooking: Youcanusethescript“AndroidDeepLinkObserver”fromFridaCodeSharetomonitorallinvokeddeeplinkstriggeringa calltoIntent.getData. Youcanalsousethescriptasabasetoincludeyourownmodificationsdependingontheuse case at hand. In this case we included the stack trace in the script since we are interested in the method which calls Intent.getData. [Step2]InvokingDeepLinks: Now you can invoke any of the deep links using adb and the Activity Manager (am) which will send intents within the Androiddevice. Forexample: adbshellamstart -W-aandroid.intent.action.VIEW -d\"deeplinkdemo://load.html/?message=ok#part1\" Starting:Intent{act=android.intent.action.VIEWdat=deeplinkdemo://load.html/?message=ok} Status:ok LaunchState:WARM Activity:com.mstg.deeplinkdemo/.WebViewActivity TotalTime:210 WaitTime:217 Complete Thismighttriggerthedisambiguationdialogwhenusingthe“http/https”schemaorifotherinstalledappssupport thesamecustomURLschema. Youcanincludethepackagenametomakeitanexplicitintent. Thisinvocationwilllogthefollowing: [*]Intent.getData()wascalled [*]Activity:com.mstg.deeplinkdemo.WebViewActivity [*]Action:android.intent.action.VIEW [*]Data -Scheme:deeplinkdemo:// -Host:/load.html -Params:message=ok -Fragment:part1 [*]Stacktrace: android.content.Intent.getData(Intent.java) com.mstg.deeplinkdemo.WebViewActivity.onCreate(WebViewActivity.kt) android.app.Activity.performCreate(Activity.java) ... com.android.internal.os.ZygoteInit.main(ZygoteInit.java) In this case we’ve crafted the deep link including arbitrary parameters (?message=ok) and fragment (#part1). We still don’t know if they are being used. The information above reveals useful information that you can use now to reverse engineertheapp. Seethesection“ChecktheHandlerMethod”tolearnaboutthingsyoushouldconsider. • File: WebViewActivity.kt • Class: com.mstg.deeplinkdemo.WebViewActivity • Method: onCreate 284\\nSometimes you can even take advantage of other applications that you know interact with your target app. You can reverse engineer the app, (e.g. to extract all strings and filter those which include the target deep links, deeplinkdemo:///load.htmlinthepreviouscase), orusethemastriggers, whilehookingtheappaspreviously discussed. Testing for Java Objects Exposed Through WebViews Platform: android MASVSV1: MSTG-PLATFORM-7 MASVSV2: MASVS-PLATFORM-2 Overview TotestforJavaobjectsexposedthroughWebViewschecktheappforWebViewshavingJavaScriptenabledanddetermine whethertheWebViewiscreatinganyJavaScriptinterfacesaka. “JavaScriptBridges”. Finally,checkwhetheranattacker couldpotentiallyinjectmaliciousJavaScriptcode. Static Analysis The following example shows how addJavascriptInterface is used to bridge a Java Object and JavaScript in a Web- View: WebViewwebview =newWebView(this); WebSettingswebSettings =webview.getSettings(); webSettings.setJavaScriptEnabled(true); MSTG_ENV_008_JS_InterfacejsInterface =newMSTG_ENV_008_JS_Interface(this); myWebView.addJavascriptInterface(jsInterface,\"Android\"); myWebView.loadURL(\"http://example.com/file.html\"); setContentView(myWebView); In Android 4.2 (API level 17) and above, an annotation @JavascriptInterface explicitly allows JavaScript to access a Javamethod. public class MSTG_ENV_008_JS_Interface { ContextmContext; /**Instantiatetheinterfaceandsetthecontext */ MSTG_ENV_005_JS_Interface(Contextc){ mContext =c; } @JavascriptInterface public String returnString (){ return \"SecretString\"; } /**Showatoastfromthewebpage */ @JavascriptInterface public void showToast(Stringtoast){ Toast.makeText(mContext,toast,Toast.LENGTH_SHORT).show(); } } ThisishowyoucancallthemethodreturnStringfromJavaScript,thestring“SecretString”willbestoredinthevariable result: varresult =window.Android.returnString(); WithaccesstotheJavaScriptcode,via,forexample,storedXSSoraMITMattack,anattackercandirectlycalltheexposed Javamethods. IfaddJavascriptInterfaceisnecessary,takethefollowingconsiderations: 285\\n• Only JavaScript provided with the APK should be allowed to use the bridges, e.g. by verifying the URL on each bridgedJavamethod(viaWebView.getUrl). • NoJavaScriptshouldbeloadedfromremoteendpoints,e.g.bykeepingpagenavigationwithintheapp’sdomains andopeningallotherdomainsonthedefaultbrowser(e.g.Chrome,Firefox). • Ifnecessaryforlegacyreasons(e.g.havingtosupportolderdevices),atleastsettheminimalAPIlevelto17inthe manifestfileoftheapp(<uses-sdk android:minSdkVersion=\"17\" />). Dynamic Analysis DynamicanalysisoftheappcanshowyouwhichHTMLorJavaScriptfilesareloadedandwhichvulnerabilitiesarepresent. TheprocedureforexploitingthevulnerabilitystartswithproducingaJavaScriptpayloadandinjectingitintothefilethat theappisrequesting. TheinjectioncanbeaccomplishedviaaMITMattackordirectmodificationofthefileifitisstoredin externalstorage. ThewholeprocesscanbeaccomplishedviaDrozerandweasel(MWR’sadvancedexploitationpayload), whichcaninstallafullagent,injectingalimitedagentintoarunningprocessorconnectingareverseshellasaRemote AccessTool(RAT). Afulldescriptionoftheattackisincludedintheblogarticle“WebViewaddJavascriptInterfaceRemoteCodeExecution”. 286\\nAndroid Code Quality and Build Settings Overview App Signing AndroidrequiresallAPKstobedigitallysignedwithacertificatebeforetheyareinstalledorrun. Thedigitalsignatureis usedtoverifytheowner’sidentityforapplicationupdates. Thisprocesscanpreventanappfrombeingtamperedwithor modifiedtoincludemaliciouscode. When an APK is signed, a public-key certificate is attached to it. This certificate uniquely associates the APK with the developerandthedeveloper’sprivatekey. Whenanappisbeingbuiltindebugmode,theAndroidSDKsignstheappwith adebugkeycreatedspecificallyfordebuggingpurposes. Anappsignedwithadebugkeyisnotmeanttobedistributed andwon’tbeacceptedinmostappstores,includingtheGooglePlayStore. Thefinalreleasebuildofanappmustbesignedwithavalidreleasekey. InAndroidStudio,theappcanbesignedmanually orviacreationofasigningconfigurationthat’sassignedtothereleasebuildtype. PriorAndroid9(APIlevel28)allappupdatesonAndroidneedtobesignedwiththesamecertificate,soavalidityperiod of25yearsormoreisrecommended. AppspublishedonGooglePlaymustbesignedwithakeythatthathasavalidity periodendingafterOctober22th,2033. ThreeAPKsigningschemesareavailable: • JARsigning(v1scheme), • APKSignatureSchemev2(v2scheme), • APKSignatureSchemev3(v3scheme). Thev2signature,whichissupportedbyAndroid7.0(APIlevel24)andabove,offersimprovedsecurityandperformance compared to v1 scheme. The V3 signature, which is supported by Android 9 (API level 28) and above, gives apps the abilitytochangetheirsigningkeysaspartofanAPKupdate. Thisfunctionalityassurescompatibilityandappscontinuous availabilitybyallowingboththenewandtheoldkeystobeused. Notethatitisonlyavailableviaapksigneratthetime ofwriting. Foreachsigningschemethereleasebuildsshouldalwaysbesignedviaallitspreviousschemesaswell. Third-Party Libraries Androidappsoftenmakeuseofthirdpartylibraries. Thesethirdpartylibrariesacceleratedevelopmentasthedeveloper hastowritelesscodeinordertosolveaproblem. Therearetwocategoriesoflibraries: • Librariesthatarenot(orshouldnot)bepackedwithintheactualproductionapplication,suchasMockitousedfor testingandlibrarieslikeJavaAssistusedtocompilecertainotherlibraries. • Librariesthatarepackedwithintheactualproductionapplication,suchasOkhttp3. Theselibrariescanleadtounwantedside-effects: • Alibrarycancontainavulnerability,whichwillmaketheapplicationvulnerable. Agoodexamplearetheversions ofOKHTTPpriorto2.7.5inwhichTLSchainpollutionwaspossibletobypassSSLpinning. • Alibrarycannolongerbemaintainedorhardlybeused,whichiswhynovulnerabilitiesarereportedand/orfixed. Thiscanleadtohavingbadand/orvulnerablecodeinyourapplicationthroughthelibrary. • Alibrarycanusealicense,suchasLGPL2.1,whichrequirestheapplicationauthortoprovideaccesstothesource code for those who use the application and request insight in its sources. In fact the application should then be allowedtoberedistributedwithmodificationstoitssourcecode. Thiscanendangertheintellectualproperty(IP)of theapplication. Pleasenotethatthisissuecanholdonmultiplelevels: WhenyouusewebviewswithJavaScriptrunninginthewebview, theJavaScriptlibrariescanhavetheseissuesaswell. Thesameholdsforplugins/librariesforCordova,React-nativeand Xamarinapps. 287\\nMemory Corruption Bugs AndroidapplicationsrunonaVMwheremostofthememorycorruptionissueshavebeentakencareoff. Thisdoesnot meanthattherearenomemorycorruptionbugs. TakeCVE-2018-9522forinstance,whichisrelatedtoserializationissues usingParcels. Next,innativecode,westillseethesameissuesasweexplainedinthegeneralmemorycorruptionsection. Last,weseememorybugsinsupportingservices,suchaswiththeStagefrightattackasshownatBlackHat. Memoryleaksareoftenanissueaswell. ThiscanhappenforinstancewhenareferencetotheContextobjectispassed aroundtonon-Activityclasses,orwhenyoupassreferencestoActivityclassestoyourhelperclasses. Binary Protection Mechanisms Detectingthepresenceofbinaryprotectionmechanismsheavilydependonthelanguageusedfordevelopingtheappli- cation. Ingeneralallbinariesshouldbetested,whichincludesboththemainappexecutableaswellasalllibraries/dependencies. However,onAndroidwewillfocusonnativelibrariessincethemainexecutablesareconsideredsafeaswewillseenext. AndroidoptimizesitsDalvikbytecodefromtheappDEXfiles(e.g.classes.dex)andgeneratesanewfilecontainingthe nativecode,usuallywithan.odex,.oatextension. ThisAndroidcompiledbinaryiswrappedusingtheELFformatwhich istheformatusedbyLinuxandAndroidtopackageassemblycode. Theapp’sNDKnativelibrariesalsousetheELFformat. • PIE(PositionIndependentExecutable): – SinceAndroid7.0(APIlevel24),PICcompilationisenabledbydefaultforthemainexecutables. – WithAndroid5.0(APIlevel21),supportfornon-PIEenablednativelibrarieswasdroppedandsincethen,PIE isenforcedbythelinker. • Memorymanagement: – Garbage Collection will simply run for the main binaries and there’s nothing to be checked on the binaries", "metadata": {"doc_id": "OWASP_MASTG", "chunk_id": 107}}