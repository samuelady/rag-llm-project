{"text": "can have one of several file extensions, including.soand.dll(x86support). Thisfoldercontainssubdirectoriesfortheplatformstheapphasnativelibraries for,including – armeabi: compiledcodeforallARM-basedprocessors – armeabi-v7a: compiledcodeforallARM-basedprocessors,version7andaboveonly – arm64-v8a: compiledcodeforall64-bitARM-basedprocessors,version8andabovebasedonly – x86: compiledcodeforx86processorsonly – x86_64: compiledcodeforx86_64processorsonly – mips: compiledcodeforMIPSprocessors • shared_prefs: ThisfoldercontainsanXMLfilethatstoresvaluessavedviatheSharedPreferencesAPIs. • files: Thisfolderstoresregularfilescreatedbytheapp. • databases: ThisfolderstoresSQLitedatabasefilesgeneratedbytheappatruntime,e.g.,userdatafiles. However,theappmightstoremoredatanotonlyinsidethesefoldersbutalsointheparentfolder(/data/data/[package- name]). Refertothe“TestingDataStorage”chapterformoreinformationandbestpracticesonsecurelystoringsensitivedata. 126\\nDynamic Analysis on Non-Rooted Devices Platform: android Non-rooteddeviceshavethebenefitofreplicatinganenvironmentthattheapplicationisintendedtorunon. Thankstotoolslikeobjection,youcanpatchtheappinordertotestitlikeifyouwereonarooteddevice(butofcourse being jailed to that one app). To do that you have to perform one additional step: patch the APK to include the Frida gadgetlibrary. Nowyoucanuseobjectiontodynamicallyanalyzetheapplicationonnon-rooteddevices. ThefollowingcommandssummarizehowtopatchandstartdynamicanalysisusingobjectionusingtheUnCrackableApp forAndroidLevel1asanexample: ##DownloadtheUncrackableAPK $wgethttps://raw.githubusercontent.com/OWASP/owasp-mastg/master/Crackmes/Android/Level_01/UnCrackable-Level1.apk ##PatchtheAPKwiththeFridaGadget $objectionpatchapk --source UnCrackable-Level1.apk ##InstallthepatchedAPKontheandroidphone $adbinstallUnCrackable-Level1.objection.apk ##Afterrunningthemobilephone,objectionwilldetecttherunningfrida-serverthroughtheAPK $objectionexplore Static Analysis on Android Platform: android Bypassing Certificate Pinning Platform: android SomeapplicationswillimplementSSLPinning,whichpreventstheapplicationfromacceptingyourinterceptingcertificate asavalidcertificate. Thismeansthatyouwillnotbeabletomonitorthetrafficbetweentheapplicationandtheserver. Formostapplications,certificatepinningcanbebypassedwithinseconds,butonlyiftheappusestheAPIfunctionsthat arecoveredbythesetools. IftheappisimplementingSSLPinningwithacustomframeworkorlibrary,theSSLPinning mustbemanuallypatchedanddeactivated,whichcanbetime-consuming. ThissectiondescribesvariouswaystobypassSSLPinningandgivesguidanceaboutwhatyoushoulddowhentheexisting toolsdon’thelp. Bypassing Methods Thereareseveralwaystobypasscertificatepinningforablackboxtest,dependingontheframeworksavailableonthe device: • CydiaSubstrate: InstalltheAndroid-SSL-TrustKillerpackage. • Frida: Usethefrida-multiple-unpinningscript. • Objection: Usetheandroid sslpinning disablecommand. • Xposed: InstalltheTrustMeAlreadyorSSLUnpinningmodule. If you have a rooted device with frida-server installed, you can bypass SSL pinning by running the following Objection command(repackageyourappifyou’reusinganon-rooteddevice): androidsslpinningdisable Here’sanexampleoftheoutput: 127\\nFigure 1: objection Android SSL Pinning Bypass See also Objection’s help on Disabling SSL Pinning for Android for further information and inspect the pinning.ts file to understandhowthebypassworks. Bypass Custom Certificate Pinning Statically Somewhereintheapplication,boththeendpointandthecertificate(oritshash)mustbedefined. Afterdecompilingthe application,youcansearchfor: • Certificatehashes: grep-ri\"sha256\\|sha1\"./smali. Replacetheidentifiedhasheswiththehashofyourproxy’s CA.Alternatively,ifthehashisaccompaniedbyadomainname,youcantrymodifyingthedomainnametoanon- existingdomainsothattheoriginaldomainisnotpinned. ThisworkswellonobfuscatedOkHTTPimplementations. • Certificatefiles: find ./assets -type f \\( -iname \\*.cer -o -iname \\*.crt \\). Replacethesefileswithyour proxy’scertificates,makingsuretheyareinthecorrectformat. • Truststore files: find ./ -type f \\( -iname \\*.jks -o -iname \\*.bks \\). Add your proxy’s certificates to the truststoreandmakesuretheyareinthecorrectformat. Keep in mind that an app might contain files without extension. The most common file locations areassets and resdirectories,whichshouldalsobeinvestigated. As an example, let’s say that you find an application which uses a BKS (BouncyCastle) truststore and it’s stored in the file res/raw/truststore.bks. To bypass SSL Pinning you need to add your proxy’s certificate to the truststore with thecommandlinetoolkeytool. KeytoolcomeswiththeJavaSDKandthefollowingvaluesareneededtoexecutethe command: • password-Passwordforthekeystore. Lookinthedecompiledappcodeforthehardcodedpassword. • providerpath-LocationoftheBouncyCastleProviderjarfile. YoucandownloaditfromTheLegionoftheBouncy Castle. • proxy.cer-Yourproxy’scertificate. • aliascert-Uniquevaluewhichwillbeusedasaliasforyourproxy’scertificate. Toaddyourproxy’scertificateusethefollowingcommand: keytool -importcert -v-trustcacerts -file proxy.cer -alias aliascert -keystore \"res/raw/truststore.bks\" -provider ↪ org.bouncycastle.jce.provider.BouncyCastleProvider -providerpath \"providerpath/bcprov-jdk15on-164.jar\" -storetype BKS-storepass password TolistcertificatesintheBKStruststoreusethefollowingcommand: 128\\nkeytool-list-keystore\"res/raw/truststore.bks\"-providerorg.bouncycastle.jce.provider.BouncyCastleProvider-providerpath\"providerpath/bcprov-jdk15on-164.jar\" ↪ -storetype BKS-storepass password Aftermakingthesemodifications,repackagetheapplicationusingapktoolandinstallitonyourdevice. Iftheapplicationusesnativelibrariestoimplementnetworkcommunication,furtherreverseengineeringisneeded. An exampleofsuchanapproachcanbefoundintheblogpostIdentifyingtheSSLPinninglogicinsmalicode, patchingit, andreassemblingtheAPK Bypass Custom Certificate Pinning Dynamically Bypassingthepinninglogicdynamicallymakesitmoreconvenientasthereisnoneedtobypassanyintegritychecksand it’smuchfastertoperformtrial&errorattempts. Finding the correct method to hook is typically the hardest part and can take quite some time depending on the level of obfuscation. As developers typically reuse existing libraries, it is a good approach to search for strings and license filesthatidentifytheusedlibrary. Oncethelibraryhasbeenidentified,examinethenon-obfuscatedsourcecodetofind methodswhicharesuitedfordynamicinstrumentation. As an example, let’s say that you find an application which uses an obfuscated OkHTTP3 library. The documentation showsthattheCertificatePinner.Builderclassisresponsibleforaddingpinsforspecificdomains. Ifyoucanmodify theargumentstotheBuilder.addmethod,youcanchangethehashestothecorrecthashesbelongingtoyourcertificate. Findingthecorrectmethodcanbedoneineithertwoways,asexplainedinthisblogpostbyJeroenBeckers: • Searchforhashesanddomainnamesasexplainedintheprevioussection. Theactualpinningmethodwilltypically beusedordefinedincloseproximitytothesestrings • SearchforthemethodsignatureintheSMALIcode FortheBuilder.addmethod,youcanfindthepossiblemethodsbyrunningthefollowinggrepcommand: grep -ri java/ lang/String;\\[Ljava/lang/String;)L ./ This command will search for all methods that take a string and a variable list of strings as arguments, and return a complexobject. Dependingonthesizeoftheapplication,thismayhaveoneormultiplematchesinthecode. HookeachmethodwithFridaandprintthearguments. Oneofthemwillprintoutadomainnameandacertificatehash, afterwhichyoucanmodifytheargumentstocircumventtheimplementedpinning. Setting Up an Interception Proxy Platform: android SeveraltoolssupportthenetworkanalysisofapplicationsthatrelyontheHTTP(S)protocol. Themostimportanttoolsare theso-calledinterceptionproxies; OWASPZAPandBurpSuiteProfessionalarethemostfamous. Aninterceptionproxy givesthetesteraman-in-the-middleposition. Thispositionisusefulforreadingand/ormodifyingallapprequestsand endpointresponses,whichareusedfortestingAuthorization,Session,Management,etc. Interception Proxy for a Virtual Device Setting Up a Web Proxy on an Android Virtual Device (AVD) Thefollowingprocedure,whichworksontheAndroidemulatorthatshipswithAndroidStudio3.x,isforsettingupanHTTP proxyontheemulator: 1. Setupyourproxytolistenonlocalhostandforexampleport8080. 2. ConfiguretheHTTPproxyintheemulatorsettings: • Clickonthethreedotsintheemulatormenubar • OpentheSettingsMenu • ClickontheProxytab 129\\n• SelectManualproxyconfiguration • Enter“127.0.0.1”intheHostNamefieldandyourproxyportinthePortnumberfield(e.g.,“8080”) • TapApply HTTPandHTTPSrequestsshouldnowberoutedovertheproxyonthehostcomputer. Ifnot,trytogglingairplanemode offandon. AproxyforanAVDcanalsobeconfiguredonthecommandlinebyusingtheemulatorcommandwhenstartinganAVD. ThefollowingexamplestartstheAVDNexus_5X_API_23andsetsaproxyto127.0.0.1andport8080. emulator@Nexus_5X_API_23 -http-proxy 127.0.0.1:8080 Installing a CA Certificate on the", "metadata": {"doc_id": "OWASP_MASTG", "chunk_id": 66}}