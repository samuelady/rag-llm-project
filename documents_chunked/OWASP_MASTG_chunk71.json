{"text": "other= \"Iwanttobelieve\" main[1]cont Thisistheplaintextstringyou’relookingfor! Debugging with an IDE SettingupaprojectinanIDEwiththedecompiledsourcesisaneattrickthatallowsyoutosetmethodbreakpointsdirectly inthesourcecode. Inmostcases,youshouldbeabletosingle-stepthroughtheappandinspectthestateofvariables withtheGUI.Theexperiencewon’tbeperfect,it’snottheoriginalsourcecodeafterall,soyouwon’tbeabletosetline breakpointsandthingswillsometimessimplynotworkcorrectly. Thenagain,reversingcodeisnevereasy,andefficiently navigatinganddebuggingplainoldJavacodeisaprettyconvenientwayofdoingit. Asimilarmethodhasbeendescribed intheNetSPIblog. TosetupIDEdebugging,firstcreateyourAndroidprojectinIntelliJandcopythedecompiledJavasourcesintothesource folderasdescribedaboveinthe“ReviewingDecompiledJavaCode”section. Onthedevice, choosetheappasdebug apponthe“Developeroptions”(UnCrackableAppforAndroidLevel1inthistutorial),andmakesureyou’veswitchedon the“WaitForDebugger”feature. Onceyoutaptheappiconfromthelauncher,itwillbesuspendedin“WaitForDebugger”mode. 144\\nNowyoucansetbreakpointsandattachtotheappprocesswiththe“AttachDebugger”toolbarbutton. Notethatonlymethodbreakpointsworkwhendebugginganappfromdecompiledsources. Onceamethodbreakpoint isreached,you’llgetthechancetosinglestepduringthemethodexecution. 145\\nAfteryouchoosetheappfromthelist,thedebuggerwillattachtotheappprocessandyou’llreachthebreakpointthatwas setontheonCreatemethod. Thisapptriggersanti-debuggingandanti-tamperingcontrolswithintheonCreatemethod. That’swhysettingabreakpointontheonCreatemethodjustbeforetheanti-tamperingandanti-debuggingchecksare performedisagoodidea. Next, single-step through the onCreate method by clicking “Force Step Into” in Debugger view. The “Force Step Into” optionallowsyoutodebugtheAndroidframeworkfunctionsandcoreJavaclassesthatarenormallyignoredbydebug- gers. Once you “Force Step Into”, the debugger will stop at the beginning of the next method, which is the a method of the classsg.vantagepoint.a.c. 146\\nThismethodsearchesforthe“su”binarywithinalistofdirectories(/system/xbinandothers). Sinceyou’rerunningthe apponarooteddevice/emulator,youneedtodefeatthischeckbymanipulatingvariablesand/orfunctionreturnvalues. Youcanseethedirectorynamesinsidethe“Variables”windowbyclicking“StepOver”theDebuggerviewtostepinto andthroughtheamethod. StepintotheSystem.getenvmethodwiththe“ForceStepInto”feature. Afteryougetthecolon-separateddirectorynames,thedebuggercursorwillreturntothebeginningoftheamethod,not to the next executable line. This happens because you’re working on the decompiled code instead of the source code. Thisskippingmakesfollowingthecodeflowcrucialtodebuggingdecompiledapplications. Otherwise,identifyingthenext linetobeexecutedwouldbecomecomplicated. Ifyoudon’twanttodebugcoreJavaandAndroidclasses,youcanstepoutofthefunctionbyclicking“StepOut”inthe Debuggerview. Using“ForceStepInto”mightbeagoodideaonceyoureachthedecompiledsourcesand“StepOut”of thecoreJavaandAndroidclasses. Thiswillhelpspeedupdebuggingwhileyoukeepaneyeonthereturnvaluesofthe coreclassfunctions. 147\\nAfter the a method gets the directory names, it will search for the su binary within these directories. To defeat this check, step through the detection method and inspect the variable content. Once execution reaches a location where thesubinarywouldbedetected,modifyoneofthevariablesholdingthefilenameordirectorynamebypressingF2or right-clickingandchoosing“SetValue”. Onceyoumodifythebinarynameorthedirectoryname,File.existsshouldreturnfalse. 148\\nThisdefeatsthefirstrootdetectioncontroloftheapp. Theremaininganti-tamperingandanti-debuggingcontrolscanbe defeatedinsimilarwayssothatyoucanfinallyreachthesecretstringverificationfunctionality. Thesecretcodeisverifiedbythemethodaofclasssg.vantagepoint.uncrackable1.a. Setabreakpointonmethoda and“ForceStepInto”whenyoureachthebreakpoint. Then,single-stepuntilyoureachthecalltoString.equals. This iswhereuserinputiscomparedwiththesecretstring. Youcanseethesecretstringinthe“Variables”viewwhenyoureachtheString.equalsmethodcall. 149\\nDebugging Native Code NativecodeonAndroidispackedintoELFsharedlibrariesandrunsjustlikeanyothernativeLinuxprogram. Consequently, youcandebugitwithstandardtools(includingGDBandbuilt-inIDEdebuggerssuchasIDAPro)aslongastheysupport thedevice’sprocessorarchitecture(mostdevicesarebasedonARMchipsets,sothisisusuallynotanissue). You’llnowsetupyourJNIdemoapp,HelloWorld-JNI.apk,fordebugging. It’sthesameAPKyoudownloadedin“Statically AnalyzingNativeCode”. Useadb installtoinstallitonyourdeviceoronanemulator. adbinstallHelloWorld-JNI.apk If you followed the instructions at the beginning of this chapter, you should already have the Android NDK. It contains prebuiltversionsofgdbserverforvariousarchitectures. Copythegdbserverbinarytoyourdevice: 150\\nadbpush $NDK/prebuilt/android-arm/gdbserver/gdbserver/data/local/tmp The gdbserver --attach command causes gdbserver to attach to the running process and bind to the IP address and portspecifiedincomm,whichinthiscaseisaHOST:PORTdescriptor. StartHelloWorldJNIonthedevice,thenconnectto thedeviceanddeterminethePIDoftheHelloWorldJNIprocess(sg.vantagepoint.helloworldjni). Thenswitchtotheroot userandattachgdbserver: $adbshell $ps |grep helloworld u0_a164 12690201 153340051692ffffffff00000000Ssg.vantagepoint.helloworldjni $su ##/data/local/tmp/gdbserver--attachlocalhost:123412690 Attached;pid=12690 Listeningonport1234 Theprocessisnowsuspended,andgdbserverislisteningfordebuggingclientsonport1234. Withthedeviceconnected viaUSB,youcanforwardthisporttoalocalportonthehostwiththeabd forwardcommand: adbforwardtcp:1234tcp:1234 You’llnowusetheprebuiltversionofgdbincludedintheNDKtoolchain. $$TOOLCHAIN/bin/gdblibnative-lib.so GNUgdb (GDB)7.11 (...) Readingsymbolsfromlibnative-lib.so...(nodebuggingsymbolsfound)...done. (gdb)targetremote:1234 Remotedebuggingusing:1234 0xb6e0f124in ??() Youhavesuccessfullyattachedtotheprocess! Theonlyproblemisthatyou’realreadytoolatetodebugtheJNIfunction StringFromJNI;itonlyrunsonce, atstartup. Youcansolvethisproblembyactivatingthe“WaitforDebugger”option. GotoDeveloperOptions->SelectdebugappandpickHelloWorldJNI,thenactivatetheWaitfordebuggerswitch. Thenterminateandre-launchtheapp. Itshouldbesuspendedautomatically. OurobjectiveistosetabreakpointatthefirstinstructionofthenativefunctionJava_sg_vantagepoint_helloworldjni_- MainActivity_stringFromJNIbeforeresumingtheapp. Unfortunately,thisisn’tpossibleatthispointintheexecution becauselibnative-lib.soisn’tyetmappedintoprocessmemory,it’sloadeddynamicallyduringruntime. Togetthis working,you’llfirstusejdbtogentlychangetheprocessintothedesiredstate. First,resumeexecutionoftheJavaVMbyattachingjdb. Youdon’twanttheprocesstoresumeimmediatelythough,so pipethesuspendcommandintojdb: $adbjdwp 14342 $adbforwardtcp:7777jdwp:14342 ${echo \"suspend\";cat;}|jdb-attach localhost:7777 Next,suspendtheprocesswheretheJavaruntimeloadslibnative-lib.so. Injdb,setabreakpointatthejava.lang. System.loadLibrary method and resume the process. After the breakpoint has been reached, execute the step up command,whichwillresumetheprocessuntilloadLibraryreturns. Atthispoint,libnative-lib.sohasbeenloaded. >stop injava.lang.System.loadLibrary >resume Allthreadsresumed. Breakpointhit: \"thread=main\",java.lang.System.loadLibrary(),line=988bci=0 >stepup main[1]stepup > Stepcompleted: \"thread=main\",sg.vantagepoint.helloworldjni.MainActivity.<clinit>(),line=12 bci=5 main[1] Executegdbservertoattachtothesuspendedapp. ThiswillcausetheapptobesuspendedbyboththeJavaVMandthe Linuxkernel(creatingastateof“double-suspension”). 151\\n$adbforwardtcp:1234tcp:1234 $$TOOLCHAIN/arm-linux-androideabi-gdblibnative-lib.so GNUgdb (GDB)7.7 Copyright (C)2014FreeSoftwareFoundation,Inc. (...) (gdb)targetremote:1234 Remotedebuggingusing:1234 0xb6de83b8in ??() JNI Tracing Platform: android AsdetailedinsectionReviewingDisassembledNativeCode,thefirstargumentpassedtoeveryJNIfunctionisaJNIinter- facepointer. ThispointercontainsatableoffunctionsthatallowsnativecodetoaccesstheAndroidRuntime. Identifying callstothesefunctionscanhelpwithunderstandinglibraryfunctionality,suchaswhatstringsarecreatedorJavamethods arecalled. jnitraceisaFridabasedtoolsimilartofrida-tracewhichspecificallytargetstheusageofAndroid’sJNIAPIbynativelibraries, providingaconvenientwaytoobtainJNImethodtracesincludingargumentsandreturnvalues. Youcaneasilyinstallitbyrunningpip install jnitraceandrunitstraightawayasfollows: jnitrace -llibnative-lib.sosg.vantagepoint.helloworldjni The-loptioncanbeprovidedmultipletimestotracemultiplelibraries,or*canbeprovidedtotracealllibraries. This,however,mayprovidealotofoutput. IntheoutputyoucanseethetraceofacalltoNewStringUTFmadefromthenativecode(itsreturnvalueisthengiven backtoJavacode,seesection“ReviewingDisassembledNativeCode”formoredetails). Notehowsimilarlytofrida-trace, theoutputiscolorizedhelpingtovisuallydistinguishthedifferentthreads. When tracing JNI API calls you can see the thread ID at the top, followed by the JNI method call including the method name,theinputargumentsandthereturnvalue. InthecaseofacalltoaJavamethodfromnativecode,theJavamethod argumentswillalsobe supplied. Finallyjnitracewillattempt tousetheFridabacktracinglibrarytoshowwheretheJNI callwasmadefrom. Tolearnmoreaboutalloptionsforadvancedusage,checkthedocumentationonthejnitraceGitHubpage. Monitoring System Logs Platform: android OnAndroidyoucaneasilyinspectthelogofsystemmessagesbyusingLogcat. TherearetwowaystoexecuteLogcat: • LogcatispartofDalvikDebugMonitorServer (DDMS)inAndroidStudio. Iftheappisrunningindebugmode,the logoutputwillbeshownintheAndroidMonitorontheLogcattab. Youcanfiltertheapp’slogoutputbydefining patternsinLogcat. 152\\n• YoucanexecuteLogcatwithadbtostorethelogoutputpermanently: adblogcat >logcat.log Withthefollowingcommandyoucanspecificallygrepforthelogoutputoftheappinscope,justinsertthepackagename. OfcourseyourappneedstoberunningforpstobeabletogetitsPID. adblogcat |grep \"$(adbshellps |grep <package-name>|awk'{print$2}')\" Runtime Reverse Engineering Platform: android Runtimereverseengineeringcanbeseenastheon-the-flyversionofreverseengineeringwhereyoudon’thavethebinary datatoyourhostcomputer. Instead,you’llanalyzeitstraightfromthememoryoftheapp. We’llkeepusingtheHelloWorldJNIapp,openasessionwithr2fridar2frida://usb//sg.vantagepoint.helloworldjni andyoucanstartbydisplayingthetargetbinaryinformationbyusingthe:icommand: [0x00000000]>:i arch arm bits 64 os linux pid 13215 uid 10096 objc false runtime V8 java true cylang false pageSize 4096 pointerSize 8 codeSigningPolicy optional isDebuggerAttached false cwd / dataDir /data/user/0/sg.vantagepoint.helloworldjni codeCacheDir /data/user/0/sg.vantagepoint.helloworldjni/code_cache extCacheDir /storage/emulated/0/Android/data/sg.vantagepoint.helloworldjni/cache obbDir /storage/emulated/0/Android/obb/sg.vantagepoint.helloworldjni filesDir /data/user/0/sg.vantagepoint.helloworldjni/files noBackupDir /data/user/0/sg.vantagepoint.helloworldjni/no_backup codePath /data/app/sg.vantagepoint.helloworldjni-1/base.apk packageName sg.vantagepoint.helloworldjni androidId c92f43af46f5578d cacheDir /data/local/tmp jniEnv 0x7d30a43c60 Searchallsymbolsofacertainmodulewith:is <lib>,e.g.:is libnative-lib.so. [0x00000000]>\\islibnative-lib.so [0x00000000]> 153\\nWhich are empty in this case. Alternatively, you might prefer to look into the imports/exports. For example, list the importswith:ii <lib>: [0x00000000]>:iilibnative-lib.so 0x7dbe1159d0f__cxa_finalize/system/lib64/libc.so 0x7dbe115868f__cxa_atexit/system/lib64/libc.so Andlisttheexportswith:iE <lib>: [0x00000000]>:iElibnative-lib.so 0x7d1c49954cfJava_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI Forbigbinariesit’srecommendedtopipetheoutputtotheinternallessprogrambyappending~..,i.e.\\iiliban- droid_runtime.so~.. (ifnot,forthisbinary,you’dgetalmost2500linesprintedtoyourterminal). ThenextthingyoumightwanttolookatarethecurrentlyloadedJavaclasses: [0x00000000]>\\ic~sg.vantagepoint.helloworldjni sg.vantagepoint.helloworldjni.MainActivity Listclassfields:", "metadata": {"doc_id": "OWASP_MASTG", "chunk_id": 71}}