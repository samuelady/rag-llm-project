{"text": "Be Rooted Virtually any Android mobile can be rooted. Commercial versions of Android OS (which are Linux OS evolutions at the kernellevel)areoptimizedforthemobileworld. Somefeatureshavebeenremovedordisabledfortheseversions, for example,non-privilegedusers’abilitytobecomethe‘root’user(whohaselevatedprivileges). Rootingaphonemeans allowinguserstobecometherootuser,e.g.,addingastandardLinuxexecutablecalledsu,whichisusedtochangeto anotheruseraccount. Torootamobiledevice,firstunlockitsbootloader. Theunlockingproceduredependsonthedevicemanufacturer. How- ever,forpracticalreasons,rootingsomemobiledevicesismorepopularthanrootingothers,particularlywhenitcomesto securitytesting: devicescreatedbyGoogleandmanufacturedbycompanieslikeSamsung,LG,andMotorolaareamong themostpopular,particularlybecausetheyareusedbymanydevelopers. Thedevicewarrantyisnotnullifiedwhenthe bootloaderisunlockedandGoogleprovidesmanytoolstosupporttherootitself. 110\\nRooting with Magisk Magisk(“MagicMask”)isonewaytorootyourAndroiddevice. Itsspecialtyliesinthewaythemodificationsonthesystem areperformed. Whileotherrootingtoolsaltertheactualdataonthesystempartition,Magiskdoesnot(whichiscalled “systemless”). Thisenablesawaytohidethemodificationsfromroot-sensitiveapplications(e.g.forbankingorgames) andallowsusingtheofficialAndroidOTAupgradeswithouttheneedtounrootthedevicebeforehand. YoucangetfamiliarwithMagiskreadingtheofficialdocumentationonGitHub. Ifyoudon’thaveMagiskinstalled,youcan findinstallationinstructionsinthedocumentation. IfyouuseanofficialAndroidversionandplantoupgradeit,Magisk providesatutorialonGitHub. Furthermore,developerscanusethepowerofMagisktocreatecustommodulesandsubmitthemtotheofficialMagisk Modules repository. Submitted modules can then be installed inside the Magisk Manager application. One of these installablemodulesisasystemlessversionofthefamousXposedFramework(availableforSDKversionsupto27). Root Detection Anextensivelistofrootdetectionmethodsispresentedinthe“TestingAnti-ReversingDefensesonAndroid”chapter. Foratypicalmobileappsecuritybuild, you’llusuallywanttotestadebugbuildwithrootdetectiondisabled. Ifsucha buildisnotavailablefortesting, youcandisablerootdetectioninavarietyofwaysthatwillbeintroducedlaterinthis book. Installing Apps Platform: android Useadb installtoinstallanAPKonanemulatororconnecteddevice. adbinstallpath_to_apk NotethatifyouhavetheoriginalsourcecodeanduseAndroidStudio,youdonotneedtodothisbecauseAndroidStudio handlesthepackagingandinstallationoftheappforyou. Obtaining and Extracting Apps Platform: android There are several ways of extracting APK files from a device. You will need to decide which one is the easiest method dependingiftheappispublicorprivate. Alternative App Stores One of the easiest options is to download the APK from websites that mirror public applications from the Google Play Store. However,keepinmindthatthesesitesarenotofficialandthereisnoguaranteethattheapplicationhasn’tbeen repackagedorcontainmalware. AfewreputablewebsitesthathostAPKsandarenotknownformodifyingappsandeven listSHA-1andSHA-256checksumsoftheappsare: • APKMirror • APKPure Beware that you do not have control over these sites and you cannot guarantee what they do in the future. Only use themifit’syouronlyoptionleft. 111\\nUsing gplaycli Youcanusegplayclitodownload(-d)theselectedAPKbyspecifyingitsAppID(add-ptoshowaprogressbarand-vfor verbosity): $gplaycli -p-v-dcom.google.android.keep [INFO]GPlayCliversion3.26 [Python3.7.4] [INFO]Configurationfileis~/.config/gplaycli/gplaycli.conf [INFO]Deviceisbacon [INFO]Usingcachedtoken. [INFO]UsingautoretrievedtokentoconnecttoAPI [INFO]1/1com.google.android.keep [################################]15.78MB/15.78MB -00:00:026.57MB/s/s [INFO]Downloadcomplete Thecom.google.android.keep.apkfilewillbeinyourcurrentdirectory. Asyoumightimagine,thisapproachisavery convenientwaytodownloadAPKs,especiallywithregardstoautomation. YoumayuseyourownGooglePlaycredentialsortoken. Bydefault,gplaycliwilluseaninternallyprovidedtoken. Extracting the App Package from the Device Obtainingapppackagesfromthedeviceistherecommendedmethodaswecanguaranteetheapphasn’tbeenmodified byathird-party. Toobtainapplicationsfromarootedornon-rooteddevice,youcanusethefollowingmethods: UseadbpulltoretrievetheAPK.Ifyoudon’tknowthepackagename,thefirststepistolistalltheapplicationsinstalled onthedevice: adbshellpmlistpackages Onceyouhavelocatedthepackagenameoftheapplication,youneedthefullpathwhereitisstoredonthesystemto downloadit. adbshellpmpath <packagename> WiththefullpathtotheAPK,youcannowsimplyuseadb pulltoextractit. adbpull <apkpath> TheAPKwillbedownloadedinyourworkingdirectory. Alternatively, there are also apps like APK Extractor that do not require root and can even share the extracted APK via yourpreferredmethod. Thiscanbeusefulifyoudon’tfeellikeconnectingthedeviceorsettingupadboverthenetwork totransferthefile. Testing Instant Apps With Google Play Instant you can create Instant apps which can be instantly launched from a browser or the “try now” buttonfromtheappstorefromAndroid5.0(APIlevel21)onward. Theydonotrequireanyformofinstallation. Thereare afewchallengeswithaninstantapp: • Thereisalimitedamountofsizeyoucanhavewithaninstantapp. • Onlyareducednumberofpermissionscanbeused,whicharedocumentedatAndroidInstantappdocumentation. Thecombinationofthesecanleadtoinsecuredecisions,suchas:strippingtoomuchoftheauthorization/authentication/confidentiality logicfromanapp,whichallowsforinformationleakage. Note: InstantappsrequireanAppBundle. AppBundlesaredescribedinthe“AppBundles”sectionofthe“AndroidPlatform Overview”chapter. StaticAnalysisConsiderations: 112\\nStaticanalysiscanbeeitherdoneafterreverseengineeringadownloadedinstantapp,orbyanalyzingtheAppBundle. WhenyouanalyzetheAppBundle,checktheAndroidManifesttoseewhetherdist:moduledist:instant=\"true\"isset foragivenmodule(eitherthebaseoraspecificmodulewithdist:moduleset). Next,checkforthevariousentrypoints, whichentrypointsareset(bymeansof<data android:path=\"</PATH/HERE>\" />). Nowfollowtheentrypoints,likeyouwoulddoforanyActivityandcheck: • Isthereanydataretrievedbytheappwhichshouldrequireprivacyprotectionofthatdata? Ifso,areallrequired controlsinplace? • Areallcommunicationssecured? • Whenyouneedmorefunctionalities,aretherightsecuritycontrolsdownloadedaswell? DynamicAnalysisConsiderations: Therearemultiplewaystostartthedynamicanalysisofyourinstantapp. Inallcases, youwillfirsthavetoinstallthe supportforinstantappsandaddtheiaexecutabletoyour$PATH. Theinstallationofinstantappsupportistakencareoffthroughthefollowingcommand: cdpath/to/android/sdk/tools/bin && ./sdkmanager 'extras;google;instantapps' Next,youhavetoaddpath/to/android/sdk/extras/google/instantapps/iatoyour$PATH. Afterthepreparation, youcantestinstantappslocallyonadevicerunningAndroid8.1(APIlevel27)orlater. Theapp canbetestedindifferentways: • Testtheapplocally: DeploytheappviaAndroidStudio(andenabletheDeploy as instant appcheckboxinthe Run/Configurationdialog)ordeploytheappusingthefollowingcommand: iarun output-from-build-command <app-artifact> • TesttheappusingthePlayConsole: 1. UploadyourAppBundletotheGooglePlayConsole 2. Preparetheuploadedbundleforareleasetotheinternaltesttrack. 3. Signintoaninternaltesteraccountonadevice,thenlaunchyourinstantexperiencefromeitheranexternal preparedlinkorviathetry nowbuttonintheAppstorefromthetestersaccount. Nowthatyoucantesttheapp,checkwhether: • Thereareanydatawhichrequireprivacycontrolsandwhetherthesecontrolsareinplace. • Allcommunicationsaresufficientlysecured. • Whenyouneedmorefunctionalities,aretherightsecuritycontrolsdownloadedaswellforthesefunctionalities? Exploring the App Package Platform: android Onceyouhavecollectedthepackagenameoftheapplicationyouwanttotarget,you’llwanttostartgatheringinformation aboutit. First,retrievetheAPKasexplainedin“BasicTestingOperations-ObtainingandExtractingApps”. APK files are actually ZIP files that can be unpacked using a standard decompression utility such as unzip. However, we recommend using apktool which additionally decodes the AndroidManifest.xml and disassembles the app binaries (classes.dex)tosmalicode: $apktooldUnCrackable-Level3.apk $tree . ├──AndroidManifest.xml ├──apktool.yml ├──lib ├──original │ ├──AndroidManifest.xml │ └──META-INF │ ├──CERT.RSA │ ├──CERT.SF 113\\n│ └──MANIFEST.MF ├──res ... └──smali Thefollowingfilesareunpacked: • AndroidManifest.xml: containsthedefinitionoftheapp’spackagename, targetandminimumAPIlevel,appcon- figuration,appcomponents,permissions,etc. • original/META-INF:containstheapp’smetadata – MANIFEST.MF:storeshashesoftheappresources – CERT.RSA:theapp’scertificate(s) – CERT.SF:listofresourcesandtheSHA-1digestofthecorrespondinglinesintheMANIFEST.MFfile • assets: directorycontainingappassets(filesusedwithintheAndroidapp,suchasXMLfiles,JavaScriptfiles,and pictures),whichtheAssetManagercanretrieve • classes.dex: classescompiledintheDEXfileformat,thatDalvikvirtualmachine/AndroidRuntimecanprocess. DEX isJavabytecodefortheDalvikVirtualMachine. Itisoptimizedforsmalldevices • lib: directorycontaining3rdpartylibrariesthatarepartoftheAPK • res: directorycontainingresourcesthathaven’tbeencompiledintoresources.arsc • resources.arsc: filecontainingprecompiledresources,suchasXMLfilesforthelayout AsunzippingwiththestandardunziputilityleavessomefilessuchastheAndroidManifest.xmlunreadable,it’sbetter tounpacktheAPKusingapktool. $ls -alh total32 drwxr-xr-x 9sven staff 306BDec 516:29. drwxr-xr-x 5sven staff 170BDec 516:29.. -rw-r--r-- 1sven staff 10KDec 516:29AndroidManifest.xml -rw-r--r-- 1sven staff 401BDec 516:29apktool.yml drwxr-xr-x 6sven staff 204BDec 516:29assets drwxr-xr-x 3sven staff 102BDec 516:29lib drwxr-xr-x 4sven staff 136BDec 516:29original drwxr-xr-x 131sven staff 4.3KDec 516:29res drwxr-xr-x 9sven staff 306BDec 516:29smali The Android Manifest TheAndroidManifestisthemainsourceofinformation, itincludesalotofinterestinginformationsuchasthepackage name,thepermissions,appcomponents,etc. Here’sanon-exhaustivelistofsomeinfoandthecorrespondingkeywordsthatyoucaneasilysearchforintheAndroid Manifestbyjustinspectingthefileorbyusinggrep -i <keyword> AndroidManifest.xml: • Apppermissions: permission(see“AndroidPlatformAPIs”) • Backupallowance: android:allowBackup(see“DataStorageonAndroid •", "metadata": {"doc_id": "OWASP_MASTG", "chunk_id": 62}}