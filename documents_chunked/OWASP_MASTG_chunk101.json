{"text": "Permissions Check permissions to make sure that the app really needs them and remove unnecessary permissions. For example, theINTERNETpermissionintheAndroidManifest.xmlfileisnecessaryforanActivitytoloadawebpageintoaWebView. Becauseausercanrevokeanapplication’srighttouseadangerouspermission,thedevelopershouldcheckwhetherthe applicationhastheappropriatepermissioneachtimeanactionisperformedthatwouldrequirethatpermission. 261\\n<uses-permission android:name=\"android.permission.INTERNET\" /> Gothroughthepermissionswiththedevelopertoidentifythepurposeofeverypermissionsetandremoveunnecessary permissions. BesidesgoingthroughtheAndroidManifest.xmlfilemanually, youcanalsousetheAndroidAssetPackagingtool(aapt) toexaminethepermissionsofanAPKfile. aaptcomeswiththeAndroidSDKwithinthebuild-toolsfolder. ItrequiresanAPKfileasinput. YoumaylisttheAPKs inthedevicebyrunningadb shell pm list packages -f | grep -i <keyword>asseenin“ListingInstalledApps”. $aaptdpermissionsapp-x86-debug.apk package:sg.vp.owasp_mobile.omtg_android uses-permission:name='android.permission.WRITE_EXTERNAL_STORAGE' uses-permission:name='android.permission.INTERNET' Alternativelyyoumayobtainamoredetailedlistofpermissionsviaadbandthedumpsystool: $adbshelldumpsyspackagesg.vp.owasp_mobile.omtg_android |grep permission requestedpermissions: android.permission.WRITE_EXTERNAL_STORAGE android.permission.INTERNET android.permission.READ_EXTERNAL_STORAGE install permissions: android.permission.INTERNET:granted=true runtimepermissions: Pleasereferencethispermissionsoverviewfordescriptionsofthelistedpermissionsthatareconsidereddangerous. READ_CALENDAR WRITE_CALENDAR READ_CALL_LOG WRITE_CALL_LOG PROCESS_OUTGOING_CALLS CAMERA READ_CONTACTS WRITE_CONTACTS GET_ACCOUNTS ACCESS_FINE_LOCATION ACCESS_COARSE_LOCATION RECORD_AUDIO READ_PHONE_STATE READ_PHONE_NUMBERS CALL_PHONE ANSWER_PHONE_CALLS ADD_VOICEMAIL USE_SIP BODY_SENSORS SEND_SMS RECEIVE_SMS READ_SMS RECEIVE_WAP_PUSH RECEIVE_MMS READ_EXTERNAL_STORAGE WRITE_EXTERNAL_STORAGE Custom Permissions Apartfromenforcingcustompermissionsviatheapplicationmanifestfile,youcanalsocheckpermissionsprogrammat- ically. This is not recommended, however, because it is more error-prone and can be bypassed more easily with, e.g., runtimeinstrumentation. ItisrecommendedthattheContextCompat.checkSelfPermissionmethodiscalledtocheck if an activity has a specified permission. Whenever you see code like the following snippet, make sure that the same permissionsareenforcedinthemanifestfile. private static final StringTAG =\"LOG\"; intcanProcess =checkCallingOrSelfPermission(\"com.example.perm.READ_INCOMING_MSG\"); if(canProcess !=PERMISSION_GRANTED) throw newSecurityException(); OrwithContextCompat.checkSelfPermissionwhichcomparesittothemanifestfile. 262\\nif(ContextCompat.checkSelfPermission(secureActivity.this,Manifest.READ_INCOMING_MSG) !=PackageManager.PERMISSION_GRANTED){ //!=standsfornotequalsPERMISSION_GRANTED Log.v(TAG,\"Permissiondenied\"); } Requesting Permissions Ifyourapplicationhaspermissionsthatneedtoberequestedatruntime,theapplicationmustcalltherequestPermis- sionsmethodinordertoobtainthem. Theapppassesthepermissionsneededandanintegerrequestcodeyouhave specifiedtotheuserasynchronously,returningoncetheuserchoosestoacceptordenytherequestinthesamethread. Aftertheresponseisreturnedthesamerequestcodeispassedtotheapp’scallbackmethod. private static final StringTAG =\"LOG\"; //WestartbycheckingthepermissionofthecurrentActivity if(ContextCompat.checkSelfPermission(secureActivity.this, Manifest.permission.WRITE_EXTERNAL_STORAGE) !=PackageManager.PERMISSION_GRANTED){ //Permissionisnotgranted //Shouldweshowanexplanation? if(ActivityCompat.shouldShowRequestPermissionRationale(secureActivity.this, //GetswhetheryoushouldshowUIwithrationaleforrequestingpermission. //Youshoulddothisonlyifyoudonothavepermissionandthepermissionrequestedrationaleisnotcommunicatedclearly totheuser. Manifest.permission.WRITE_EXTERNAL_STORAGE)){ //Asynchronousthreadwaitsfortheusersresponse. //Aftertheuserseestheexplanationtryrequestingthepermissionagain. }else { //Requestapermissionthatdoesn'tneedtobeexplained. ActivityCompat.requestPermissions(secureActivity.this, newString[]{Manifest.permission.WRITE_EXTERNAL_STORAGE}, MY_PERMISSIONS_REQUEST_WRITE_EXTERNAL_STORAGE); //MY_PERMISSIONS_REQUEST_WRITE_EXTERNAL_STORAGEwillbetheapp-definedintconstant. //Thecallbackmethodgetstheresultoftherequest. } }else { //Permissionalreadygranteddebugmessageprintedinterminal. Log.v(TAG,\"Permissionalreadygranted.\"); } Pleasenotethatifyouneedtoprovideanyinformationorexplanationtotheuseritneedstobedonebeforethecallto requestPermissions,sincethesystemdialogboxcannotbealteredoncecalled. Handling Responses to Permission Requests NowyourapphastooverridethesystemmethodonRequestPermissionsResulttoseeifthepermissionwasgranted. ThismethodreceivestherequestCodeintegerasinputparameter(whichisthesamerequestcodethatwascreatedin requestPermissions). ThefollowingcallbackmethodmaybeusedforWRITE_EXTERNAL_STORAGE. @Override //NeededtooverridesystemmethodonRequestPermissionsResult() public void onRequestPermissionsResult(intrequestCode,//requestCodeiswhatyouspecifiedinrequestPermissions() Stringpermissions[],int[]permissionResults){ switch (requestCode){ case MY_PERMISSIONS_WRITE_EXTERNAL_STORAGE:{ if(grantResults.length >0 && permissionResults[0]==PackageManager.PERMISSION_GRANTED){ //0isacanceledrequest,ifintarrayequalsrequestCodepermissionisgranted. }else { //permissiondeniedcodegoeshere. Log.v(TAG,\"Permissiondenied\"); } return; } //Otherswitchcasescanbeaddedhereformultiplepermissionchecks. } } Permissionsshouldbeexplicitlyrequestedforeveryneededpermission,evenifasimilarpermissionfromthesamegroup has already been requested. For applications targeting Android 7.1 (API level 25) and older, Android will automatically giveanapplicationallthepermissionsfromapermissiongroup, iftheusergrantsoneoftherequestedpermissionsof thatgroup. StartingwithAndroid8.0(APIlevel26),permissionswillstillautomaticallybegrantedifauserhasalready 263\\ngrantedapermissionfromthesamepermissiongroup,buttheapplicationstillneedstoexplicitlyrequestthepermission. Inthiscase,theonRequestPermissionsResulthandlerwillautomaticallybetriggeredwithoutanyuserinteraction. ForexampleifbothREAD_EXTERNAL_STORAGEandWRITE_EXTERNAL_STORAGEarelistedintheAndroidManifestbutonly permissionsaregrantedforREAD_EXTERNAL_STORAGE,thenrequestingWRITE_EXTERNAL_STORAGEwillautomaticallyhave permissionswithoutuserinteractionbecausetheyareinthesamegroupandnotexplicitlyrequested. Permission Analysis Alwayscheckwhethertheapplicationisrequestingpermissionsitactuallyrequires. Makesurethatnopermissionsare requestedwhicharenotrelatedtothegoaloftheapp,especiallyDANGEROUSandSIGNATUREpermissions,sincetheycan affectboththeuserandtheapplicationifmishandled. Forinstance,itshouldbesuspiciousifasingle-playergameapp requiresaccesstoandroid.permission.WRITE_SMS. Whenanalyzingpermissions,youshouldinvestigatetheconcreteusecasescenariosoftheappandalwayscheckifthere arereplacementAPIsforanyDANGEROUSpermissionsinuse. AgoodexampleistheSMSRetrieverAPIwhichstreamlines the usage of SMS permissions when performing SMS-based user verification. By using this API an application does not havetodeclareDANGEROUSpermissionswhichisabenefittoboththeuseranddevelopersoftheapplication,whodoesn’t havetosubmitthePermissionsDeclarationForm. Dynamic Analysis Permissionsforinstalledapplicationscanberetrievedwithadb. Thefollowingextractdemonstrateshowtoexaminethe permissionsusedbyanapplication. $adbshelldumpsyspackagecom.google.android.youtube ... declaredpermissions: com.google.android.youtube.permission.C2D_MESSAGE:prot=signature,INSTALLED requestedpermissions: android.permission.INTERNET android.permission.ACCESS_NETWORK_STATE install permissions: com.google.android.c2dm.permission.RECEIVE:granted=true android.permission.USE_CREDENTIALS:granted=true com.google.android.providers.gsf.permission.READ_GSERVICES:granted=true ... Theoutputshowsallpermissionsusingthefollowingcategories: • declaredpermissions: listofallcustompermissions. • requested and install permissions: list of all install-time permissions including normal and signature permis- sions. • runtimepermissions: listofalldangerouspermissions. Whendoingthedynamicanalysis: • Evaluatewhethertheappreallyneedstherequestedpermissions. Forinstance: asingle-playergamethatrequires accesstoandroid.permission.WRITE_SMS,mightnotbeagoodidea. • Inmanycasestheappcouldoptforalternativestodeclaringpermissions,suchas: – requestingtheACCESS_COARSE_LOCATIONpermissioninsteadofACCESS_FINE_LOCATION.Orevenbetternot requestingthepermissionatall,andinsteadasktheusertoenterapostalcode. – invokingtheACTION_IMAGE_CAPTUREorACTION_VIDEO_CAPTUREintentactioninsteadofrequestingtheCAM- ERApermission. – usingCompanionDevicePairing(Android8.0(APIlevel26)andhigher)whenpairingwithaBluetoothdevice instead of declaring the ACCESS_FINE_LOCATION, ACCESS_COARSE_LOCATIION, or BLUETOOTH_ADMIN permis- sions. • UsethePrivacyDashboard(Android12(APIlevel31)andhigher)toverifyhowtheappexplainsaccesstosensitive information. ToobtaindetailaboutaspecificpermissionyoucanrefertotheAndroidDocumentation. 264\\nChecking for Sensitive Data Disclosure Through the User Interface Platform: android MASVSV1: MSTG-STORAGE-7 MASVSV2: MASVS-PLATFORM-3 Overview Static Analysis CarefullyreviewallUIcomponentsthateithershowsuchinformationortakeitasinput. Searchforanytracesofsensitive informationandevaluateifitshouldbemaskedorcompletelyremoved. Text Fields Tomake sure an application is masking sensitive user input, check for the following attribute in the definition ofEdit- Text: android:inputType=\"textPassword\" Withthissetting,dots(insteadoftheinputcharacters)willbedisplayedinthetextfield,preventingtheappfromleaking passwordsorpinstotheuserinterface. App Notifications Whenstaticallyassessinganapplication,itisrecommendedtosearchforanyusageoftheNotificationManagerclass whichmightbeanindicationofsomeformofnotificationmanagement. Iftheclassisbeingused,thenextstepwouldbe tounderstandhowtheapplicationisgeneratingthenotifications. ThesecodelocationscanbefedintotheDynamicAnalysissectionbelow,providinganideaofwhereintheapplication notificationsmaybedynamicallygenerated. Dynamic Analysis Todeterminewhethertheapplicationleaksanysensitiveinformationtotheuserinterface,runtheapplicationandidentify componentsthatcouldbedisclosinginformation. Text Fields Iftheinformationismaskedby,forexample,replacinginputwithasterisksordots,theappisn’tleakingdatatotheuser interface. App Notifications Toidentifytheusageofnotificationsrunthroughtheentireapplicationandallitsavailablefunctionslookingforwaysto trigger any notifications. Consider that you may need to perform actions outside of the application in order to trigger certainnotifications. While running the application you may want to start tracing all calls to functions related to the notifications creation, e.g.setContentTitleorsetContentTextfromNotificationCompat.Builder. Observethetraceintheendandevalu- ateifitcontainsanysensitiveinformation. Finding Sensitive Information in Auto-Generated Screenshots 265\\nPlatform: android MASVSV1: MSTG-STORAGE-9 MASVSV2: MASVS-PLATFORM-3 Overview Static Analysis A screenshot of the current activity is taken when an Android app goes into background and displayed for aesthetic purposeswhentheappreturnstotheforeground. However,thismayleaksensitiveinformation. Todeterminewhethertheapplicationmayexposesensitiveinformationviatheappswitcher,findoutwhethertheFLAG_- SECUREoptionhasbeenset. Youshouldfindsomethingsimilartothefollowingcodesnippet: ExampleinJava: getWindow().setFlags(WindowManager.LayoutParams.FLAG_SECURE, WindowManager.LayoutParams.FLAG_SECURE); setContentView(R.layout.activity_main);", "metadata": {"doc_id": "OWASP_MASTG", "chunk_id": 101}}