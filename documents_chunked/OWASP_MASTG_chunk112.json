{"text": "Overview General Disclaimer Thelackofanyofthesemeasuresdoesnotcauseavulnerability-instead,theyaremeanttoincreasetheapp’s resilienceagainstreverseengineeringandspecificclient-sideattacks. None of these measures can assure a 100% effectiveness, as the reverse engineer will always have full access to the deviceandwillthereforealwayswin(givenenoughtimeandresources)! Forexample,preventingdebuggingisvirtuallyimpossible. Iftheappispubliclyavailable,itcanberunonanuntrusted devicethatisunderfullcontroloftheattacker. Averydeterminedattackerwilleventuallymanagetobypassalltheapp’s anti-debuggingcontrolsbypatchingtheappbinaryorbydynamicallymodifyingtheapp’sbehavioratruntimewithtools suchasFrida. You can learn more about principles and technical risks of reverse engineering and code modification in these OWASP documents: • OWASPArchitecturalPrinciplesThatPreventCodeModificationorReverseEngineering • OWASPTechnicalRisksofReverseEngineeringandUnauthorizedCodeModification Root Detection and Common Root Detection Methods In the context of anti-reversing, the goal of root detection is to make running the app on a rooted device a bit more difficult,whichinturnblockssomeofthetoolsandtechniquesreverseengineersliketouse. Likemostotherdefenses, rootdetectionisnotveryeffectivebyitself,butimplementingmultiplerootchecksthatarescatteredthroughouttheapp canimprovetheeffectivenessoftheoverallanti-tamperingscheme. ForAndroid,wedefine“rootdetection”abitmorebroadly,includingcustomROMsdetection,i.e.,determiningwhether thedeviceisastockAndroidbuildoracustombuild. Inthefollowingsection,welistsomecommonrootdetectionmethodsyou’llencounter. You’llfindsomeofthesemethods implementedintheOWASPUnCrackableAppsforAndroidthataccompanytheOWASPMobileTestingGuide. RootdetectioncanalsobeimplementedthroughlibrariessuchasRootBeer. SafetyNet SafetyNet is an Android API that provides a set of services and creates profiles of devices according to software and hardwareinformation. ThisprofileisthencomparedtoalistofaccepteddevicemodelsthathavepassedAndroidcompat- ibilitytesting. Googlerecommendsusingthefeatureas“anadditionalin-depthdefensesignalaspartofananti-abuse system”. How exactly SafetyNet works is not well documented and may change at any time. When you call this API, SafetyNet downloadsabinarypackagecontainingthedevicevalidationcodeprovidedfromGoogle,andthecodeisthendynamically executedviareflection. AnanalysisbyJohnKozyrakisshowedthatSafetyNetalsoattemptstodetectwhetherthedevice isrooted,butexactlyhowthat’sdeterminedisunclear. To use the API, an app may call the SafetyNetApi.attest method (which returns a JWS message with the Attestation Result)andthencheckthefollowingfields: • ctsProfileMatch: If‘true’,thedeviceprofilematchesoneofGoogle’slisteddevices. • basicIntegrity: If‘true’,thedevicerunningtheapplikelyhasn’tbeentamperedwith. • nonces: Tomatchtheresponsetoitsrequest. • timestampMs: Tocheckhowmuchtimehaspassedsinceyoumadetherequestandyougottheresponse. Adelayed responsemaysuggestsuspiciousactivity. • apkPackageName,apkCertificateDigestSha256,apkDigestSha256: ProvideinformationabouttheAPK,whichis usedtoverifytheidentityofthecallingapp. TheseparametersareabsentiftheAPIcannotreliablydeterminethe APKinformation. 301\\nThefollowingisasampleattestationresult: { \"nonce\":\"R2Rra24fVm5xa2Mg\", \"timestampMs\":9860437986543, \"apkPackageName\":\"com.package.name.of.requesting.app\", \"apkCertificateDigestSha256\":[\"base64encoded,SHA-256hashofthe certificateusedtosignrequestingapp\"], \"apkDigestSha256\":\"base64encoded,SHA-256hashoftheapp'sAPK\", \"ctsProfileMatch\":true, \"basicIntegrity\":true, } ctsProfileMatch Vs basicIntegrity TheSafetyNetAttestationAPIinitiallyprovidedasinglevaluecalledbasicIntegritytohelpdevelopersdeterminethe integrityofadevice. AstheAPIevolved,Googleintroducedanew,strictercheckwhoseresultsappearinavaluecalled ctsProfileMatch,whichallowsdeveloperstomorefinelyevaluatethedevicesonwhichtheirappisrunning. In broad terms, basicIntegrity gives you a signal about the general integrity of the device and its API. Many Rooted devicesfailbasicIntegrity,asdoemulators,virtualdevices,anddeviceswithsignsoftampering,suchasAPIhooks. On the other hand, ctsProfileMatch gives you a much stricter signal about the compatibility of the device. Only un- modifieddevicesthathavebeencertifiedbyGooglecanpassctsProfileMatch. DevicesthatwillfailctsProfileMatch includethefollowing: • DevicesthatfailbasicIntegrity • Deviceswithanunlockedbootloader • Deviceswithacustomsystemimage(customROM) • Devicesforwhichthemanufacturerdidn’tapplyfor,orpass,Googlecertification • DeviceswithasystemimagebuiltdirectlyfromtheAndroidOpenSourceProgramsourcefiles • Devices with a system image distributed as part of a beta or developer preview program (including the Android BetaProgram) Recommendations when using SafetyNetApi.attest • Createalarge(16bytesorlonger)randomnumberonyourserverusingacryptographically-securerandomfunction sothatamalicioususercannotreuseasuccessfulattestationresultinplaceofanunsuccessfulresult • TrustAPKinformation(apkPackageName,apkCertificateDigestSha256andapkDigestSha256)onlyifthevalueof ctsProfileMatchistrue. • The entire JWS response should be sent to your server, using a secure connection, for verification. It isn’t rec- ommended to perform the verification directly in the app because, in that case, there is no guarantee that the verificationlogicitselfhasn’tbeenmodified. • TheverifymethodonlyvalidatesthattheJWSmessagewassignedbySafetyNet. Itdoesn’tverifythatthepayload oftheverdictmatchesyourexpectations. Asusefulasthisservicemayseem,itisdesignedfortestpurposesonly, andithasverystrictusagequotasof10,000requestsperday,perprojectwhichwillnotbeincreaseduponrequest. Hence, you should refer SafetyNet Verification Samples and implement the digital signature verification logic on yourserverinawaythatitdoesn’tdependonGoogle’sservers. • The SafetyNet AttestationAPI gives you a snapshot of the state of a device at the moment when the attestation requestwasmade. Asuccessfulattestationdoesn’tnecessarilymeanthatthedevicewouldhavepassedattestation inthepast,orthatitwillinthefuture. It’srecommendedtoplanastrategytousetheleastamountofattestations requiredtosatisfytheusecase. • TopreventinadvertentlyreachingyourSafetyNetApi.attestquotaandgettingattestationerrors,youshouldbuild a system that monitors your usage of the API and warns you well before you reach your quota so you can get it increased. You should also be prepared to handle attestation failures because of an exceeded quota and avoid blockingallyourusersinthissituation. Ifyouareclosetoreachingyourquota,orexpectashort-termspikethat mayleadyoutoexceedyourquota,youcansubmitthisformtorequestshortorlong-termincreasestothequota foryourAPIkey. Thisprocess,aswellastheadditionalquota,isfreeofcharge. Followthischecklisttoensurethatyou’vecompletedeachofthestepsneededtointegratetheSafetyNetApi.attest APIintotheapp. Programmatic Detection 302\\nFile existence checks Perhapsthemostwidelyusedmethodofprogrammaticdetectionischeckingforfilestypicallyfoundonrooteddevices, suchaspackagefilesofcommonrootingappsandtheirassociatedfilesanddirectories,includingthefollowing: /system/app/Superuser.apk /system/etc/init.d/99SuperSUDaemon /dev/com.koushikdutta.superuser.daemon/ /system/xbin/daemonsu Detection code also often looks for binaries that are usually installed once a device has been rooted. These searches includecheckingforbusyboxandattemptingtoopenthesubinaryatdifferentlocations: /sbin/su /system/bin/su /system/bin/failsafe/su /system/xbin/su /system/xbin/busybox /system/sd/xbin/su /data/local/su /data/local/xbin/su /data/local/bin/su CheckingwhethersuisonthePATHalsoworks: public static boolean checkRoot(){ for(StringpathDir :System.getenv(\"PATH\").split(\":\")){ if(newFile(pathDir,\"su\").exists()){ return true; } } return false; } FilecheckscanbeeasilyimplementedinbothJavaandnativecode. ThefollowingJNIexample(adaptedfromrootinspec- tor)usesthestatsystemcalltoretrieveinformationaboutafileandreturns“1”ifthefileexists. jbooleanJava_com_example_statfile(JNIEnv *env,jobjectthis,jstringfilepath){ jbooleanfileExists =0; jbooleanisCopy; const char *path =(*env)->GetStringUTFChars(env,filepath,&isCopy); struct statfileattrib; if(stat(path,&fileattrib)<0){ __android_log_print(ANDROID_LOG_DEBUG,DEBUG_TAG,\"NATIVE:staterror:[%s]\",strerror(errno)); }else { __android_log_print(ANDROID_LOG_DEBUG,DEBUG_TAG,\"NATIVE:statsuccess,accessperms:[%d]\",fileattrib.st_mode); return 1; } return", "metadata": {"doc_id": "OWASP_MASTG", "chunk_id": 112}}