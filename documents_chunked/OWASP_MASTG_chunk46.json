{"text": "Asymmetriccryptographyisthe bestwaytoimplementtransactionsigning. Theappwillgenerateapublic/privatekeypairwhentheusersignsup,then 57\\nregistersthepublickeyonthebackend. TheprivatekeyissecurelystoredintheKeyStore(Android)orKeyChain(iOS). To authorize a transaction, the backend sends the mobile app a push notification containing the transaction data. The useristhenaskedtoconfirmordenythetransaction. Afterconfirmation,theuserispromptedtounlocktheKeychain(by enteringthePINorfingerprint),andthedataissignedwithuser’sprivatekey. Thesignedtransactionisthensenttothe server,whichverifiesthesignaturewiththeuser’spublickey. Login Activity and Device Blocking Itisabestpracticethatappsshouldinformtheuseraboutallloginactivitieswithintheappwiththepossibilityofblocking certaindevices. Thiscanbebrokendownintovariousscenarios: 1. Theapplicationprovidesapushnotificationthemomenttheiraccountisusedonanotherdevicetonotifytheuser ofdifferentactivities. Theusercanthenblockthisdeviceafteropeningtheappviathepush-notification. 2. The application provides an overview of the last session after login. If the previous session was with a different configuration(e.g.location,device,app-version)comparedtothecurrentconfiguration,thentheusershouldhave theoptiontoreportsuspiciousactivitiesandblockdevicesusedintheprevioussession. 3. Theapplicationprovidesanoverviewofthelastsessionafterloginatalltimes. 4. Theapplicationhasaself-serviceportalinwhichtheusercanseeanaudit-log. Thisallowstheusertomanagethe differentdevicesthatareloggedin. Thedevelopercanmakeuseofspecificmeta-informationandassociateittoeachdifferentactivityoreventwithinthe application. This will make it easier for the user to spot suspicious behavior and block the corresponding device. The meta-informationmayinclude: • Device: Theusercanclearlyidentifyalldeviceswheretheappisbeingused. • DateandTime: Theusercanclearlyseethelatestdateandtimewhentheappwasused. • Location: Theusercanclearlyidentifythelatestlocationswheretheappwasused. Theapplicationcanprovidealistofactivitieshistorywhichwillbeupdatedaftereachsensitiveactivitywithintheappli- cation. Thechoiceofwhichactivitiestoauditneedstobedoneforeachapplicationbasedonthedataithandlesandthe levelofsecurityrisktheteamiswillingtohave. Belowisalistofcommonsensitiveactivitiesthatareusuallyaudited: • Loginattempts • Passwordchanges • PersonalIdentifiableInformationchanges(name,emailaddress,telephonenumber,etc.) • Sensitiveactivities(purchase,accessingimportantresources,etc.) • ConsenttoTermsandConditionsclauses Paidcontentrequiresspecialcare, andadditionalmeta-information(e.g., operationcost, credit, etc.) mightbeusedto ensureuser’sknowledgeaboutthewholeoperation’sparameters. In addition, non-repudiation mechanisms should be applied to sensitive transactions (e.g. paid content access, given consenttoTermsandConditionsclauses,etc.) inordertoprovethataspecifictransactionwasinfactperformed(integrity) andbywhom(authentication). Lastly,itshouldbepossiblefortheusertologoutspecificopensessionsandinsomecasesitmightbeinterestingtofully blockcertaindevicesusingadeviceidentifier. 58\\nMobile App Network Communication Practicallyeverynetwork-connectedmobileappusestheHypertextTransferProtocol(HTTP)orHTTPoverTransportLayer Security (TLS), HTTPS, to send and receive data to and from remote endpoints. Consequently, network-based attacks (such as packet sniffing and man-in-the-middle-attacks) are a problem. In this chapter we discuss potential vulnera- bilities, testing techniques, and best practices concerning the network communication between mobile apps and their endpoints. Secure Connections The time has long passed since it was reasonable to use cleartext HTTP alone and it’s usually trivial to secure HTTP connectionsusingHTTPS.HTTPSisessentiallyHTTPlayeredontopofanotherprotocolknownasTransportLayerSecurity (TLS).AndTLSperformsahandshakeusingpublickeycryptographyand,whencomplete,createsasecureconnection. AnHTTPSconnectionisconsideredsecurebecauseofthreeproperties: • Confidentiality: TLSencryptsdatabeforesendingitoverthenetwork,whichmeansitcan’tbereadbyaninter- mediary. • Integrity: thedatacan’tbealteredwithoutdetection. • Authentication: theclientcanvalidatetheidentityoftheservertomakesuretheconnectionisestablishedwith thecorrectserver. Server Trust Evaluation CertificateAuthorities(CAs)areanintegralpartofasecureclientservercommunicationandtheyarepredefinedinthe truststoreofeachoperatingsystem. Forinstance,oniOStherearemorethan200rootcertificatesinstalled(seeApple documentation-AvailabletrustedrootcertificatesforAppleoperatingsystems) CAs can be added to the trust store, either manually by the user, by an MDM that manages the enterprise device or through malware. The question is then: “can you trust all of those CAs and should your app rely on the default trust store?”. Afterall,therearewell-knowncaseswherecertificateauthoritieshavebeencompromisedortrickedintoissuing certificatestoimpostors. AdetailedtimelineofCAbreachesandfailurescanbefoundatsslmate.com. BothAndroidandiOSallowtheusertoinstalladditionalCAsortrustanchors. AnappmaywanttotrustacustomsetofCAsinsteadoftheplatformdefault. Themostcommonreasonsforthisare: • Connectingtoahostwithacustomcertificateauthority(aCAthatisn’tknownortrustedbythesystemyet),such asaCAthatisself-signedorisissuedinternallywithinacompany. • LimitingthesetofCAstoaspecificlistoftrustedCAs. • TrustingadditionalCAsnotincludedinthesystem. About Trust Stores Extending Trust Whenevertheappconnectstoaserverwhosecertificateisself-signedorunknowntothesystem,thesecureconnection willfail. ThisistypicallythecaseforanynonpublicCAs,forinstancethoseissuedbyanorganizationsuchasagovernment, corporation,oreducationinstitutionfortheirownuse. BothAndroidandiOSoffermeanstoextendtrust,i.e.includeadditionalCAssothattheapptruststhesystem’sbuilt-in onesplusthecustomones. However,rememberthatthedeviceusersarealwaysabletoincludeadditionalCAs. Therefore,dependingonthethreat modeloftheappitmightbenecessarytoavoidtrustinganycertificatesaddedtotheusertruststoreorevengofurther andonlytrustapre-definedspecificcertificateorsetofcertificates. Formanyapps,the“defaultbehavior”providedbythemobileplatformwillbesecureenoughfortheirusecase(intherare casethatasystem-trustedCAiscompromisedthedatahandledbytheappisnotconsideredsensitiveorothersecurity 59\\nmeasuresaretakenwhichareresilienteventosuchaCAbreach). However, forotherappssuchasfinancialorhealth apps,theriskofaCAbreach,evenifrare,mustbeconsidered. Restricting Trust: Identity Pinning SomeappsmightneedtofurtherincreasetheirsecuritybyrestrictingthenumberofCAsthattheytrust. Typicallyonly theCAswhichareusedbythedeveloperareexplicitlytrusted,whiledisregardingallothers. Thistrustrestrictionisknown asIdentityPinningusuallyimplementedasCertificatePinningorPublicKeyPinning. IntheOWASPMASTGwewillbereferringtothistermas“IdentityPinning”,“CertificatePinning”,“PublicKeyPinning” orsimply“Pinning”. Pinningistheprocessofassociatingaremoteendpointwithaparticularidentity,suchasaX.509certificateorpublickey, insteadofacceptinganycertificatesignedbyatrustedCA.Afterpinningtheserveridentity(oracertainset,aka. pinset), themobileappwillsubsequentlyconnecttothoseremoteendpointsonlyiftheidentitymatches. Withdrawingtrustfrom unnecessaryCAsreducestheapp’sattacksurface. General Guidelines TheOWASPCertificatePinningCheatSheetgivesessentialguidanceon: • whenpinningisrecommendedandwhichexceptionsmightapply. • whentopin: developmenttime(preloading)oruponfirstencountering(trustonfirstuse). • whattopin: certificate,publickeyorhash. BothAndroidandiOSrecommendationsmatchthe“bestcase”whichis: • Pinonlytoremoteendpointswherethedeveloperhascontrol. • atdevelopmenttimevia(NSC/ATS) • pinahashoftheSPKIsubjectPublicKeyInfo. Pinninghasgainedabadreputationsinceitsintroductionseveralyearsago. We’dliketoclarifyacoupleofpointsthat arevalidatleastformobileapplicationsecurity: • The bad reputation is due to operational reasons (e.g. implementation/pin management complexity) not lack of security. • Ifanappdoesnotimplementpinning,thisshouldn’tbereportedasavulnerability. However,iftheappmustverify againstMASVS-L2itmustbeimplemented. • BothAndroidandiOSmakeimplementingpinningveryeasyandfollowthebestpractices. • PinningprotectsagainstacompromisedCAoramaliciousCAthatisinstalledonthedevice. Inthosecases,pinning willpreventtheOSfromestablishingasecureconnectionfrombeingestablishedwithamaliciousserver. However, ifanattackerisincontrolofthedevice,theycaneasilydisableanypinninglogicandthusstillallowtheconnection to happen. As a result, this will not prevent an attacker from accessing your backend and abusing server-side vulnerabilities. • Pinning in mobile apps is not the same as HTTP Public Key Pinning (HPKP). The HPKP header is no longer recom- mendedonwebsitesasitcanleadtousersbeinglockedoutofthewebsitewithoutanywaytorevertthelockout. For mobile apps, this is not an issue, as the app can always be updated via an out-of-band channel (i.e. the app store)incasethereareanyissues. About Pinning Recommendations in Android Developers TheAndroidDeveloperssiteincludesthefollowingwarning: Caution: CertificatePinningisnotrecommendedforAndroidapplicationsduetothehighriskoffutureservercon- figurationchanges,suchaschangingtoanotherCertificateAuthority,renderingtheapplicationunabletoconnect totheserverwithoutreceivingaclientsoftwareupdate. Theyalsoincludethisnote: 60\\nNotethat,whenusingcertificatepinning,youshouldalwaysincludeabackupkeysothatifyouareforcedtoswitch tonewkeysorchangeCAs(whenpinningtoaCAcertificateoranintermediateofthatCA),yourapp’sconnectivity isunaffected. Otherwise,youmustpushoutanupdatetotheapptorestoreconnectivity. Thefirststatementcanbemistakenlyinterpretedassayingthatthey“donotrecommendcertificatepinning”. Thesecond statement clarifies this: the actual recommendation is that if developers want to implement pinning they have to take thenecessaryprecautions. About Pinning Recommendations in Apple Developers Applerecommendsthinkinglong-termandcreatingaproperserverauthenticationstrategy. OWASP MASTG Recommendation Pinningisarecommendedpractice,especiallyforMASVS-L2apps. However,developersmustimplementitexclusively fortheendpointsundertheircontrolandbesuretoincludebackupkeys(aka. backuppins)andhaveaproperappupdate strategy.", "metadata": {"doc_id": "OWASP_MASTG", "chunk_id": 46}}