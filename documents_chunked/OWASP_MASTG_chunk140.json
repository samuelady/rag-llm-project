{"text": "performstaticanalysisforthedatadumpaccordingtogenerickeywordsandapp-specificdata. ThefollowingstepscanbeusedtodeterminehowtheapplicationstoresdatalocallyonajailbrokeniOSdevice: 1. Triggerthefunctionalitythatstorespotentiallysensitivedata. 2. ConnecttotheiOSdeviceandnavigatetoitsBundledirectory(thisappliestoiOSversions8.0andabove): /var/ mobile/Containers/Data/Application/$APP_ID/ 3. Executegrepwiththedatathatyou’vestored,forexample: grep -iRn \"USERID\". 4. Ifthesensitivedataisstoredinplaintext,theappfailsthistest. Youcananalyzetheapp’sdatadirectoryonanon-jailbrokeniOSdevicebyusingthird-partyapplications,suchasiMaz- ing. 407\\n1. Triggerthefunctionalitythatstorespotentiallysensitivedata. 2. ConnecttheiOSdevicetoyourhostcomputerandlaunchiMazing. 3. Select“Apps”,right-clickthedesirediOSapplication,andselect“ExtractApp”. 4. Navigatetotheoutputdirectoryandlocate$APP_NAME.imazing. Renameitto$APP_NAME.zip. 5. UnpacktheZIPfile. Youcanthenanalyzetheapplicationdata. NotethattoolslikeiMazingdon’tcopydatadirectlyfromthedevice. Theytrytoextractdatafromthebackupsthey create. Therefore,gettingalltheappdatathat’sstoredontheiOSdeviceisimpossible: notallfoldersareincluded inbackups. UseajailbrokendeviceorrepackagetheappwithFridaanduseatoollikeobjectiontoaccessallthe dataandfiles. IfyouaddedtheFridalibrarytotheappandrepackageditasdescribedin“DynamicAnalysisonNon-JailbrokenDevices” (from the “Tampering and Reverse Engineering on iOS” chapter), you can use objection to transfer files directly from the app’s data directory or read files in objection as explained in the chapter “Basic Security Testing on iOS”, section “Host-DeviceDataTransfer”. TheKeychaincontentscanbedumpedduringdynamicanalysis. Onajailbrokendevice,youcanuseKeychaindumper asdescribedinthechapter“BasicSecurityTestingoniOS”. ThepathtotheKeychainfileis /private/var/Keychains/keychain-2.db Onanon-jailbrokendevice,youcanuseobjectiontodumptheKeychainitemscreatedandstoredbytheapp. Dynamic Analysis with Xcode and iOS simulator ThistestisonlyavailableonmacOS,asXcodeandtheiOSsimulatorisneeded. Fortestingthelocalstorageandverifyingwhatdataisstoredwithinit,it’snotmandatorytohaveaniOSdevice. With access to the source code and Xcode the app can be build and deployed in the iOS simulator. The file system of the currentdeviceoftheiOSsimulatorisavailablein~/Library/Developer/CoreSimulator/Devices. OncetheappisrunningintheiOSsimulator, youcannavigatetothedirectoryofthelatestsimulatorstartedwiththe followingcommand: $cd~/Library/Developer/CoreSimulator/Devices/$( ls-alht ~/Library/Developer/CoreSimulator/Devices |head -n2| awk'{print$9}' |sed-n'1!p')/data/Containers/Data/Application ThecommandabovewillautomaticallyfindtheUUIDofthelatestsimulatorstarted. Nowyoustillneedtogrepforyour appnameorakeywordinyourapp. ThiswillshowyoutheUUIDoftheapp. grep -iRn keyword. Thenyoucanmonitorandverifythechangesinthefilesystemoftheappandinvestigateifanysensitiveinformationis storedwithinthefileswhileusingtheapp. Dynamic Analysis with Objection Youcanusetheobjectionruntimemobileexplorationtoolkittofindvulnerabilitiescausedbytheapplication’sdatastorage mechanism. ObjectioncanbeusedwithoutaJailbrokendevice,butitwillrequirepatchingtheiOSApplication. Reading the Keychain TouseObjectiontoreadtheKeychain,executethefollowingcommand: 408\\n...itudehacks.DVIAswiftv2.developon (iPhone:13.2.3)[usb] #ioskeychaindump Note:YoumaybeaskedtoauthenticateusingthedevicespasscodeorTouchID Savetheoutputbyadding `--jsonkeychain.json`tothiscommand DumpingtheiOSkeychain... Created Accessible ACL Type Account Service Data ##TestingMemoryforSensitiveData >**Platform:**ios > >**MASVSV1:**MSTG-STORAGE-10 > >**MASVSV2:**MASVS-STORAGE-2 ###Overview ###StaticAnalysis Whenperformingstaticanalysisforsensitivedataexposedviamemory,youshould -trytoidentifyapplicationcomponentsandmapwherethedataisused, -makesurethatsensitivedataishandledwithasfewcomponentsaspossible, -makesurethatobjectreferencesareproperlyremovedoncetheobjectcontainingsensitivedataisnolongerneeded, -makesurethathighlysensitivedataisoverwrittenassoonasitisnolongerneeded, -notpasssuchdataviaimmutabledatatypes,suchas `String`and`NSString`, -avoidnon-primitivedatatypes (becausetheymightleavedatabehind), -overwritethevalueinmemorybeforeremovingreferences, -payattentiontothird-partycomponents (librariesandframeworks).HavingapublicAPIthathandlesdataaccordingtotherecommendationsaboveisagood ↪ indicatorthatdevelopersconsideredtheissuesdiscussedhere. ###DynamicAnalysis ThereareseveralapproachesandtoolsavailablefordynamicallytestingthememoryofaniOSappforsensitivedata. ####RetrievingandAnalyzingaMemoryDump Whetheryouareusingajailbrokenoranon-jailbrokendevice,youcandumptheapp'sprocess memorywith[objection](https://github.com/sensepost/objection ↪ \"Objection\")and[Fridump](https://github.com/Nightbringer21/fridump\"Fridump\").Youcanfindadetailedexplanationofthisprocessinthesection\"[Memory ↪ Dump](../../../Document/0x06c-Reverse-Engineering-and-Tampering.md#memory-dump\"MemoryDump\")\",inthechapter\"TamperingandReverseEngineeringoniOS\". Afterthememoryhasbeendumped(e.g.toafilecalled\"memory\"),dependingonthenatureofthedatayou'relookingfor,you'llneedasetofdifferenttoolsto ↪ processandanalyzethatmemorydump.Forinstance,ifyou'refocusingonstrings,itmightbesufficientforyoutoexecutethecommand`strings`or`rabin2 ↪ -zz`toextractthosestrings. ```bash ##usingstrings $stringsmemory >strings.txt ##usingrabin2 $rabin2 -ZZmemory >strings.txt Openstrings.txtinyourfavoriteeditoranddigthroughittoidentifysensitiveinformation. However if you’d like to inspect other kind of data, you’d rather want to use radare2 and its search capabilities. See radare2’shelponthesearchcommand(/?) formoreinformationandalistofoptions. Thefollowingshowsonlyasubset ofthem: $r2 <name_of_your_dump_file> [0x00000000]>/? Usage:/[!bf][arg] Searchstuff (see'e??search' foroptions) |Useio.vaforsearchinginnonvirtualaddressingspaces |/foo\\x00 searchforstring 'foo\\0' |/c[ar] searchforcryptomaterials |/e/E.F/i matchregularexpression |/ifoo searchforstring 'foo' ignoringcase |/m[?][ebm]magicfile searchformagic,filesystemsorbinaryheaders |/v[1248]value lookforan `cfg.bigendian`32bitvalue |/wfoo searchforwidestring 'f\\0o\\0o\\0' |/xff0033 searchforhexstring |/zminmax searchforstringsofgivensize ... Runtime Memory Analysis By using r2frida you can analyze and inspect the app’s memory while running and without needing to dump it. For example, you may run the previous search commands from r2frida and search the memory for a string, hexadecimal values,etc. Whendoingso,remembertoprependthesearchcommand(andanyotherr2fridaspecificcommands)with abackslash: afterstartingthesessionwithr2 frida://usb//<name_of_your_app>. Formoreinformation,optionsandapproaches,pleaserefertosection“In-MemorySearch”inthechapter“Tamperingand ReverseEngineeringoniOS”. 409\\nTesting Backups for Sensitive Data Platform: ios MASVSV1: MSTG-STORAGE-8 MASVSV2: MASVS-STORAGE-2 Overview Static Analysis Abackupofadeviceonwhichamobileapplicationhasbeeninstalledwillincludeallsubdirectories(exceptforLibrary/ Caches/)andfilesintheapp’sprivatedirectory. Therefore,avoidstoringsensitivedatainplaintextwithinanyofthefilesorfoldersthatareintheapp’sprivatedirectory orsubdirectories. Although all the files in Documents/ and Library/Application Support/ are always backed up by default, you can excludefilesfromthebackupbycallingNSURLsetResourceValue:forKey:error: withtheNSURLIsExcludedFromBack- upKeykey. YoucanusetheNSURLIsExcludedFromBackupKeyandCFURLIsExcludedFromBackupKeyfilesystempropertiestoexclude filesanddirectoriesfrombackups. Anappthatneedstoexcludemanyfilescandosobycreatingitsownsubdirectory andmarkingthatdirectoryexcluded. Appsshouldcreatetheirowndirectoriesforexclusioninsteadofexcludingsystem- defineddirectories. Bothfilesystempropertiesarepreferabletothedeprecatedapproachofdirectlysettinganextendedattribute. Allapps runningoniOSversion5.1andlatershouldusethesepropertiestoexcludedatafrombackups. ThefollowingissampleObjective-CcodeforexcludingafilefromabackuponiOS5.1andlater: -(BOOL)addSkipBackupAttributeToItemAtPath:(NSString *)filePathString { NSURL*URL=[NSURLfileURLWithPath:filePathString]; assert([[NSFileManagerdefaultManager]fileExistsAtPath:[URLpath]]); NSError *error =nil; BOOLsuccess =[URLsetResourceValue:[NSNumbernumberWithBool:YES] forKey:NSURLIsExcludedFromBackupKeyerror: &error]; if(!success){ NSLog(@\"Errorexcluding%@frombackup%@\",[URLlastPathComponent], error); } return success; } ThefollowingissampleSwiftcodeforexcludingafilefromabackuponiOS5.1andlater,seeSwiftexcludingfilesfrom iCloudbackupformoreinformation: enum ExcludeFileError:Error { case fileDoesNotExist case error(String) } func excludeFileFromBackup(filePath:URL)->Result<Bool,ExcludeFileError>{ varfile =filePath do{ ifFileManager.default.fileExists(atPath:file.path){ varres=URLResourceValues() res.isExcludedFromBackup =true tryfile.setResourceValues(res) return .success(true) }else { return .failure(.fileDoesNotExist) } }catch { return .failure(.error(\"Errorexcluding \\(file.lastPathComponent)frombackup \\(error)\")) } } 410\\nDynamic Analysis Inordertotestthebackup,youobviouslyneedtocreateonefirst. ThemostcommonwaytocreateabackupofaniOS deviceisbyusingiTunes,whichisavailableforWindows,LinuxandofcoursemacOS(tillmacOSMojave). Whencreating abackupviaiTunesyoucanalwaysonlybackupthewholedeviceandnotselectjustasingleapp. Makesurethatthe option“Encryptlocalbackup”iniTunesisnotset,sothatthebackupisstoredincleartextonyourharddrive. iTunes is not available anymore from macOS Catalina onwards. Managing of an iOS device, including updates, backupandrestorehasbeenmovedtotheFinderapp. Theapproachremainsthesame,asdescribedabove. AftertheiOSdevicehasbeenbackedup,youneedtoretrievethefilepathofthebackup,whicharedifferentlocations oneachOS.TheofficialAppledocumentationwillhelpyoutolocatebackupsofyouriPhone,iPad,andiPodtouch. WhenyouwanttonavigatetothebackupfolderuptoHighSierrayoucaneasilydoso. StartingwithmacOSMojaveyou willgetthefollowingerror(evenasroot): $pwd /Users/foo/Library/ApplicationSupport $ls -alh MobileSync ls:MobileSync:Operationnotpermitted Thisisnotapermissionissueofthebackupfolder, butanewfeatureinmacOSMojave. Youcansolvethisproblemby grantingfulldiskaccesstoyourterminalapplicationbyfollowingtheexplanationonOSXDaily. BeforeyoucanaccessthedirectoryyouneedtoselectthefolderwiththeUDIDofyourdevice. Checkthesection“Getting theUDIDofaniOSdevice”inthe“iOSBasicSecurityTesting”chapteronhowtoretrievetheUDID. OnceyouknowtheUDIDyoucannavigateintothisdirectoryandyouwillfindthefullbackupofthewholedevice,which doesincludepictures,appdataandwhatevermighthavebeenstoredonthedevice. Reviewthedatathat’sinthebackedupfilesandfolders. Thestructureofthedirectoriesandfilenamesisobfuscated andwilllooklikethis: $pwd /Users/foo/Library/ApplicationSupport/MobileSync/Backup/416f01bd160932d2bf2f95f1f142bc29b1c62dcb/00 $ls |head -n3 000127b08898088a8a169b4f63b363a3adcf389b 0001fe89d0d03708d414b36bc6f706f567b08d66 000200a644d7d2c56eec5b89c1921dacbec83c3e Therefore,it’snotstraightforwardtonavigatethroughitandyouwillnotfindanyhintsoftheappyouwanttoanalyzein thedirectoryorfilename. YoucanconsiderusingtheiMazingsharewareutilitytoassisthere. Performadevicebackup withiMazinganduseitsbuilt-inbackupexplorertoeasilyanalyzeappcontainercontentsincludingoriginalpathsandfile names. WithoutiMazingorsimilarsoftwareyoumayneedtoresorttousinggreptoidentifysensitivedata. Thisisnotthemost thoroughapproachbutyoucantrysearchingforsensitivedatathatyouhavekeyedinwhileusingtheappbeforeyou madethebackup. Forexample: theusername,password,creditcarddata,PIIoranydatathatisconsideredsensitivein thecontextoftheapp. ~/Library/ApplicationSupport/MobileSync/Backup/<UDID> grep -iRn \"password\" . AsdescribedintheStaticAnalysissection,anysensitivedatathatyou’reabletofindshouldbeexcludedfromthebackup, encryptedproperlybyusingtheKeychainornotstoredonthedeviceinthefirstplace. Toidentifyifabackupisencrypted,youcancheckthekeynamed“IsEncrypted”fromthefile“Manifest.plist”,locatedat therootofthebackupdirectory. Thefollowingexampleshowsaconfigurationindicatingthatthebackupisencrypted: <?xml version=\"1.0\" encoding=\"UTF-8\"?> <!DOCTYPE plist PUBLIC\"-//Apple//DTDPLIST1.0//EN\"\"http://www.apple.com/DTDs/PropertyList-1.0.dtd\">", "metadata": {"doc_id": "OWASP_MASTG", "chunk_id": 140}}