{
  "text": "the onCreate method. It is importanttoremembertoaddthelibrarylibinject.sointherespectivearchitecturefolder(armeabi-v7a,arm64-v8a,x86) ofthelibfolderintheAPK.Finally,youneedtore-signtheapplicationbeforeusingit. A well-known use case of this technique is loading the Frida gadget to an application, especially while working on a non-rooteddevice(thisiswhatobjection patchapkbasicallydoes). Patching Application’s Native Library Many Androidapplications use native code in addition to Java code for various performance and security reasons. The nativecodeispresentintheformofELFsharedlibraries. AnELFexecutableincludesalistofsharedlibraries(dependen- cies)thatarelinkedtotheexecutableforittofunctionoptimally. Thislistcanbemodifiedtoinsertanadditionallibrary tobeinjectedintotheprocess. ModifyingtheELFfilestructuremanuallytoinjectalibrarycanbecumbersomeandpronetoerrors. However,thistask canbeperformedwithrelativeeaseusingLIEF(LibrarytoInstrumentExecutableFormats). Usingitrequiresonlyafew linesofPythoncodeasshownbelow: importlief libnative =lief.parse(\"libnative.so\") libnative.add_library(\"libinject.so\")#Injection! libnative.write(\"libnative.so\") Intheaboveexample,libinject.solibraryisinjectedasadependencyofanativelibrary(libnative.so),whichtheapplication alreadyloadsbydefault. FridagadgetcanbeinjectedintoanapplicationusingthisapproachasexplainedindetailinLIEF’s documentation. Asintheprevioussection,itisimportanttorememberaddingthelibrarytotherespectivearchitecture libfolderintheAPKandfinallyre-signingtheapplication. 141\\nPreloading Symbols Abovewelookedintotechniqueswhichrequiresomekindofmodificationoftheapplication’scode. Alibrarycanalsobe injectedintoaprocessusingfunctionalitiesofferedbytheloaderoftheoperatingsystem. OnAndroid,whichisaLinux basedOS,youcanloadanadditionallibrarybysettingtheLD_PRELOADenvironmentvariable. Astheld.somanpagestates,symbolsloadedfromthelibrarypassedusingLD_PRELOADalwaysgetprecedence,i.e.they are searched first by the loader while resolving the symbols, effectively overriding the original ones. This feature is oftenusedtoinspecttheinputparametersofsomecommonlyusedlibcfunctionssuchasfopen,read,write,strcmp, etc., specially in obfuscated programs, where understanding their behavior may be challenging. Therefore, having an insightonwhichfiles arebeingopenedor whichstringsarebeing comparedmaybevery valuable. Thekeyidea here is“functionwrapping”,meaningthatyoucannotpatchsystemcallssuchaslibc’sfopen,butyoucanoverride(wrap)it includingcustomcodethatwill,forinstance,printtheinputparametersforyouandstillcalltheoriginalfopenremaining transparenttothecaller. OnAndroid,settingLD_PRELOADisslightlydifferentcomparedtootherLinuxdistributions. Ifyourecallfromthe“Platform Overview” section, every application in Android is forked from Zygote, which is started very early during the Android boot-up. Thus, setting LD_PRELOAD on Zygote is not possible. As a workaround for this problem, Android supports the setprop(setproperty)functionality. Belowyoucanseeanexampleforanapplicationwithpackagenamecom.foo.bar (notetheadditionalwrap. prefix): setpropwrap.com.foo.barLD_PRELOAD=/data/local/tmp/libpreload.so PleasenotethatifthelibrarytobepreloadeddoesnothaveSELinuxcontextassigned,fromAndroid5.0(APIlevel 21)onwards,youneedtodisableSELinuxtomakeLD_PRELOADwork,whichmayrequireroot. Debugging Platform: android Sofar,you’vebeenusingstaticanalysistechniqueswithoutrunningthetargetapps. Intherealworld,especiallywhen reversingmalwareormorecomplexapps,purestaticanalysisisverydifficult. Observingandmanipulatinganappduring runtimemakesitmuch,mucheasiertodecipheritsbehavior. Next,we’llhavealookatdynamicanalysismethodsthat helpyoudojustthat. Androidappssupporttwodifferenttypesofdebugging: DebuggingontheleveloftheJavaruntimewiththeJavaDebug Wire Protocol (JDWP), and Linux/Unix-style ptrace-based debugging on the native layer, both of which are valuable to reverseengineers. Debugging Release Apps DalvikandARTsupporttheJDWP,aprotocolforcommunicationbetweenthedebuggerandtheJavavirtualmachine(VM) thatitdebugs. JDWPisastandarddebuggingprotocolthat’ssupportedbyallcommandlinetoolsandJavaIDEs,including jdb,IntelliJ,andEclipse. Android’simplementationofJDWPalsoincludeshooksforsupportingextrafeaturesimplemented bytheDalvikDebugMonitorServer(DDMS). AJDWPdebuggerallowsyoutostepthroughJavacode,setbreakpointsonJavamethods,andinspectandmodifylocal andinstancevariables. You’lluseaJDWPdebuggermostofthetimeyoudebug“normal”Androidapps(i.e., appsthat don’tmakemanycallstonativelibraries). Inthefollowingsection,we’llshowhowtosolvetheUnCrackableAppforAndroidLevel1withjdbalone. Notethatthisis notanefficientwaytosolvethiscrackme. ActuallyyoucandoitmuchfasterwithFridaandothermethods,whichwe’ll introducelaterintheguide. This,however,servesasanintroductiontothecapabilitiesoftheJavadebugger. Debugging with jdb The adb command line tool was introduced in the “Android Basic Security Testing” chapter. You can use its adb jdwp commandtolisttheprocessIDsofalldebuggableprocessesrunningontheconnecteddevice(i.e.,processeshostinga 142\\nJDWPtransport). Withtheadb forwardcommand,youcanopenalisteningsocketonyourhostcomputerandforward thissocket’sincomingTCPconnectionstotheJDWPtransportofachosenprocess. $adbjdwp 12167 $adbforwardtcp:7777jdwp:12167 You’renowreadytoattachjdb. Attachingthedebugger,however,causestheapptoresume,whichyoudon’twant. You wanttokeepitsuspendedsothatyoucanexplorefirst. Topreventtheprocessfromresuming,pipethesuspendcommand intojdb: ${echo \"suspend\";cat;}|jdb-attach localhost:7777 Initializingjdb... >Allthreadssuspended. > You’re now attached to the suspended process and ready to go ahead with the jdb commands. Entering ? prints the completelistofcommands. Unfortunately,theAndroidVMdoesn’tsupportallavailableJDWPfeatures. Forexample,the redefine command, which would let you redefine a class code is not supported. Another important restriction is that linebreakpointswon’tworkbecausethereleasebytecodedoesn’tcontainlineinformation. Methodbreakpointsdowork, however. Usefulworkingcommandsinclude: • classes: listallloadedclasses • class/methods/fieldsclassid: Printdetailsaboutaclassandlistitsmethodsandfields • locals: printlocalvariablesincurrentstackframe • print/dumpexpr: printinformationaboutanobject • stopinmethod: setamethodbreakpoint • clearmethod: removeamethodbreakpoint • setlvalue=expr: assignnewvaluetofield/variable/arrayelement Let’s revisit the decompiled code from the UnCrackable App for Android Level 1 and think about possible solutions. A goodapproachwouldbesuspendingtheappinastatewherethesecretstringisheldinavariableinplaintextsoyou canretrieveit. Unfortunately,youwon’tgetthatfarunlessyoudealwiththeroot/tamperingdetectionfirst. Reviewthecodeandyou’llseethatthemethodsg.vantagepoint.uncrackable1.MainActivity.adisplaysthe“Thisin unacceptable...”messagebox. ThismethodcreatesanAlertDialogandsetsalistenerclassfortheonClickevent. This class (named b) has a callback method will terminatesthe app once the user taps theOK button. Toprevent the user fromsimplycancelingthedialog,thesetCancelablemethodiscalled. private void a(final Stringtitle){ final AlertDialogcreate =newAlertDialog$Builder((Context)this).create(); create.setTitle((CharSequence)title); create.setMessage((CharSequence)\"Thisinunacceptable.Theappisnowgoingtoexit.\"); create.setButton(-3,(CharSequence)\"OK\",(DialogInterface$OnClickListener)newb(this)); create.setCancelable(false); create.show(); } Youcanbypassthiswithalittleruntimetampering. Withtheappstillsuspended,setamethodbreakpointonandroid. app.Dialog.setCancelableandresumetheapp. >stop inandroid.app.Dialog.setCancelable Setbreakpointandroid.app.Dialog.setCancelable >resume Allthreadsresumed. > Breakpointhit: \"thread=main\",android.app.Dialog.setCancelable(),line=1,110bci=0 main[1] TheappisnowsuspendedatthefirstinstructionofthesetCancelablemethod. Youcanprinttheargumentspassedto setCancelablewiththelocalscommand(theargumentsareshownincorrectlyunder“localvariables”). main[1]locals Methodarguments: Localvariables: flag=true 143\\nsetCancelable(true)wascalled,sothiscan’tbethecallwe’relookingfor. Resumetheprocesswiththeresumecom- mand. main[1]resume Breakpointhit: \"thread=main\",android.app.Dialog.setCancelable(),line=1,110bci=0 main[1]locals flag=false You’venowreachedacalltosetCancelablewiththeargumentfalse. Setthevariabletotruewiththesetcommand andresume. main[1]setflag=true flag=true=true main[1]resume Repeatthisprocess,settingflagtotrueeachtimethebreakpointisreached,untilthealertboxisfinallydisplayed(the breakpointwillbereachedfiveorsixtimes). Thealertboxshouldnowbecancelable! Tapthescreennexttotheboxand itwillclosewithoutterminatingtheapp. Nowthattheanti-tamperingisoutoftheway,you’rereadytoextractthesecretstring! Inthe“staticanalysis”section,you sawthatthestringisdecryptedwithAES,thencomparedwiththestringinputtothemessagebox. Themethodequals ofthejava.lang.Stringclasscomparesthestringinputwiththesecretstring. Setamethodbreakpointonjava.lang. String.equals,enteranarbitrarytextstringintheeditfield,andtapthe“verify”button. Oncethebreakpointisreached, youcanreadthemethodargumentwiththelocalscommand. >stop injava.lang.String.equals Setbreakpointjava.lang.String.equals > Breakpointhit: \"thread=main\",java.lang.String.equals(),line=639bci=2 main[1]locals Methodarguments: Localvariables: other= \"radiusGravity\" main[1]cont Breakpointhit: \"thread=main\",java.lang.String.equals(),line=639bci=2 main[1]locals Methodarguments: Localvariables: other= \"Iwanttobelieve\" main[1]cont Thisistheplaintextstringyou’relookingfor! Debugging with an IDE SettingupaprojectinanIDEwiththedecompiledsourcesisaneattrickthatallowsyoutosetmethodbreakpointsdirectly inthesourcecode. Inmostcases,youshouldbeabletosingle-stepthroughtheappandinspectthestateofvariables withtheGUI.Theexperiencewon’tbeperfect,it’snottheoriginalsourcecodeafterall,soyouwon’tbeabletosetline breakpointsandthingswillsometimessimplynotworkcorrectly. Thenagain,reversingcodeisnevereasy,andefficiently navigatinganddebuggingplainoldJavacodeisaprettyconvenientwayofdoingit. Asimilarmethodhasbeendescribed intheNetSPIblog. TosetupIDEdebugging,firstcreateyourAndroidprojectinIntelliJandcopythedecompiledJavasourcesintothesource folderasdescribedaboveinthe“ReviewingDecompiledJavaCode”section. Onthedevice, choosetheappasdebug apponthe“Developeroptions”(UnCrackableAppforAndroidLevel1inthistutorial),andmakesureyou’veswitchedon the“WaitForDebugger”feature. Onceyoutaptheappiconfromthelauncher,itwillbesuspendedin“WaitForDebugger”mode. 144\\nNowyoucansetbreakpointsandattachtotheappprocesswiththe“AttachDebugger”toolbarbutton. Notethatonlymethodbreakpointsworkwhendebugginganappfromdecompiledsources. Onceamethodbreakpoint isreached,you’llgetthechancetosinglestepduringthemethodexecution. 145\\nAfteryouchoosetheappfromthelist,thedebuggerwillattachtotheappprocessandyou’llreachthebreakpointthatwas setontheonCreatemethod. Thisapptriggersanti-debuggingandanti-tamperingcontrolswithintheonCreatemethod. That’swhysettingabreakpointontheonCreatemethodjustbeforetheanti-tamperingandanti-debuggingchecksare performedisagoodidea. Next, single-step through the onCreate method by clicking “Force Step Into” in Debugger view. The “Force Step",
  "metadata": {
    "doc_id": "OWASP_MASTG",
    "chunk_id": 70
  },
  "embedding": [
    -0.07841306924819946,
    0.011631202884018421,
    0.003988564945757389,
    -0.11767969280481339,
    0.041286714375019073,
    -0.050192270427942276,
    -0.008701645769178867,
    0.07134018838405609,
    -0.013982551172375679,
    -0.018059460446238518,
    0.05188406631350517,
    -0.003746174043044448,
    0.060583777725696564,
    -0.033939022570848465,
    0.018873730674386024,
    -0.041802484542131424,
    0.0472017340362072,
    0.06527355313301086,
    -0.018855653703212738,
    0.03947782889008522,
    -0.0059359935112297535,
    -0.0026145209558308125,
    0.031627971678972244,
    3.647040648502298e-05,
    0.06167803332209587,
    -0.05991898104548454,
    -0.020784836262464523,
    -0.09343858063220978,
    0.034874144941568375,
    0.04195443168282509,
    0.03156518191099167,
    0.07039434462785721,
    0.04683518782258034,
    0.045029740780591965,
    -0.1052868589758873,
    0.03350522369146347,
    0.041096776723861694,
    -0.022620396688580513,
    -0.0721164122223854,
    -0.043870117515325546,
    -0.05589742213487625,
    -0.0031729654874652624,
    -0.05573087930679321,
    0.0761566162109375,
    -0.08829676359891891,
    -0.06141582876443863,
    0.036226265132427216,
    -0.027410831302404404,
    -0.06037263199687004,
    0.02347628027200699,
    0.048534225672483444,
    0.010303117334842682,
    0.017261043190956116,
    -0.007971161976456642,
    -0.05575466528534889,
    0.016126418486237526,
    -0.02161380462348461,
    0.07036273181438446,
    0.02315652370452881,
    0.1551670879125595,
    0.08514025807380676,
    0.059649527072906494,
    0.0003550977853592485,
    0.03233804553747177,
    -0.003496919758617878,
    0.06839099526405334,
    0.0703277736902237,
    -0.09547870606184006,
    0.06572061032056808,
    -0.11045151203870773,
    -0.051122065633535385,
    0.04082466661930084,
    0.0396929606795311,
    0.003228881163522601,
    -0.016036314889788628,
    -0.013111687265336514,
    -0.04591760039329529,
    0.07167007029056549,
    -0.022332265973091125,
    -0.14791429042816162,
    0.0271287951618433,
    0.02615797333419323,
    -0.0053393240086734295,
    0.06759456545114517,
    0.04779437184333801,
    0.04401131719350815,
    0.014080180786550045,
    0.01576901599764824,
    0.029067188501358032,
    0.10485724359750748,
    0.08560159802436829,
    -0.011606504209339619,
    -0.017831148579716682,
    -0.08699225634336472,
    0.007542870473116636,
    -0.024736301973462105,
    -0.022975018247961998,
    0.020010320469737053,
    -0.040557075291872025,
    0.048245564103126526,
    -0.0005498278769664466,
    -0.02430526353418827,
    -0.01469980739057064,
    -0.018703404814004898,
    0.023468276485800743,
    -0.0437285415828228,
    -0.009527630172669888,
    -0.11365197598934174,
    -0.0391400046646595,
    0.007557649165391922,
    0.02710544504225254,
    -0.09691531211137772,
    -0.005144861061125994,
    -0.041678234934806824,
    0.010211874730885029,
    0.07652100175619125,
    -0.026533154770731926,
    0.009361562319099903,
    0.040061406791210175,
    0.031230852007865906,
    -0.0064881290309131145,
    0.04484114423394203,
    0.0421510748565197,
    -0.11848074197769165,
    -0.05169396102428436,
    0.06910715252161026,
    -0.07090117782354355,
    1.366143224541545e-32,
    0.009343535639345646,
    0.04174519330263138,
    0.011844000779092312,
    0.015240159817039967,
    -0.09870515763759613,
    -0.07681030035018921,
    0.022333895787596703,
    0.09288786351680756,
    -0.0011315048905089498,
    -0.0946635901927948,
    0.024524109438061714,
    0.058349352329969406,
    0.017745645716786385,
    0.004313561134040356,
    0.06341040134429932,
    -0.02927776426076889,
    -0.09151641279459,
    -0.001980694243684411,
    -0.015743141993880272,
    0.03480105847120285,
    0.009773866273462772,
    -0.06649794429540634,
    0.0038421170320361853,
    0.017505887895822525,
    -0.0345090851187706,
    0.04724562540650368,
    0.020029759034514427,
    0.0028316150419414043,
    0.032886382192373276,
    0.050896983593702316,
    -0.03244224935770035,
    -0.06312747299671173,
    -0.06964755058288574,
    0.021467486396431923,
    -0.035474494099617004,
    -0.07315202802419662,
    -0.02741321548819542,
    -0.06738901883363724,
    0.01276709046214819,
    -0.055240221321582794,
    -0.0063507347367703915,
    -0.04280665144324303,
    -0.10689491033554077,
    -0.020984390750527382,
    0.0579228512942791,
    -0.0005985826719552279,
    -0.019746415317058563,
    -0.0060012987814843655,
    0.025652829557657242,
    0.0060801259241998196,
    0.05047791078686714,
    0.049298062920570374,
    0.018183745443820953,
    -0.03701728954911232,
    -0.1264035701751709,
    -0.03114412911236286,
    -0.03831573203206062,
    -0.051230743527412415,
    -0.013898815028369427,
    0.004254389554262161,
    -0.023609906435012817,
    0.004048179369419813,
    0.033007699996232986,
    0.020354442298412323,
    -0.04556448385119438,
    0.044784314930438995,
    -0.004695652052760124,
    -0.10222379863262177,
    -0.06471479684114456,
    -0.008252126164734364,
    -0.018617909401655197,
    -0.03461727872490883,
    -0.03763130307197571,
    0.003779337275773287,
    -0.051123231649398804,
    0.01703675650060177,
    0.02976829744875431,
    0.027551522478461266,
    -0.09142780303955078,
    -0.05012309178709984,
    -0.009900827892124653,
    0.04113137349486351,
    0.008700593374669552,
    -0.004262407310307026,
    -0.0158543698489666,
    -0.04125188663601875,
    0.01878323219716549,
    -0.07971715927124023,
    -0.06080423295497894,
    0.035004932433366776,
    0.03243030980229378,
    0.04018128663301468,
    0.00475284643471241,
    -0.0009893395472317934,
    0.026205917820334435,
    -1.3973784604315947e-32,
    0.055990882217884064,
    -0.07311398535966873,
    -0.02978729084134102,
    -0.0063966247253119946,
    0.0034908484667539597,
    -0.004799345973879099,
    -0.0654660314321518,
    0.027648581191897392,
    -0.03773333132266998,
    -0.06393849849700928,
    -0.06470734626054764,
    -0.0005185591871850193,
    0.05110718309879303,
    -0.050217900425195694,
    0.04347898066043854,
    -0.017576975747942924,
    -0.001670578494668007,
    0.011613328009843826,
    0.027425697073340416,
    0.025664208456873894,
    0.00038645724998787045,
    0.07045780122280121,
    0.0852007195353508,
    0.012234381400048733,
    -0.015859048813581467,
    -0.031680528074502945,
    -0.0406632199883461,
    0.00942459050565958,
    0.029629504308104515,
    -0.05562750622630119,
    0.09813752770423889,
    0.028333177790045738,
    -0.08701371401548386,
    -0.08606972545385361,
    -0.027900081127882004,
    0.024539193138480186,
    -0.019807105883955956,
    -0.031031392514705658,
    0.016165630891919136,
    -0.021761063486337662,
    0.06049928814172745,
    -0.05260689556598663,
    0.026545902714133263,
    0.026753587648272514,
    0.042523667216300964,
    -0.02101108431816101,
    -0.07139521837234497,
    -0.047692008316516876,
    0.019207386299967766,
    -0.04937124252319336,
    0.08506415784358978,
    0.028384681791067123,
    0.010559605434536934,
    -0.017892085015773773,
    0.0009281287784688175,
    0.14774519205093384,
    0.040595341473817825,
    0.006161828525364399,
    0.0195086058229208,
    0.011325722560286522,
    0.0655967965722084,
    -0.10201206803321838,
    0.0029682971071451902,
    -0.01953541673719883,
    -0.022035133093595505,
    -0.022261446341872215,
    0.09897930175065994,
    0.06475414335727692,
    -0.08086663484573364,
    0.07683407515287399,
    0.05504145845770836,
    -0.062487032264471054,
    -0.06147380173206329,
    0.005368515849113464,
    -0.07020258903503418,
    0.06833217293024063,
    0.07368731498718262,
    -0.08161630481481552,
    -0.09593619406223297,
    -0.06911341845989227,
    -0.04445851221680641,
    0.017501240596175194,
    0.0024806796573102474,
    -0.012589829973876476,
    0.04424511268734932,
    -0.10340702533721924,
    -0.04759689047932625,
    -0.02119556814432144,
    0.022725829854607582,
    -0.016119470819830894,
    -0.07072955369949341,
    0.08090843260288239,
    -0.05161256715655327,
    0.0535932220518589,
    0.013335736468434334,
    -6.328640722585988e-08,
    0.049398601055145264,
    -0.06335894763469696,
    -0.03778433799743652,
    0.005149251315742731,
    0.06368797272443771,
    0.033745091408491135,
    -0.0019293595105409622,
    0.05191902071237564,
    0.045925676822662354,
    -0.07460741698741913,
    -0.03462029993534088,
    -0.0501723550260067,
    -0.09376703202724457,
    0.03419477865099907,
    0.06680664420127869,
    0.012150137685239315,
    -0.01888730376958847,
    0.04561580345034599,
    -0.07675587385892868,
    -0.0015063824830576777,
    -0.04271819815039635,
    -0.04483623430132866,
    -0.0415399931371212,
    -0.021613862365484238,
    -0.004941683262586594,
    -0.011611685156822205,
    0.14876055717468262,
    0.057703856378793716,
    0.03708770498633385,
    0.014505838043987751,
    -0.05121277645230293,
    0.03005938231945038,
    0.07965059578418732,
    -0.03552043437957764,
    -0.020636610686779022,
    0.1377113312482834,
    0.01688169687986374,
    0.01650683395564556,
    0.07918082922697067,
    0.030923474580049515,
    -0.013453016988933086,
    0.051868170499801636,
    0.019820770248770714,
    0.014979352243244648,
    -0.049856968224048615,
    -0.0518147312104702,
    -0.027913689613342285,
    0.027842333540320396,
    -0.015313610434532166,
    0.07719098031520844,
    -0.05144886299967766,
    0.02915739081799984,
    -0.09207922220230103,
    0.07845120131969452,
    0.0008724575745873153,
    0.03701944649219513,
    -0.04426152631640434,
    -0.08527659624814987,
    0.08318724483251572,
    0.037993598729372025,
    -0.006824377924203873,
    0.015222164802253246,
    0.07162341475486755,
    0.02818295545876026
  ]
}