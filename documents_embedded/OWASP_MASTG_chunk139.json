{
  "text": "However,ifsensitivedatadoesneedtobeexposedviamemory,makesurethatyourappexposesasfewcopiesofthis dataaspossibleforaslittletimeaspossible. Inotherwords,youwantcentralizedhandlingofsensitivedata,basedon primitiveandmutabledatastructures. Suchdatastructuresgivedevelopersdirectaccesstomemory. Makesurethatthisaccessisusedtooverwritethesensitive data and cryptographic keys with zeroes. Apple Secure Coding Guide suggests zeroing sensitive data after usage, but providesnorecommendedwaysofdoingthis. Examplesofpreferabledatatypesincludechar []andint [],butnotNSStringorString. Wheneveryoutrytomodify animmutableobject,suchasaString,youactuallycreateacopyandchangethecopy. ConsiderusingNSMutableData forstoringsecretsonSwift/Objective-CanduseresetBytes(in:) methodforzeroing. Also,seeCleanmemoryofsecret dataforreference. AvoidSwiftdatatypesotherthancollectionsregardlessofwhethertheyareconsideredmutable. ManySwiftdatatypes holdtheirdatabyvalue,notbyreference. Althoughthisallowsmodificationofthememoryallocatedtosimpletypeslike charandint,handlingacomplextypesuchasStringbyvalueinvolvesahiddenlayerofobjects,structures,orprimitive arrayswhosememorycan’tbedirectlyaccessedormodified. Certaintypesofusagemayseemtocreateamutabledata object (and even be documented as doing so), but they actually create a mutable identifier (variable) instead of an immutableidentifier(constant). Forexample,manythinkthatthefollowingresultsinamutableStringinSwift,butthis isactuallyanexampleofavariablewhosecomplexvaluecanbechanged(replaced,notmodifiedinplace): varstr1 =\"Goodbye\" //\"Goodbye\",baseaddress: 0x0001039e8dd0 str1.append(\"\") //\"Goodbye\",baseaddress: 0x608000064ae0 str1.append(\"cruelworld!\") //\"Goodbyecruelworld\",baseaddress:0x6080000338a0 str1.removeAll() //\"\",baseaddress 0x00010bd66180 Noticethatthebaseaddressoftheunderlyingvaluechangeswitheachstringoperation. Hereistheproblem: Tosecurely erase the sensitive information from memory, we don’t want to simply change the value of the variable; we want to changetheactualcontentofthememoryallocatedforthecurrentvalue. Swiftdoesn’toffersuchafunction. Swiftcollections(Array,Set,andDictionary),ontheotherhand,maybeacceptableiftheycollectprimitivedatatypes suchascharorintandaredefinedasmutable(i.e.,asvariablesinsteadofconstants),inwhichcasetheyaremoreor lessequivalenttoaprimitivearray(suchaschar []). Thesecollectionsprovidememorymanagement,whichcanresult inunidentifiedcopiesofthesensitivedatainmemoryifthecollectionneedstocopytheunderlyingbuffertoadifferent locationtoextendit. UsingmutableObjective-Cdatatypes,suchasNSMutableString,mayalsobeacceptable,butthesetypeshavethesame memory issue as Swift collections. Pay attention when using Objective-C collections; they hold data by reference, and onlyObjective-Cdatatypesareallowed. Therefore,wearelooking,notforamutablecollection,butforacollectionthat referencesmutableobjects. Aswe’veseensofar,usingSwiftorObjective-Cdatatypesrequiresadeepunderstandingofthelanguageimplementa- tion. Furthermore,therehasbeensomecorere-factoringinbetweenmajorSwiftversions,resultinginmanydatatypes’ behaviorbeingincompatiblewiththatofothertypes. Toavoidtheseissues,werecommendusingprimitivedatatypes wheneverdataneedstobesecurelyerasedfrommemory. Unfortunately, few libraries and frameworks are designed to allow sensitive data to be overwritten. Not even Apple considersthisissueintheofficialiOSSDKAPI.Forexample,mostoftheAPIsfordatatransformation(passers,serializes, etc.) operateonnon-primitivedatatypes. Similarly, regardlessofwhetheryouflagsomeUITextFieldasSecureText Entryornot,italwaysreturnsdataintheformofaStringorNSString. 405\\nIPC InterProcessCommunication(IPC)allowsprocessestosendeachothermessagesanddata. Forprocessesthatneedto communicatewitheachother,therearedifferentwaystoimplementIPConiOS: • XPC Services: XPC is a structured, asynchronous library that provides basic interprocess communication. It is managedbylaunchd. ItisthemostsecureandflexibleimplementationofIPConiOSandshouldbethepreferred method. It runs in the most restricted environment possible: sandboxed with no root privilege escalation and minimalfilesystemaccessandnetworkaccess. TwodifferentAPIsareusedwithXPCServices: – NSXPCConnectionAPI – XPCServicesAPI • MachPorts: AllIPCcommunicationultimatelyreliesontheMachKernelAPI.MachPortsallowlocalcommunication (intra-devicecommunication)only. TheycanbeimplementedeithernativelyorviaCoreFoundation(CFMachPort) andFoundation(NSMachPort)wrappers. • NSFileCoordinator: TheclassNSFileCoordinatorcanbeusedtomanageandsenddatatoandfromappsvia filesthatareavailableonthelocalfilesystemtovariousprocesses. NSFileCoordinatormethodsrunsynchronously, so your code will be blocked until they stop executing. That’s convenient because you don’t have to wait for an asynchronousblockcallback,butitalsomeansthatthemethodsblocktherunningthread. Checking Logs for Sensitive Data Platform: ios MASVSV1: MSTG-STORAGE-3 MASVSV2: MASVS-STORAGE-2 Overview Static Analysis Usethefollowingkeywordstochecktheapp’ssourcecodeforpredefinedandcustomloggingstatements: • Forpredefinedandbuilt-infunctions: – NSLog – NSAssert – NSCAssert – fprintf • Forcustomfunctions: – Logging – Logfile AgeneralizedapproachtothisissueistouseadefinetoenableNSLogstatementsfordevelopmentanddebugging,then disablethembeforeshippingthesoftware. YoucandothisbyaddingthefollowingcodetotheappropriatePREFIX_HEADER (*.pch)file: ##ifdefDEBUG ## defineNSLog(...)NSLog(__VA_ARGS__) ##else ## defineNSLog(...) ##endif Dynamic Analysis In the section “Monitoring System Logs” of the chapter “iOS Basic Security Testing” various methods for checking the devicelogsareexplained. Navigatetoascreenthatdisplaysinputfieldsthattakesensitiveuserinformation. After starting one of the methods, fill in the input fields. If sensitive data is displayed in the output, the app fails this test. 406\\nTesting Local Data Storage Platform: ios MASVSV1: MSTG-STORAGE-1,MSTG-STORAGE-2 MASVSV2: MASVS-STORAGE-1 Overview Static Analysis WhenyouhaveaccesstothesourcecodeofaniOSapp,identifysensitivedatathat’ssavedandprocessedthroughout the app. This includes passwords, secret keys, and personally identifiable information (PII), but it may as well include otherdataidentifiedassensitivebyindustryregulations,laws,andcompanypolicies. Lookforthisdatabeingsavedvia anyofthelocalstorageAPIslistedbelow. Makesurethatsensitivedataisneverstoredwithoutappropriateprotection. Forexample,authenticationtokensshould notbesavedinNSUserDefaultswithoutadditionalencryption. Alsoavoidstoringencryptionkeysin.plistfiles,hard- codedasstringsincode,orgeneratedusingapredictableobfuscationfunctionorkeyderivationfunctionbasedonstable attributes. SensitivedatashouldbestoredbyusingtheKeychainAPI(thatstorestheminsidetheSecureEnclave),orstoredencrypted using envelope encryption. Envelope encryption, or key wrapping, is a cryptographic construct that uses symmetric encryption to encapsulate key material. Data encryption keys (DEK) can be encrypted with key encryption keys (KEK) whichmustbesecurelystoredintheKeychain. EncryptedDEKcanbestoredinNSUserDefaultsorwritteninfiles. When required, application reads KEK, then decrypts DEK. Refer to OWASP Cryptographic Storage Cheat Sheet to learn more aboutencryptingcryptographickeys. Keychain TheencryptionmustbeimplementedsothatthesecretkeyisstoredintheKeychainwithsecuresettings,ideallykSe- cAttrAccessibleWhenPasscodeSetThisDeviceOnly. Thisensurestheusageofhardware-backedstoragemechanisms. MakesurethattheAccessControlFlagsaresetaccordingtothesecuritypolicyofthekeysintheKeyChain. GenericexamplesofusingtheKeyChaintostore,update,anddeletedatacanbefoundintheofficialAppledocumentation. TheofficialAppledocumentationalsoincludesanexampleofusingTouchIDandpasscodeprotectedkeys. Filesystem Usingthesourcecode,examinethedifferentAPIsusedtostoredatalocally. Makesurethatanydataisproperlyencrypted basedonitssensitivity. Dynamic Analysis Onewaytodeterminewhethersensitiveinformation(likecredentialsandkeys)isstoredinsecurelywithoutleveraging nativeiOSfunctionsistoanalyzetheapp’sdatadirectory. Triggeringallappfunctionalitybeforethedataisanalyzedis important because the app may store sensitive data only after specific functionality has been triggered. You can then performstaticanalysisforthedatadumpaccordingtogenerickeywordsandapp-specificdata. ThefollowingstepscanbeusedtodeterminehowtheapplicationstoresdatalocallyonajailbrokeniOSdevice: 1. Triggerthefunctionalitythatstorespotentiallysensitivedata. 2. ConnecttotheiOSdeviceandnavigatetoitsBundledirectory(thisappliestoiOSversions8.0andabove): /var/ mobile/Containers/Data/Application/$APP_ID/ 3. Executegrepwiththedatathatyou’vestored,forexample: grep -iRn \"USERID\". 4. Ifthesensitivedataisstoredinplaintext,theappfailsthistest. Youcananalyzetheapp’sdatadirectoryonanon-jailbrokeniOSdevicebyusingthird-partyapplications,suchasiMaz- ing. 407\\n1. Triggerthefunctionalitythatstorespotentiallysensitivedata. 2. ConnecttheiOSdevicetoyourhostcomputerandlaunchiMazing. 3. Select“Apps”,right-clickthedesirediOSapplication,andselect“ExtractApp”. 4. Navigatetotheoutputdirectoryandlocate$APP_NAME.imazing. Renameitto$APP_NAME.zip. 5. UnpacktheZIPfile. Youcanthenanalyzetheapplicationdata. NotethattoolslikeiMazingdon’tcopydatadirectlyfromthedevice. Theytrytoextractdatafromthebackupsthey create. Therefore,gettingalltheappdatathat’sstoredontheiOSdeviceisimpossible: notallfoldersareincluded inbackups. UseajailbrokendeviceorrepackagetheappwithFridaanduseatoollikeobjectiontoaccessallthe dataandfiles. IfyouaddedtheFridalibrarytotheappandrepackageditasdescribedin“DynamicAnalysisonNon-JailbrokenDevices” (from the “Tampering and Reverse Engineering on iOS” chapter), you can use",
  "metadata": {
    "doc_id": "OWASP_MASTG",
    "chunk_id": 139
  },
  "embedding": [
    -0.03988257795572281,
    -0.0020490013994276524,
    -0.03608668968081474,
    0.004407279659062624,
    -0.06369547545909882,
    0.009004618972539902,
    0.058366209268569946,
    -0.026770515367388725,
    -0.03148946911096573,
    0.025355607271194458,
    0.04598915949463844,
    -0.04046403616666794,
    0.04307846352458,
    -0.015400388278067112,
    -0.020862897858023643,
    0.0035069677978754044,
    0.08938973397016525,
    0.027781564742326736,
    -0.07597820460796356,
    0.05851834639906883,
    0.0885094702243805,
    -0.030495448037981987,
    0.05401099845767021,
    0.03285016492009163,
    0.026627257466316223,
    -0.00398725550621748,
    0.013462411239743233,
    -0.009226256050169468,
    0.006200024858117104,
    0.0018881108844652772,
    -0.00010857651068363339,
    0.018908122554421425,
    -0.0038478828500956297,
    0.09273646026849747,
    0.031198706477880478,
    -0.013479430228471756,
    0.049351032823324203,
    0.02269153855741024,
    -0.03031907044351101,
    -0.06949165463447571,
    -0.047212373465299606,
    0.012085248716175556,
    -0.10627017170190811,
    0.11442121118307114,
    -0.03374383971095085,
    0.027617072686553,
    0.047681987285614014,
    -0.03564494475722313,
    -0.06496640294790268,
    0.02237546630203724,
    0.03681829944252968,
    0.04374779388308525,
    -0.030116677284240723,
    0.05982225015759468,
    0.01658925972878933,
    0.01593661680817604,
    -0.04099956154823303,
    0.06443027406930923,
    0.025536421686410904,
    0.08969733864068985,
    0.06319472938776016,
    0.014401103369891644,
    0.027957623824477196,
    -0.02609848417341709,
    -0.035569943487644196,
    0.043871816247701645,
    0.011791836470365524,
    -0.05001872405409813,
    0.07716946303844452,
    -0.057107966393232346,
    -0.008574767969548702,
    -0.01431093830615282,
    -6.123402999946848e-05,
    0.04293516278266907,
    0.015222321264445782,
    0.05260986089706421,
    -0.025215350091457367,
    -0.03982070833444595,
    -0.059670258313417435,
    -0.07380945980548859,
    -0.023228755220770836,
    -0.024753641337156296,
    0.027684010565280914,
    0.06701182574033737,
    0.025735802948474884,
    0.012300558388233185,
    -0.008495272137224674,
    0.05520268902182579,
    0.01725691184401512,
    0.05932815000414848,
    -0.043383944779634476,
    -0.03261963278055191,
    0.02679038979113102,
    -0.04130617901682854,
    0.07193854451179504,
    -0.009229431860148907,
    -0.0355999656021595,
    -0.012540695257484913,
    -0.02763829194009304,
    -0.009618514217436314,
    -0.03294774517416954,
    -0.018518952652812004,
    -0.0821613296866417,
    -0.00757805397734046,
    0.07730533927679062,
    -0.01648654416203499,
    0.02395845204591751,
    -0.07501790672540665,
    0.015691332519054413,
    0.09538564831018448,
    0.03396958112716675,
    0.05062945932149887,
    0.009400354698300362,
    -0.008123139850795269,
    -0.03908864036202431,
    0.0382453054189682,
    -0.10904406756162643,
    0.04362647607922554,
    0.05255108326673508,
    0.019361311569809914,
    0.013143874704837799,
    -0.029540320858359337,
    0.05373796075582504,
    -0.0038668476045131683,
    -0.1158069521188736,
    -0.011942658573389053,
    0.024200746789574623,
    2.157731259024049e-32,
    -0.04356011003255844,
    0.011287440545856953,
    -0.004059604834765196,
    -0.015433716587722301,
    -0.03286759927868843,
    -0.040671344846487045,
    0.04934436082839966,
    0.08064375072717667,
    0.035884492099285126,
    -0.029061922803521156,
    0.0038542135152965784,
    0.07053134590387344,
    -0.0018609699327498674,
    -0.04953591525554657,
    0.020725905895233154,
    0.0016698386752977967,
    0.025501245632767677,
    0.008603986352682114,
    0.01578834094107151,
    -0.00874189380556345,
    0.05253366380929947,
    0.010007528588175774,
    -0.00804336927831173,
    -0.025815919041633606,
    0.02091219462454319,
    -0.03956799954175949,
    -0.01070734579116106,
    -0.04147323593497276,
    0.08267159759998322,
    0.03808749467134476,
    -0.07076537609100342,
    -0.01726001501083374,
    -0.09104936569929123,
    -0.03816727548837662,
    0.01866440661251545,
    -0.008455543778836727,
    0.02335396595299244,
    -0.04040111228823662,
    0.02432200126349926,
    -0.03455093130469322,
    0.0223966296762228,
    -0.03650369122624397,
    -0.05303966626524925,
    -0.08860675990581512,
    -0.011343419551849365,
    -0.04388302564620972,
    -0.004261035937815905,
    0.0038497799541801214,
    -0.026616699993610382,
    0.09011191874742508,
    0.009929408319294453,
    0.0030952473171055317,
    -0.01073479000478983,
    -0.10760325193405151,
    -0.12690792977809906,
    -0.056454382836818695,
    0.02615247294306755,
    -0.052838705480098724,
    0.018975336104631424,
    0.06950865685939789,
    -0.11015918850898743,
    0.026904115453362465,
    0.034108713269233704,
    -0.07852280139923096,
    -0.04988311231136322,
    0.042923521250486374,
    -0.0065642292611300945,
    -0.15733031928539276,
    -0.04732096195220947,
    -0.0347006693482399,
    -0.034396637231111526,
    0.023795785382390022,
    -0.0404927134513855,
    -0.0043048313818871975,
    -0.038460250943899155,
    0.0036947207991033792,
    0.023907789960503578,
    0.02875787392258644,
    -0.03824750334024429,
    -0.050843626260757446,
    0.08471356332302094,
    0.04836583882570267,
    0.04692095145583153,
    0.062312912195920944,
    -0.048928480595350266,
    -0.020149532705545425,
    6.214672612259164e-05,
    -0.09889576584100723,
    -0.08614586293697357,
    0.060622166842222214,
    0.020520785823464394,
    0.016687722876667976,
    -0.040172308683395386,
    -0.022273031994700432,
    -0.06776320189237595,
    -1.8858651296177783e-32,
    0.0022195661440491676,
    -0.0685410350561142,
    -0.08480537682771683,
    0.01910099759697914,
    -0.030137572437524796,
    -0.01996232196688652,
    -0.050387538969516754,
    0.062017884105443954,
    -0.005555232521146536,
    -0.07521217316389084,
    -0.00884532742202282,
    -0.07099587470293045,
    0.016528360545635223,
    -0.05543205887079239,
    -0.03493113070726395,
    -0.015633530914783478,
    -0.06514744460582733,
    -0.001701842644251883,
    -0.02655375935137272,
    0.09352925419807434,
    -0.012072142213582993,
    0.10321544110774994,
    -0.09008530527353287,
    0.026354622095823288,
    0.04606768488883972,
    0.035834070295095444,
    -0.05562567338347435,
    0.08274726569652557,
    0.05830283835530281,
    -0.016097750514745712,
    0.0038394848816096783,
    0.005747481714934111,
    -0.047117020934820175,
    -0.13620461523532867,
    -0.05125518515706062,
    -0.1021483987569809,
    -0.025183124467730522,
    0.003564938437193632,
    -0.05879073217511177,
    0.06753179430961609,
    0.0675659254193306,
    0.05760246515274048,
    -0.09565549343824387,
    0.018251096829771996,
    0.010618140920996666,
    -0.016300057992339134,
    -0.03368912264704704,
    0.03920590132474899,
    0.10639218240976334,
    0.07217641174793243,
    0.12146449089050293,
    -0.03607800975441933,
    -0.0012932150857523084,
    0.023150548338890076,
    0.021209577098488808,
    0.08498873561620712,
    0.10484922677278519,
    -0.031000161543488503,
    -8.104964217636734e-05,
    -0.0341680645942688,
    0.028633009642362595,
    -0.05982298031449318,
    0.11801024526357651,
    -0.018146762624382973,
    0.06343443691730499,
    0.021458670496940613,
    0.015397218056023121,
    -0.0604383759200573,
    -0.02918083965778351,
    0.04916378855705261,
    0.025690855458378792,
    -0.06412658840417862,
    -0.030189434066414833,
    -0.07879164069890976,
    0.09889071434736252,
    -0.041315287351608276,
    0.04309516027569771,
    -0.08215170353651047,
    -0.058556389063596725,
    0.022779209539294243,
    0.01093007531017065,
    0.09397471696138382,
    0.02614179253578186,
    0.08240338414907455,
    0.12225227802991867,
    0.040418218821287155,
    0.005987495183944702,
    -0.020020445808768272,
    -0.007491395343095064,
    0.05240487679839134,
    -0.06943438202142715,
    -0.01736488938331604,
    -0.09087905287742615,
    0.07622596621513367,
    -0.04868375509977341,
    -6.546145669972248e-08,
    -0.02085794135928154,
    -0.011373751796782017,
    0.0033888518810272217,
    0.03130856901407242,
    0.041833918541669846,
    -0.0024673028383404016,
    -0.024214059114456177,
    -0.031247301027178764,
    0.04341861605644226,
    -0.11088358610868454,
    0.045916423201560974,
    -0.01908869668841362,
    -0.10264869779348373,
    -0.026661979034543037,
    -0.003693648613989353,
    -0.01813400909304619,
    0.04940680414438248,
    -0.10555485635995865,
    -0.038594767451286316,
    -0.03356404975056648,
    -0.073539599776268,
    0.00758883822709322,
    -0.0920933410525322,
    -0.02912018448114395,
    0.07841856777667999,
    0.06542791426181793,
    0.0746016800403595,
    0.02881721407175064,
    0.053779229521751404,
    0.08136392384767532,
    -0.030899696052074432,
    -0.05411740392446518,
    0.08190470933914185,
    0.007582919206470251,
    -0.10189571231603622,
    0.04263673722743988,
    0.025919092819094658,
    0.027810582891106606,
    -0.02934080734848976,
    -0.017418067902326584,
    0.031537119299173355,
    0.02164500020444393,
    -0.04133935645222664,
    0.0564425066113472,
    -0.003957814536988735,
    -0.014660559594631195,
    0.06996936351060867,
    -0.010109308175742626,
    -0.044872820377349854,
    0.06731341034173965,
    -0.08064351975917816,
    -0.022404320538043976,
    -0.04743656516075134,
    0.09476745128631592,
    -0.07013177871704102,
    0.040019579231739044,
    0.04405958577990532,
    -0.0211457721889019,
    0.02139565907418728,
    0.033728234469890594,
    0.10329753905534744,
    -0.03299475461244583,
    -0.0050592138431966305,
    0.006763522978872061
  ]
}