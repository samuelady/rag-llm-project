{
  "text": "Typesandit’sreadytoopenfileswiththeextensionslistedinUTTypeTagSpecification/\"public.filename-extension\". Pleasetakeanoteofthisbecauseitwillbeusefulifyouwanttosearchforvulnerabilitieswhendealingwiththedifferent typesoffileswhenperformingdynamicanalysis. Dynamic Analysis Sending Items Therearethreemainthingsyoucaneasilyinspectbyperformingdynamicinstrumentation: • TheactivityItems: anarrayoftheitemsbeingshared. Theymightbeofdifferenttypes,e.g.onestringandone picturetobesharedviaamessagingapp. • TheapplicationActivities: anarrayofUIActivityobjectsrepresentingtheapp’scustomservices. • TheexcludedActivityTypes: anarrayoftheActivityTypesthatarenotsupported,e.g.postToFacebook. Toachievethisyoucandotwothings: 483\\n• Hookthemethodwehaveseeninthestaticanalysis(init(activityItems: applicationActivities:)) toget theactivityItemsandapplicationActivities. • FindouttheexcludedactivitiesbyhookingexcludedActivityTypesproperty. Let’sseeanexampleusingTelegramtoshareapictureandatextfile. Firstpreparethehooks,wewillusetheFridaREPL andwriteascriptforthis: Interceptor.attach( ObjC.classes. UIActivityViewController['-initWithActivityItems:applicationActivities:'].implementation,{ onEnter:function (args){ printHeader(args) this.initWithActivityItems =ObjC.Object(args[2]); this.applicationActivities =ObjC.Object(args[3]); console.log(\"initWithActivityItems:\" +this.initWithActivityItems); console.log(\"applicationActivities:\" +this.applicationActivities); }, onLeave:function (retval){ printRet(retval); } }); Interceptor.attach( ObjC.classes.UIActivityViewController['-excludedActivityTypes'].implementation,{ onEnter:function (args){ printHeader(args) }, onLeave:function (retval){ printRet(retval); } }); function printHeader(args){ console.log(Memory.readUtf8String(args[1])+\"@\" +args[1]) }; function printRet(retval){ console.log('RET@' +retval +':' ); try{ console.log(newObjC.Object(retval).toString()); }catch (e){ console.log(retval.toString()); } }; YoucanstorethisasaJavaScriptfile,e.g.inspect_send_activity_data.jsandloaditlikethis: frida -UTelegram -linspect_send_activity_data.js Nowobservetheoutputwhenyoufirstshareapicture: [*]initWithActivityItems:applicationActivities:@0x18c130c07 initWithActivityItems:( \"<UIImage:0x1c4aa0b40>size{571,264}orientation0scale1.000000\" ) applicationActivities:nil RET@ 0x13cb2b800: <UIActivityViewController:0x13cb2b800> [*]excludedActivityTypes@ 0x18c0f8429 RET@ 0x0: nil andthenatextfile: [*]initWithActivityItems:applicationActivities:@0x18c130c07 initWithActivityItems:( \"<QLActivityItemProvider:0x1c4a30140>\", \"<UIPrintInfo:0x1c0699a50>\" ) applicationActivities:( ) RET@ 0x13c4bdc00: <_UIDICActivityViewController:0x13c4bdc00> [*]excludedActivityTypes@ 0x18c0f8429 484\\nRET@ 0x1c001b1d0: ( \"com.apple.UIKit.activity.MarkupAsPDF\" ) Youcanseethat: • Forthepicture,theactivityitemisaUIImageandtherearenoexcludedactivities. • Forthetextfiletherearetwodifferentactivityitemsandcom.apple.UIKit.activity. MarkupAsPDFisexcluded. In the previous example, there were no custom applicationActivities and only one excluded activity. However, to betterillustratewhatyoucanexpectfromotherappswehavesharedapictureusinganotherapp,hereyoucanseea bunchofapplicationactivitiesandexcludedactivities(outputwaseditedtohidethenameoftheoriginatingapp): [*]initWithActivityItems:applicationActivities:@0x18c130c07 initWithActivityItems:( \"<SomeActivityItemProvider:0x1c04bd580>\" ) applicationActivities:( \"<SomeActionItemActivityAdapter:0x141de83b0>\", \"<SomeActionItemActivityAdapter:0x147971cf0>\", \"<SomeOpenInSafariActivity:0x1479f0030>\", \"<SomeOpenInChromeActivity:0x1c0c8a500>\" ) RET@ 0x142138a00: <SomeActivityViewController:0x142138a00> [*]excludedActivityTypes@ 0x18c0f8429 RET@ 0x14797c3e0: ( \"com.apple.UIKit.activity.Print\", \"com.apple.UIKit.activity.AssignToContact\", \"com.apple.UIKit.activity.SaveToCameraRoll\", \"com.apple.UIKit.activity.CopyToPasteboard\", ) Receiving Items After performing the static analysis you would know the document types that the app can open and if it declares any customdocumenttypesand(partof)themethodsinvolved. Youcanusethisnowtotestthereceivingpart: • ShareafilewiththeappfromanotherapporsenditviaAirDropore-mail. Choosethefilesothatitwilltriggerthe “Openwith...”dialogue(thatis,thereisnodefaultappthatwillopenthefile,aPDFforexample). • Hookapplication:openURL:options: andanyothermethodsthatwereidentifiedinapreviousstaticanalysis. • Observetheappbehavior. • Inaddition,youcouldsendspecificmalformedfilesand/oruseafuzzingtechnique. Toillustratethiswithanexamplewehavechosenthesamereal-worldfilemanagerappfromthestaticanalysissection andfollowedthesesteps: 1. SendaPDFfilefromanotherAppledevice(e.g.aMacBook)viaAirdrop. 2. WaitfortheAirDroppopuptoappearandclickonAccept. 3. Asthereisnodefaultappthatwillopenthefile,itswitchestotheOpenwith...popup. There,wecanselecttheapp thatwillopenourfile. Thenextscreenshotshowsthis(wehavemodifiedthedisplaynameusingFridatoconceal theapp’srealname): 485\\n4. AfterselectingSomeFileManagerwecanseethefollowing: (0x1c4077000) -[AppDelegateapplication:openURL:options:] application: <UIApplication:0x101c00950> openURL:file:///var/mobile/Library/Application%20Support /Containers/com.some.filemanager/Documents/Inbox/OWASP_MASVS.pdf options:{ UIApplicationOpenURLOptionsAnnotationKey= { LSMoveDocumentOnOpen= 1; }; UIApplicationOpenURLOptionsOpenInPlaceKey= 0; UIApplicationOpenURLOptionsSourceApplicationKey= \"com.apple.sharingd\"; \"_UIApplicationOpenURLOptionsSourceProcessHandleKey\" =\"<FBSProcessHandle:0x1c3a63140; sharingd:605;valid:YES>\"; } 0x18c7930d8UIKit!__58-[UIApplication _applicationOpenURLAction:payload:origin:]_block_invoke ... 0x1857cdc34FrontBoardServices!-[FBSSerialQueue _performNextFromRunLoopSource] RET:0x1 Asyou cansee, thesending applicationiscom.apple.sharingd andthe URL’sscheme isfile://. Note that oncewe selecttheappthatshouldopenthefile,thesystemalreadymovedthefiletothecorrespondingdestination,thatistothe app’sInbox. TheappsarethenresponsiblefordeletingthefilesinsidetheirInboxes. Thisapp,forexample,movesthe 486\\nfileto/var/mobile/Documents/andremovesitfromtheInbox. (0x1c002c760) -[XXFileManagermoveItemAtPath:toPath:error:] moveItemAtPath:/var/mobile/Library/ApplicationSupport/Containers /com.some.filemanager/Documents/Inbox/OWASP_MASVS.pdf toPath:/var/mobile/Documents/OWASP_MASVS (1).pdf error:0x16f095bf8 0x100f24e90SomeFileManager!-[AppDelegate__handleOpenURL:] 0x100f25198SomeFileManager!-[AppDelegateapplication:openURL:options:] 0x18c7930d8UIKit!__58-[UIApplication_applicationOpenURLAction:payload:origin:]_block_invoke ... 0x1857cd9f4FrontBoardServices!__FBSSERIALQUEUE_IS_CALLING_OUT_TO_A_BLOCK__ RET:0x1 Ifyoulookatthestacktrace,youcanseehowapplication:openURL:options: called__handleOpenURL:,whichcalled moveItemAtPath:toPath:error:. Noticethatwehavenowthisinformationwithouthavingthesourcecodeforthetarget app. Thefirstthingthatwehadtodowasclear: hookapplication:openURL:options:. Regardingtherest,wehadto thinkalittlebitandcomeupwithmethodsthatwecouldstarttracingandarerelatedtothefilemanager,forexample, all methods containing the strings “copy”, “move”, “remove”, etc. until we have found that the one being called was moveItemAtPath:toPath:error:. AfinalthingworthnoticinghereisthatthiswayofhandlingincomingfilesisthesameforcustomURLschemes. Please refertothe“TestingCustomURLSchemes”sectionformoreinformation. Testing Universal Links Platform: ios MASVSV1: MSTG-PLATFORM-4 MASVSV2: MASVS-PLATFORM-1 Overview Static Analysis Testinguniversallinksonastaticapproachincludesdoingthefollowing: • CheckingtheAssociatedDomainsentitlement • RetrievingtheAppleAppSiteAssociationfile • Checkingthelinkreceivermethod • Checkingthedatahandlermethod • Checkingiftheappiscallingotherapp’suniversallinks Checking the Associated Domains Entitlement UniversallinksrequirethedevelopertoaddtheAssociatedDomainsentitlementandincludeinitalistofthedomains thattheappsupports. InXcode,gototheCapabilitiestabandsearchforAssociatedDomains. Youcanalsoinspectthe.entitlementsfile lookingforcom.apple.developer.associated-domains. Eachofthedomainsmustbeprefixedwithapplinks:,suchas applinks:www.mywebsite.com. Here’sanexamplefromTelegram’s.entitlementsfile: <key>com.apple.developer.associated-domains</key> <array> <string>applinks:telegram.me</string> <string>applinks:t.me</string> </array> MoredetailedinformationcanbefoundinthearchivedAppleDeveloperDocumentation. Ifyoudon’thavetheoriginalsourcecodeyoucanstillsearchforthem,asexplainedin“EntitlementsEmbeddedinthe CompiledAppBinary”. 487\\nRetrieving the Apple App Site Association File Try to retrieve the apple-app-site-association file from the server using the associated domains you got from the previousstep. ThisfileneedstobeaccessibleviaHTTPS,withoutanyredirects,athttps://<domain>/apple-app-site- associationorhttps://<domain>/.well-known/apple-app-site-association. You can retrieve it yourself using your browser and navigating to https://<domain>/apple-app-site-association, https://<domain>/.well-known/apple-app-site-association or using Apple’s CDN at https://app-site- association.cdn-apple.com/a/v1/<domain>. Alternatively,youcanusetheAppleAppSiteAssociation(AASA)Validator. Afterenteringthedomain,itwilldisplaythe file,verifyitforyouandshowtheresults(e.g.ifitisnotbeingproperlyservedoverHTTPS).Seethefollowingexample fromapple.comhttps://www.apple.com/.well-known/apple-app-site-association: { \"activitycontinuation\":{ \"apps\":[ \"W74U47NE8E.com.apple.store.Jolly\" ] }, \"applinks\":{ \"apps\":[], \"details\":[ { \"appID\":\"W74U47NE8E.com.apple.store.Jolly\", \"paths\":[ \"NOT/shop/buy-iphone/*\", \"NOT/us/shop/buy-iphone/*\", \"/xc/*\", \"/shop/buy-*\", \"/shop/product/*\", \"/shop/bag/shared_bag/*\", \"/shop/order/list\", \"/today\", \"/shop/watch/watch-accessories\", \"/shop/watch/watch-accessories/*\", \"/shop/watch/bands\", ]}]} } The “details” key inside “applinks” contains a JSON representation of an array that might contain one or more apps. The“appID”shouldmatchthe“application-identifier”keyfromtheapp’sentitlements. Next,usingthe“paths”key,the developers can specify certain paths to be handled on a per app basis. Some apps, like Telegram use a standalone * (\"paths\":[\"*\"])inordertoallowallpossiblepaths. Onlyifspecificareasofthewebsiteshouldnotbehandledbysome app,thedevelopercanrestrictaccessbyexcludingthembyprependinga\"NOT\"(notethewhitespaceaftertheT)tothe correspondingpath. Alsorememberthatthesystemwilllookformatchesbyfollowingtheorderofthedictionariesinthe array(firstmatchwins). Thispathexclusionmechanismisnottobeseenasasecurityfeaturebutratherasafilterthatdevelopermightuseto specifywhichappsopenwhichlinks. Bydefault,iOSdoesnotopenanyunverifiedlinks. Rememberthatuniversallinksverificationoccursatinstallationtime. iOSretrievestheAASAfileforthedeclareddomains (applinks) in its com.apple.developer.associated-domains entitlement. iOS will refuse to open those links if the verificationdidnotsucceed. Somereasonstofailverificationmightinclude: 488\\n• TheAASAfileisnotservedoverHTTPS. • TheAASAisnotavailable. • TheappIDsdonotmatch(thiswouldbethecaseofamaliciousapp). iOSwouldsuccessfullypreventanypossible hijackingattacks. Checking the Link Receiver Method",
  "metadata": {
    "doc_id": "OWASP_MASTG",
    "chunk_id": 159
  },
  "embedding": [
    -0.003467221511527896,
    -0.013588954694569111,
    -0.02063072845339775,
    0.01725243218243122,
    0.05112329125404358,
    -0.005308124702423811,
    0.0691249743103981,
    0.06048370525240898,
    -0.009439729154109955,
    0.01797325909137726,
    0.027348842471837997,
    -0.02936476096510887,
    0.011725007556378841,
    0.03057861328125,
    -0.015239517204463482,
    0.03404337167739868,
    -0.024036690592765808,
    -0.048477619886398315,
    -0.06263504177331924,
    0.0920199528336525,
    0.026955028995871544,
    0.0087216105312109,
    0.06312879174947739,
    -0.024518849328160286,
    0.03872867301106453,
    0.021869556978344917,
    -0.09564175456762314,
    -0.10174234956502914,
    -0.07056349515914917,
    -0.018567301332950592,
    0.04705226793885231,
    0.03797014802694321,
    0.03990255296230316,
    0.018360760062932968,
    0.05939667671918869,
    0.05127262696623802,
    0.0110783027485013,
    -0.04969770088791847,
    -0.03471696376800537,
    -0.03136488050222397,
    0.01618516445159912,
    0.017355123534798622,
    -0.021972689777612686,
    0.013165299780666828,
    -0.08587802946567535,
    -0.05479762330651283,
    0.0012546313228085637,
    -0.12149082124233246,
    -0.06241535767912865,
    0.03838914632797241,
    -0.0666523426771164,
    0.030449839308857918,
    -0.051860008388757706,
    0.08365822583436966,
    -0.03743962571024895,
    0.01359735056757927,
    -0.04416311904788017,
    0.04994747415184975,
    0.033504918217659,
    0.07807208597660065,
    0.05359475314617157,
    -0.046119850128889084,
    -0.033273518085479736,
    -0.027587831020355225,
    -0.03780536353588104,
    0.10130101442337036,
    0.0008087189053185284,
    -0.0546245202422142,
    0.053395386785268784,
    -0.06828813999891281,
    -0.037655845284461975,
    0.0049728089943528175,
    -0.06027134507894516,
    0.022485125809907913,
    0.03323708102107048,
    -0.024319682270288467,
    0.012202838435769081,
    0.01783670298755169,
    -0.019674545153975487,
    -0.1699247509241104,
    0.017632178962230682,
    -0.013500882312655449,
    0.03837393596768379,
    0.035400062799453735,
    0.04577431455254555,
    0.054849885404109955,
    -0.030559970065951347,
    -0.08637328445911407,
    -0.019405558705329895,
    0.025563951581716537,
    -0.06448087096214294,
    -0.009774806909263134,
    -0.05234798416495323,
    0.014202505350112915,
    0.016550492495298386,
    -0.046031367033720016,
    -0.08844543993473053,
    0.0009599135373719037,
    0.003990165889263153,
    0.0849212184548378,
    0.01332766842097044,
    0.030714483931660652,
    -0.021180732175707817,
    -0.014504029415547848,
    0.057426925748586655,
    -0.09846565127372742,
    0.05173371732234955,
    -0.047644615173339844,
    -0.04300789162516594,
    0.025991933420300484,
    -0.014683876186609268,
    -0.031680986285209656,
    0.00040809958591125906,
    -0.10125552117824554,
    0.004604749847203493,
    0.021090520545840263,
    -0.008937560021877289,
    0.06716281175613403,
    0.027960490435361862,
    0.023956166580319405,
    0.09156476706266403,
    -0.0318785235285759,
    0.04196181520819664,
    -0.07350782305002213,
    -0.009726999327540398,
    -0.04376503452658653,
    -0.05564431846141815,
    2.4631264546092057e-32,
    -0.013344994746148586,
    -0.049134429544210434,
    0.03450620919466019,
    0.08855956792831421,
    -0.012413392774760723,
    -0.05528824403882027,
    0.009607470594346523,
    0.07399009168148041,
    0.020909292623400688,
    -0.039102330803871155,
    -0.0322311595082283,
    0.07403478771448135,
    -0.017853369936347008,
    0.08701552450656891,
    -0.018846770748496056,
    -0.05153656378388405,
    -0.03638368472456932,
    0.06449621915817261,
    -0.01257240492850542,
    0.029912544414401054,
    -0.027729617431759834,
    -0.026768764480948448,
    -0.033951569348573685,
    0.03329629451036453,
    -0.04684716463088989,
    -0.008656014688313007,
    0.06947577744722366,
    0.010776666924357414,
    0.01678362302482128,
    0.027735469862818718,
    -0.0038897080812603235,
    -0.03353031352162361,
    -0.07031283527612686,
    -0.045189086347818375,
    0.003493724623695016,
    -0.03790291026234627,
    -0.01762837916612625,
    -0.008442981168627739,
    0.002096678828820586,
    -0.0524396076798439,
    -0.013433476909995079,
    0.005247705616056919,
    -0.10232648998498917,
    -0.0069869388826191425,
    -0.024638382717967033,
    -0.001275107148103416,
    -0.025021858513355255,
    0.009585736319422722,
    -0.020272422581911087,
    -0.00434279115870595,
    0.04745659604668617,
    -0.006854502949863672,
    0.09289161115884781,
    -0.019126012921333313,
    -0.08715121448040009,
    -0.03499738872051239,
    -0.05998409539461136,
    0.038774456828832626,
    0.059249814599752426,
    0.034007441252470016,
    0.0230646263808012,
    0.029446085914969444,
    0.0033692035358399153,
    -0.027683308348059654,
    0.025138091295957565,
    0.014931172132492065,
    0.024770185351371765,
    -0.07246202230453491,
    -0.01668275147676468,
    -0.11935941129922867,
    -0.04673454537987709,
    0.02018514648079872,
    -0.012922476045787334,
    -0.0072405473329126835,
    0.04274493083357811,
    -0.0716686025261879,
    -0.010703678242862225,
    0.006589929573237896,
    -0.015248831361532211,
    -0.021117601543664932,
    -0.0007332065724767745,
    -0.04976809397339821,
    0.06436992436647415,
    -0.055770788341760635,
    -0.10780748724937439,
    -0.015116237103939056,
    -0.0008153307135216892,
    -0.1642436534166336,
    -0.05371259152889252,
    0.029203180223703384,
    -0.03331367298960686,
    0.04440079629421234,
    -0.09138644486665726,
    0.019640551880002022,
    0.011896541342139244,
    -2.231665004776574e-32,
    0.02863016352057457,
    -0.007961182855069637,
    -0.14406359195709229,
    -0.05392953008413315,
    0.04693058505654335,
    0.04637904465198517,
    -0.017462972551584244,
    0.06955043971538544,
    0.025724496692419052,
    0.0048932963982224464,
    0.07881462574005127,
    -0.005949480924755335,
    -0.09763379395008087,
    -0.06583651155233383,
    -0.012092952616512775,
    0.031783685088157654,
    -0.008104097098112106,
    -0.03711645305156708,
    -0.04568842798471451,
    0.05953674390912056,
    -0.040774520486593246,
    0.07738330215215683,
    0.023380888625979424,
    0.05078401416540146,
    0.06655163317918777,
    0.06735213100910187,
    0.021980751305818558,
    0.046439029276371,
    0.052936822175979614,
    -0.03361549973487854,
    0.019061770290136337,
    0.030893318355083466,
    -0.13135872781276703,
    -0.03032231144607067,
    0.03584262728691101,
    -0.06809438765048981,
    -0.03675433248281479,
    0.006519815884530544,
    0.015534649603068829,
    0.024068553000688553,
    0.09221837669610977,
    0.0076513150706887245,
    0.039960768073797226,
    0.04254225268959999,
    0.0573887899518013,
    -0.0596877820789814,
    -0.012705829925835133,
    8.621910092188045e-05,
    0.014585601165890694,
    0.07223166525363922,
    0.07419566065073013,
    -0.03506844863295555,
    -0.02349398098886013,
    -0.0014448973815888166,
    0.03525411710143089,
    0.08033299446105957,
    0.12875469028949738,
    -0.09743915498256683,
    -0.094443179666996,
    -0.03625570237636566,
    0.059687938541173935,
    -0.05287234112620354,
    -0.008620541542768478,
    -0.043839503079652786,
    0.0668850690126419,
    0.014345912262797356,
    0.04281903803348541,
    -0.057144589722156525,
    -0.030522214248776436,
    0.03001999296247959,
    -0.019707465544342995,
    -0.04441487044095993,
    -0.030452920123934746,
    -0.08755207061767578,
    0.053592972457408905,
    -0.017214836552739143,
    0.07050804793834686,
    -0.10136604309082031,
    -0.03357435017824173,
    -0.03339839354157448,
    -0.03482704237103462,
    0.012744933366775513,
    0.026241326704621315,
    -0.01322232373058796,
    0.004612734075635672,
    -0.0392540879547596,
    -0.09888965636491776,
    0.003473534481599927,
    -0.032592758536338806,
    0.03794579580426216,
    -0.043262332677841187,
    -0.010119618847966194,
    0.000407395011279732,
    0.05947192385792732,
    -0.0030326927080750465,
    -7.97419730247384e-08,
    -0.06940362602472305,
    -0.0440213717520237,
    -0.010130723007023335,
    0.021527227014303207,
    0.07749749720096588,
    0.03976374864578247,
    -0.01464871782809496,
    0.028375133872032166,
    0.012293480336666107,
    -0.14222998917102814,
    -0.004346042405813932,
    -0.029075678437948227,
    -0.041324127465486526,
    0.0028801618609577417,
    0.04213079437613487,
    -0.12147025763988495,
    0.05913608893752098,
    0.00572849391028285,
    -0.08598965406417847,
    0.0278264582157135,
    -0.015252219513058662,
    -0.03751435875892639,
    -0.023727944120764732,
    -0.0401005856692791,
    0.027963858097791672,
    0.035978320986032486,
    0.07851224392652512,
    0.03069376014173031,
    0.02338218502700329,
    0.035893186926841736,
    0.054117098450660706,
    0.02553473226726055,
    0.005862641613930464,
    -0.017408862709999084,
    -0.11917150765657425,
    0.12254254519939423,
    0.058207638561725616,
    -0.0413074865937233,
    -0.020943934097886086,
    -0.0015407262835651636,
    0.03430958464741707,
    0.009513982571661472,
    0.00775739923119545,
    0.05245941877365112,
    0.024173326790332794,
    -0.021276036277413368,
    -0.026257602497935295,
    0.06705783307552338,
    0.05091368407011032,
    0.039171572774648666,
    -0.12139417976140976,
    0.019761517643928528,
    -0.025499751791357994,
    0.10091637074947357,
    -0.0954432263970375,
    0.0129524115473032,
    0.10567420721054077,
    -0.017748970538377762,
    0.08997341245412827,
    0.08215715736150742,
    0.10704925656318665,
    -0.023852994665503502,
    0.04051591083407402,
    0.03600502386689186
  ]
}