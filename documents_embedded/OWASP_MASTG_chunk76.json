{
  "text": "Asanadditionallayerofsecurity,pushnotificationscanbeencryptedbyusingCapillary. Capillaryisalibrarytosimplify thesendingofend-to-end(E2E)encryptedpushmessagesfromJava-basedapplicationserverstoAndroidclients. Reviewing Disassembled Native Code Platform: android Followingtheexamplefrom“DisassemblingNativeCode”wewillusedifferentdisassemblerstoreviewthedisassembled nativecode. radare2 Onceyou’veopenedyourfileinradare2youshouldfirstgettheaddressofthefunctionyou’relookingfor. Youcandothis bylistingorgettinginformationiaboutthesymbolss(is)andgrepping(~radare2’sbuilt-ingrep)forsomekeyword,in ourcasewe’relookingforJNIrelatedsymbolssoweenter“Java”: $r2 -AHelloWord-JNI/lib/armeabi-v7a/libnative-lib.so ... [0x00000e3c]>is~Java 0030x00000e780x00000e78GLOBAL FUNC 16Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI Themethodcanbefoundataddress0x00000e78. Todisplayitsdisassemblysimplyrunthefollowingcommands: [0x00000e3c]>eemu.str=true; [0x00000e3c]>s0x00000e78 [0x00000e78]>af [0x00000e78]>pdf ╭(fcn)sym.Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI12 │ sym.Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI (int32_targ1); │ ;argint32_targ1@r0 │ 0x00000e78 ~ 0268 ldrr2, [r0] ;arg1 │ ;--aav.0x00000e79: │ ;UNKNOWNXREFfromaav.0x00000189 (+0x3) │ 0x00000e79 unaligned │ 0x00000e7a 0249 ldrr1,aav.0x00000f3c ;[0xe84:4]=0xf3caav.0x00000f3c │ 0x00000e7c d2f89c22 ldr.wr2,[r2,0x29c] │ 0x00000e80 7944 addr1,pc ;\"HellofromC++\" section..rodata ╰ 0x00000e82 1047 bxr2 Let’sexplainthepreviouscommands: 171\\n• eemu.str=true;enablesradare2’sstringemulation. Thankstothis,wecanseethestringwe’relookingfor(“Hello fromC++”). • s 0x00000e78isaseektotheaddresss 0x00000e78,whereourtargetfunctionislocated. Wedothissothatthe followingcommandsapplytothisaddress. • pdfmeansprintdisassemblyoffunction. Usingradare2youcanquicklyruncommandsandexitbyusingtheflags-qc '<commands>'. Fromthepreviousstepswe knowalreadywhattodosowewillsimplyputeverythingtogether: $r2 -qc'eemu.str=true;s0x00000e78;af;pdf' HelloWord-JNI/lib/armeabi-v7a/libnative-lib.so ╭(fcn)sym.Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI12 │ sym.Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI (int32_targ1); │ ;argint32_targ1@r0 │ 0x00000e78 0268 ldrr2, [r0] ;arg1 │ 0x00000e7a 0249 ldrr1, [0x00000e84] ;[0xe84:4]=0xf3c │ 0x00000e7c d2f89c22 ldr.wr2,[r2,0x29c] │ 0x00000e80 7944 addr1,pc ;\"HellofromC++\" section..rodata ╰ 0x00000e82 1047 bxr2 Noticethatinthiscasewe’renotstartingwiththe-Aflagnotrunningaaa. Instead,wejusttellradare2toanalyzethat onefunctionbyusingtheanalyzefunctionafcommand. Thisisoneofthosecaseswherewecanspeedupourworkflow becauseyou’refocusingonsomespecificpartofanapp. Theworkflowcanbefurtherimprovedbyusingr2ghidra,adeepintegrationofGhidradecompilerforradare2. r2ghidra generatesdecompiledCcode,whichcanaidinquicklyanalyzingthebinary. IDA Pro Weassumethatyou’vesuccessfullyopenedlib/armeabi-v7a/libnative-lib.soinIDApro. Oncethefileisloaded,click intothe“Functions”windowontheleftandpressAlt+ttoopenthesearchdialog. Enter“java”andhitenter. Thisshould highlight the Java_sg_vantagepoint_helloworld_ MainActivity_stringFromJNI function. Double-click the function tojumptoitsaddressinthedisassemblyWindow. “IdaView-A”shouldnowshowthedisassemblyofthefunction. Notalotofcodethere,butyoushouldanalyzeit. Thefirstthingyouneedtoknowisthatthefirstargumentpassedto everyJNIfunctionisaJNIinterfacepointer. Aninterfacepointerisapointertoapointer. Thispointerpointstoafunction table: anarrayofevenmorepointers,eachofwhichpointstoaJNIinterfacefunction(isyourheadspinningyet?). The functiontableisinitializedbytheJavaVMandallowsthenativefunctiontointeractwiththeJavaenvironment. Withthatinmind,let’shavealookateachlineofassemblycode. 172\\nLDR R2,[R0] Remember: thefirstargument(inR0)isapointertotheJNIfunctiontablepointer. TheLDRinstructionloadsthisfunction tablepointerintoR2. LDR R1,=aHelloFromC ThisinstructionloadsintoR1thePC-relativeoffsetofthestring“HellofromC++”. Notethatthisstringcomesdirectly after the end of the function block at offset 0xe84. Addressing relative to the program counter allows the code to run independentlyofitspositioninmemory. LDR.W R2,[R2,#0x29C] Thisinstructionloadsthefunctionpointerfromoffset0x29CintotheJNIfunctionpointertablepointedtobyR2. Thisis theNewStringUTFfunction. Youcanlookatthelistoffunctionpointersinjni.h,whichisincludedintheAndroidNDK.The functionprototypelookslikethis: jstring (*NewStringUTF)(JNIEnv*,const char*); Thefunctiontakestwoarguments: theJNIEnvpointer(alreadyinR0)andaStringpointer. Next,thecurrentvalueofPC isaddedtoR1,resultingintheabsoluteaddressofthestaticstring“HellofromC++”(PC+offset). ADD R1,PC Finally,theprogramexecutesabranchinstructiontotheNewStringUTFfunctionpointerloadedintoR2: BX R2 Whenthisfunctionreturns,R0containsapointertothenewlyconstructedUTFstring. Thisisthefinalreturnvalue,soR0 isleftunchangedandthefunctionreturns. Ghidra AfteropeningthelibraryinGhidrawecanseeallthefunctionsdefinedintheSymbolTreepanelunderFunctions. The nativelibraryforthecurrentapplicationisrelativelyverysmall. Therearethreeuserdefinedfunctions: FUN_001004d0, FUN_0010051c,andJava_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI.Theothersymbolsarenot userdefinedandaregeneratedforproperfunctioningofthesharedlibrary. TheinstructionsinthefunctionJava_sg_- vantagepoint_helloworldjni_MainActivity_stringFromJNI are already discussed in detail in previous sections. In thissectionwecanlookintothedecompilationofthefunction. Inside the current function there is a call to another function, whose address is obtained by accessing an offset in the JNIEnvpointer(foundasplParm1). Thislogichasbeendiagrammaticallydemonstratedaboveaswell. Thecorresponding CcodeforthedisassembledfunctionisshownintheDecompilerwindow. ThisdecompiledCcodemakesitmucheasier tounderstandthefunctioncallbeingmade. Sincethisfunctionissmallandextremelysimple,thedecompilationoutput isveryaccurate,thiscanchangedrasticallywhendealingwithcomplexfunctions. 173\\nDisassembling Native Code Platform: android Dalvik and ART both support the Java Native Interface (JNI), which defines a way for Java code to interact with native codewritteninC/C++. AsonotherLinux-basedoperatingsystems,nativecodeispackaged(compiled)intoELFdynamic libraries (*.so), which the Android app loads at runtime via the System.load method. However, instead of relying on widelyusedClibraries(suchasglibc),AndroidbinariesarebuiltagainstacustomlibcnamedBionic. Bionicaddssupport forimportantAndroid-specificservicessuchassystempropertiesandlogging,anditisnotfullyPOSIX-compatible. WhenreversinganAndroidapplicationcontainingnativecode,weneedtounderstandacoupleofdatastructuresrelated totheJNIbridgebetweenJavaandnativecode. Fromthereversingperspective, weneedtobeawareoftwokeydata structures: JavaVMandJNIEnv. Bothofthemarepointerstopointerstofunctiontables: • JavaVM provides an interface to invoke functions for creating and destroying a JavaVM. Android allows only one JavaVMperprocessandisnotreallyrelevantforourreversingpurposes. • JNIEnvprovidesaccesstomostoftheJNIfunctionswhichareaccessibleatafixedoffsetthroughtheJNIEnvpointer. ThisJNIEnvpointeristhefirstparameterpassedtoeveryJNIfunction. Wewilldiscussthisconceptagainwiththe helpofanexamplelaterinthischapter. ItisworthhighlightingthatanalyzingdisassemblednativecodeismuchmorechallengingthandisassembledJavacode. WhenreversingthenativecodeinanAndroidapplicationwewillneedadisassembler. Inthenextexamplewe’llreversetheHelloWorld-JNI.apkfromtheOWASPMASTGrepository. Installingandrunningitin anemulatororAndroiddeviceisoptional. wget https://github.com/OWASP/owasp-mastg/raw/master/Samples/Android/01_HelloWorld-JNI/HelloWord-JNI.apk Thisappisnotexactlyspectacular,allitdoesisshowalabelwiththetext“HellofromC++”. ThisistheappAndroid generatesbydefaultwhenyoucreateanewprojectwithC/C++support, whichisjustenoughtoshowthebasic principlesofJNIcalls. 174\\nDecompiletheAPKwithapkx. $apkxHelloWord-JNI.apk ExtractingHelloWord-JNI.apktoHelloWord-JNI Converting:classes.dex ->classes.jar (dex2jar) dex2jarHelloWord-JNI/classes.dex ->HelloWord-JNI/classes.jar DecompilingtoHelloWord-JNI/src (cfr) ThisextractsthesourcecodeintotheHelloWord-JNI/srcdirectory. ThemainactivityisfoundinthefileHelloWord-JNI/ src/sg/vantagepoint/helloworldjni/MainActivity.java. The“HelloWorld”textviewispopulatedintheonCreate method: public class MainActivity extends AppCompatActivity { static { System.loadLibrary(\"native-lib\"); } @Override protected void onCreate(Bundlebundle){ super.onCreate(bundle); this.setContentView(2130968603); ((TextView)this.findViewById(2131427422)).setText((CharSequence)this. \\ stringFromJNI()); } public native String stringFromJNI(); } NotethedeclarationofpublicnativeStringstringFromJNIatthebottom. Thekeyword“native”tellstheJavacompiler thatthismethodisimplementedinanativelanguage. Thecorrespondingfunctionisresolvedduringruntime,butonlyif anativelibrarythatexportsaglobalsymbolwiththeexpectedsignatureisloaded(signaturescompriseapackagename, classname,andmethodname). Inthisexample,thisrequirementissatisfiedbythefollowingCorC++function: JNIEXPORTjstringJNICALLJava_sg_vantagepoint_helloworld_MainActivity_stringFromJNI(JNIEnv *env,jobject) Sowhereisthenativeimplementationofthisfunction? Ifyoulookintothe“lib”directoryoftheunzippedAPKarchive, you’ll see several subdirectories (one per supported processor architecture), each of them containing a version of the nativelibrary,inthiscaselibnative-lib.so. WhenSystem.loadLibraryiscalled,theloaderselectsthecorrectversion basedonthedevicethattheappisrunningon. Beforemovingahead,payattentiontothefirstparameterpassedtothe currentJNIfunction. ItisthesameJNIEnvdatastructurewhichwasdiscussedearlierinthissection. 175\\nFollowing the naming convention mentioned above, you can expect the library to export a symbol called Java_sg_- vantagepoint_helloworld_MainActivity_stringFromJNI.OnLinuxsystems,youcanretrievethelistofsymbolswith readelf(includedinGNUbinutils)ornm. DothisonmacOSwiththegreadelftool,whichyoucaninstallviaMacportsor Homebrew. Thefollowingexampleusesgreadelf: $greadelf -W-slibnative-lib.so |grep Java 3:00004e49 112FUNC GLOBALDEFAULT 11Java_sg_vantagepoint_helloworld_MainActivity_stringFromJNI Youcanalsoseethisusingradare2’srabin2: $rabin2 -sHelloWord-JNI/lib/armeabi-v7a/libnative-lib.so |grep -iJava 0030x00000e780x00000e78GLOBAL FUNC 16Java_sg_vantagepoint_helloworldjni_MainActivity_stringFromJNI ThisisthenativefunctionthateventuallygetsexecutedwhenthestringFromJNInativemethodiscalled. Todisassemblethecode,youcanloadlibnative-lib.sointoanydisassemblerthatunderstandsELFbinaries(i.e.,any disassembler). Iftheappshipswithbinariesfordifferentarchitectures,youcantheoreticallypickthearchitectureyou’re mostfamiliarwith,aslongasitiscompatiblewiththedisassembler. Eachversioniscompiledfromthesamesourceand implements the same functionality. However, if you’re planning to debug the library on a live device later, it’s usually wisetopickanARMbuild. To support both older and newer ARM processors, Android apps ship",
  "metadata": {
    "doc_id": "OWASP_MASTG",
    "chunk_id": 76
  },
  "embedding": [
    -0.06216909736394882,
    -0.05070757865905762,
    0.023295026272535324,
    -0.11388085782527924,
    0.024388259276747704,
    -0.06121671199798584,
    0.046763449907302856,
    -0.006366351153701544,
    -0.06663345545530319,
    0.003934009466320276,
    0.054746732115745544,
    -0.06514173001050949,
    0.05558357760310173,
    -0.027588101103901863,
    0.016055429354310036,
    -0.04031703248620033,
    -0.0017394580645486712,
    0.01970646344125271,
    -0.05624893307685852,
    0.050311870872974396,
    0.0480167418718338,
    -0.006891761440783739,
    0.05667483061552048,
    -0.03161170706152916,
    0.0917748510837555,
    0.035554543137550354,
    -0.029213955625891685,
    -0.061088673770427704,
    -0.014982438646256924,
    0.004132991190999746,
    0.06787730753421783,
    0.022939244285225868,
    0.028562398627400398,
    0.017333053052425385,
    -0.020368041470646858,
    0.045492686331272125,
    -0.012531525455415249,
    0.002957908669486642,
    -0.056789666414260864,
    -0.05742146074771881,
    -0.0918627381324768,
    -0.040460821241140366,
    -0.10592891275882721,
    0.08041571080684662,
    -0.06841254234313965,
    -0.0248106736689806,
    -0.004296967759728432,
    -0.030636753886938095,
    -0.079130619764328,
    0.019025567919015884,
    0.022486232221126556,
    -0.011435924097895622,
    0.02600918523967266,
    0.02690115012228489,
    -0.06190161034464836,
    0.026309268549084663,
    -0.07034724950790405,
    0.0754125788807869,
    0.06651011854410172,
    0.10513028502464294,
    0.039897624403238297,
    0.04391223564743996,
    -0.01592511683702469,
    0.03528636693954468,
    -0.036778710782527924,
    0.03746509179472923,
    0.04624456539750099,
    -0.047957804054021835,
    0.044102951884269714,
    -0.05592617392539978,
    0.002215011278167367,
    0.01977505534887314,
    -0.007196672260761261,
    0.014783529564738274,
    -0.0027116204146295786,
    0.07033459097146988,
    -0.03203587979078293,
    0.011706843972206116,
    -0.010294727981090546,
    -0.10632791370153427,
    0.011673050932586193,
    -0.021461661905050278,
    0.037771034985780716,
    0.055947382003068924,
    0.011079400777816772,
    0.04314682260155678,
    -0.017920497804880142,
    -0.0004158064548391849,
    0.05139542743563652,
    0.0797043964266777,
    0.012558710761368275,
    -0.04509766399860382,
    -0.0058909752406179905,
    -0.016047509387135506,
    0.03420035168528557,
    -0.008515054360032082,
    -0.07137668132781982,
    -0.019018376246094704,
    -0.07994144409894943,
    0.05249733477830887,
    -0.04991965368390083,
    -0.0021889079362154007,
    -0.020708845928311348,
    -0.06610111147165298,
    0.024562055245041847,
    -0.0660879984498024,
    0.011205901391804218,
    -0.03657907992601395,
    -0.004457411821931601,
    0.008402111940085888,
    0.029714584350585938,
    -0.03165043890476227,
    0.060067497193813324,
    -0.05192994326353073,
    0.01734519563615322,
    0.13851474225521088,
    -0.046711958944797516,
    0.03028816543519497,
    0.0832599624991417,
    0.027415387332439423,
    -0.008571802638471127,
    -0.014660408720374107,
    -0.013935121707618237,
    -0.11411499232053757,
    -0.030094753950834274,
    0.02539787068963051,
    -0.06123095378279686,
    2.0082348262223477e-32,
    -0.013967309147119522,
    0.02987024560570717,
    -0.03952880576252937,
    0.021415596827864647,
    -0.052326224744319916,
    -0.07020696252584457,
    0.0147604551166296,
    0.07030096650123596,
    -0.044054556638002396,
    -0.015691902488470078,
    0.004570970311760902,
    0.005947792902588844,
    0.009861632250249386,
    0.03546760976314545,
    0.028009476140141487,
    -0.06149325147271156,
    0.02491254173219204,
    0.03602242097258568,
    -0.02810562402009964,
    0.03407157212495804,
    -0.007488762494176626,
    -0.0088758310303092,
    0.01772141270339489,
    -0.006295713130384684,
    -0.06442195922136307,
    0.08727415651082993,
    0.011153052560985088,
    -0.009373577311635017,
    0.1097349151968956,
    0.059779319912195206,
    -0.06385618448257446,
    -0.04725995659828186,
    -0.08277323842048645,
    0.024246957153081894,
    0.02088848128914833,
    -0.06992145627737045,
    -0.003100623143836856,
    -0.06238960102200508,
    -0.0021996230352669954,
    -0.09498868882656097,
    0.045858826488256454,
    -0.028542423620820045,
    -0.0922514796257019,
    -0.04078800976276398,
    0.051223237067461014,
    -0.09262780845165253,
    -0.06492096185684204,
    -0.03637315332889557,
    0.02845817804336548,
    0.06001442298293114,
    0.02192753739655018,
    0.04445108398795128,
    0.018438924103975296,
    -0.07377772778272629,
    -0.09552120417356491,
    -0.030640900135040283,
    -0.01738106459379196,
    0.04950503632426262,
    0.005837665405124426,
    0.011462002992630005,
    -0.0672527477145195,
    0.046001482754945755,
    0.020731505006551743,
    -0.050967972725629807,
    0.04253881797194481,
    0.016166046261787415,
    -0.00644285511225462,
    -0.07553987205028534,
    -0.08315814286470413,
    -0.029692385345697403,
    -0.014269951730966568,
    -0.05397577956318855,
    0.10209278017282486,
    0.09383569657802582,
    -0.02345997653901577,
    0.044549115002155304,
    0.06848792731761932,
    0.037348706275224686,
    0.009852475486695766,
    -0.09201217442750931,
    0.039548639208078384,
    0.06670928746461868,
    0.02368985302746296,
    0.04015599563717842,
    -0.07530093938112259,
    -0.03655891865491867,
    -0.016827769577503204,
    -0.13233868777751923,
    -0.07123401761054993,
    0.1479223072528839,
    -0.0023937781807035208,
    0.04843217879533768,
    -0.06530426442623138,
    -0.01456566620618105,
    -0.0711696669459343,
    -1.9240714878185858e-32,
    0.012285346165299416,
    0.04347279667854309,
    -0.06120630353689194,
    -0.07522792369127274,
    -0.01780908741056919,
    0.01816674880683422,
    -0.05125798285007477,
    0.029195252805948257,
    0.020710624754428864,
    -0.027926351875066757,
    -0.0286116823554039,
    -0.019334688782691956,
    0.042958907783031464,
    -0.07168813049793243,
    0.05033683776855469,
    -0.021071478724479675,
    0.008237149566411972,
    0.038203395903110504,
    -0.014265325851738453,
    0.06612206995487213,
    0.0022653359919786453,
    0.07774434238672256,
    0.013184980489313602,
    0.07129763811826706,
    0.06906571239233017,
    0.01345121394842863,
    0.04788734391331673,
    0.09336640685796738,
    0.046000685542821884,
    -0.06232105568051338,
    0.049639031291007996,
    0.032769326120615005,
    -0.08555398136377335,
    -0.028811415657401085,
    -0.026844320818781853,
    -0.04474258050322533,
    -0.005676863249391317,
    -0.036223456263542175,
    -0.027773473411798477,
    -0.03375645726919174,
    0.02254658378660679,
    -0.027386022731661797,
    0.023428060114383698,
    0.036435410380363464,
    0.05378090590238571,
    -0.08279633522033691,
    -0.02111959084868431,
    -0.03063284419476986,
    0.023464228957891464,
    -0.06772612780332565,
    0.062017545104026794,
    0.0018094327533617616,
    -0.031071823090314865,
    0.007049706764519215,
    -0.011900670826435089,
    0.11530096083879471,
    0.06474193185567856,
    -0.033176980912685394,
    0.010882544331252575,
    -0.07116067409515381,
    0.07182955741882324,
    -0.06560388952493668,
    0.042021624743938446,
    -0.001690340111963451,
    0.07538042962551117,
    -0.009213164448738098,
    0.027804119512438774,
    0.019016124308109283,
    -0.06549256294965744,
    0.03894437104463577,
    0.010905051603913307,
    -0.11990393698215485,
    -0.03695664927363396,
    -0.0181918703019619,
    0.040521763265132904,
    0.02387540601193905,
    -0.020863667130470276,
    -0.12928585708141327,
    -0.09493833035230637,
    -0.05797066166996956,
    0.008590889163315296,
    0.0028594033792614937,
    -0.018694838508963585,
    -0.010763851925730705,
    0.11026006191968918,
    -0.09086848795413971,
    -0.03833808749914169,
    0.005114950239658356,
    -0.048182953149080276,
    -0.013909092172980309,
    -0.034890707582235336,
    0.006265625823289156,
    -0.01880270056426525,
    0.11787527799606323,
    0.042774301022291183,
    -7.166826776483504e-08,
    0.061069946736097336,
    -0.04304738715291023,
    -0.014233162626624107,
    -0.03598308935761452,
    0.11608631908893585,
    0.007188832852989435,
    -0.016800785437226295,
    0.014708506874740124,
    -0.006017470732331276,
    -0.09487847983837128,
    0.01366426795721054,
    -0.049490466713905334,
    -0.07293596863746643,
    0.05143735930323601,
    0.049717508256435394,
    -0.0214492566883564,
    -0.03983496502041817,
    0.029162369668483734,
    -0.07262600213289261,
    -0.009623158723115921,
    -0.014064231887459755,
    -0.022968050092458725,
    -0.053002823144197464,
    -0.03800784423947334,
    -0.022998498752713203,
    -0.011169799603521824,
    0.1204720288515091,
    0.10253186523914337,
    0.041822806000709534,
    0.008656441234052181,
    -0.03165217489004135,
    0.027906285598874092,
    0.08466070145368576,
    -0.09251677244901657,
    -0.07367793470621109,
    0.10511282831430435,
    0.02999122627079487,
    -0.018459521234035492,
    0.022762887179851532,
    0.004716925323009491,
    0.024505216628313065,
    0.07648447901010513,
    -0.025335950776934624,
    0.05457594245672226,
    -0.01812063343822956,
    -0.008209152147173882,
    0.009026163257658482,
    0.04169296845793724,
    0.021397318691015244,
    0.022640444338321686,
    -0.07091047614812851,
    0.008954210206866264,
    -0.07890719920396805,
    0.011545415036380291,
    -0.05461510643362999,
    0.05638193339109421,
    -0.0422455333173275,
    -0.06423398852348328,
    0.04055238515138626,
    0.038416773080825806,
    0.07875365763902664,
    0.046934615820646286,
    0.04331861063838005,
    -0.037033628672361374
  ]
}