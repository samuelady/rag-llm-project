{
  "text": "endpointresponses,whichareusedfortestingAuthorization,Session,Management,etc. Interception Proxy for a Virtual Device Setting Up a Web Proxy on an Android Virtual Device (AVD) Thefollowingprocedure,whichworksontheAndroidemulatorthatshipswithAndroidStudio3.x,isforsettingupanHTTP proxyontheemulator: 1. Setupyourproxytolistenonlocalhostandforexampleport8080. 2. ConfiguretheHTTPproxyintheemulatorsettings: • Clickonthethreedotsintheemulatormenubar • OpentheSettingsMenu • ClickontheProxytab 129\\n• SelectManualproxyconfiguration • Enter“127.0.0.1”intheHostNamefieldandyourproxyportinthePortnumberfield(e.g.,“8080”) • TapApply HTTPandHTTPSrequestsshouldnowberoutedovertheproxyonthehostcomputer. Ifnot,trytogglingairplanemode offandon. AproxyforanAVDcanalsobeconfiguredonthecommandlinebyusingtheemulatorcommandwhenstartinganAVD. ThefollowingexamplestartstheAVDNexus_5X_API_23andsetsaproxyto127.0.0.1andport8080. emulator@Nexus_5X_API_23 -http-proxy 127.0.0.1:8080 Installing a CA Certificate on the Virtual Device AneasywaytoinstallaCAcertificateistopushthecertificatetothedeviceandaddittothecertificatestoreviaSecurity Settings. Forexample,youcaninstallthePortSwigger(Burp)CAcertificateasfollows: 1. StartBurpanduseawebbrowseronthehosttonavigatetoburp/,thendownloadcacert.derbyclickingthe“CA Certificate”button. 2. Changethefileextensionfrom.derto.cer. 3. Pushthefiletotheemulator: adbpush cacert.cer/sdcard/ 4. NavigatetoSettings->Security->InstallfromSDCard. 5. Scrolldownandtapcacert.cer. Youshouldthenbepromptedtoconfirminstallationofthecertificate(you’llalsobeaskedtosetadevicePINifyouhaven’t already). Thisinstallsthecertificateintheusercertificatestore(testedonGenymotionVM).Inordertoplacethecertificateinthe rootstoreyoucanperformthefollowingsteps: 1. Runadbasrootwithadb rootandadb shell. 2. Locatethenewlyinstalledcertificateat/data/misc/user/0/cacerts-added/. 3. Copythecertificatetothefollowingfolder/system/etc/security/cacerts/. 4. ReboottheAndroidVM. 130\\nFor Android 7.0 (API level 24) and above follow the same procedure described in the “Bypassing the Network Security Configuration”section. Interception Proxy for a Physical Device Theavailablenetworksetupoptionsmustbeevaluatedfirst. Themobiledeviceusedfortestingandthehostcomputer running the interception proxy must be connected to the same Wi-Fi network. Use either an (existing) access point or createanad-hocwirelessnetwork. Once you’ve configured the network and established a connection between the testing host computer and the mobile device,severalstepsremain. • Theproxymustbeconfiguredtopointtotheinterceptionproxy. • Theinterceptionproxy’sCAcertificatemustbeaddedtothetrustedcertificatesintheAndroiddevice’scertificate storage. ThelocationofthemenuusedtostoreCAcertificatesmaydependontheAndroidversionandAndroid OEMmodificationsofthesettingsmenu. • Someapplication(e.g.theChromebrowser)mayshowNET::ERR_CERT_VALIDITY_TOO_LONGerrors,iftheleafcer- tificate happens to have a validity extending a certain time (39 months in case of Chrome). This happens if the defaultBurpCAcertificateisused,sincetheBurpSuiteissuesleafcertificateswiththesamevalidityasitsCAcer- tificate. YoucancircumventthisbycreatingyourownCAcertificateandimportittotheBurpSuite,asexplained inthisblogpost. Aftercompletingthesestepsandstartingtheapp,therequestsshouldshowupintheinterceptionproxy. AvideoofsettingupOWASPZAPwithanAndroiddevicecanbefoundonsecure.force.com. Afewotherdifferences: fromAndroid8.0(APIlevel26)onward,thenetworkbehavioroftheappchangeswhenHTTPS trafficistunneledthroughanotherconnection. AndfromAndroid9(APIlevel28)onward,theSSLSocketandSSLEngine willbehavealittlebitdifferentintermsoferrorhandlingwhensomethinggoeswrongduringthehandshakes. As mentioned before, starting with Android 7.0 (API level 24), the Android OS will no longer trust user CA certificates bydefault, unlessspecifiedintheapplication. Inthefollowingsection, weexplaintwomethodstobypassthisAndroid securitycontrol. Bypassing the Network Security Configuration InthissectionwewillpresentseveralmethodstobypassAndroid’sNetworkSecurityConfiguration. Adding Custom User Certificates to the Network Security Configuration TherearedifferentconfigurationsavailablefortheNetworkSecurityConfigurationtoaddnon-systemCertificateAuthori- tiesviathesrcattribute: <certificates src=[\"system\" |\"user\"|\"raw resource\"] overridePins=[\"true\" |\"false\"]/> Eachcertificatecanbeoneofthefollowing: • \"raw resource\"isanIDpointingtoafilecontainingX.509certificates • \"system\"forthepre-installedsystemCAcertificates • \"user\"foruser-addedCAcertificates The CA certificates trusted by the app can be a system trusted CA as well as a user CA. Usually you will have added the certificate of your interception proxy already as additional CA in Android. Therefore we will focus on the “user” setting,whichallowsyoutoforcetheAndroidapptotrustthiscertificatewiththefollowingNetworkSecurityConfiguration below: 131\\n<network-security-config> <base-config> <trust-anchors> <certificates src=\"system\" /> <certificates src=\"user\" /> </trust-anchors> </base-config> </network-security-config> Toimplementthisnewsettingyoumustfollowthestepsbelow: • Decompiletheappusingadecompilationtoollikeapktool: apktoold <filename>.apk • MaketheapplicationtrustusercertificatesbycreatingaNetworkSecurityConfigurationthatincludes<certifi- cates src=\"user\" />asexplainedabove • Gointothedirectorycreatedbyapktoolwhendecompilingtheappandrebuildtheappusingapktool. Thenewapk willbeinthedistdirectory. apktoolb • Youneedtorepackagetheapp, asexplainedinthe“Repackaging”sectionofthe“ReverseEngineeringandTam- pering”chapter. FormoredetailsontherepackagingprocessyoucanalsoconsulttheAndroiddeveloperdocumen- tation,thatexplainstheprocessasawhole. Notethatevenifthismethodisquitesimpleitsmajordrawbackisthatyouhavetoapplythisoperationforeachapplication youwanttoevaluatewhichisadditionaloverheadfortesting. Bearinmindthatiftheappyouaretestinghasadditionalhardeningmeasures,likeverificationoftheappsignature youmightnotbeabletostarttheappanymore. Aspartoftherepackagingyouwillsigntheappwithyourownkey andthereforethesignaturechangeswillresultintriggeringsuchchecksthatmightleadtoimmediatetermination oftheapp. Youwouldneedtoidentifyanddisablesuchcheckseitherbypatchingthemduringrepackagingofthe appordynamicinstrumentationthroughFrida. ThereisapythonscriptavailablethatautomatesthestepsdescribedabovecalledAndroid-CertKiller. ThisPythonscript canextracttheAPKfromaninstalledAndroidapp,decompileit,makeitdebuggable,addanewNetworkSecurityConfig- urationthatallowsusercertificates,buildsandsignsthenewAPKandinstallsthenewAPKwiththeSSLBypass. pythonmain.py -w *************************************** AndroidCertKiller (v0.1) *************************************** CertKillerWizardMode --------------------------------- Listofdevicesattached 4200dc72f27bc44d device --------------------------------- EnterApplicationPackageName:nsc.android.mstg.owasp.org.android_nsc Package:/data/app/nsc.android.mstg.owasp.org.android_nsc-1/base.apk I.InitiatingAPKextractionfromdevice complete ------------------------------ I.Decompiling complete ------------------------------ I.ApplyingSSLbypass complete ------------------------------ I.BuildingNewAPK complete ------------------------------ I.SigningAPK complete ------------------------------ WouldyouliketoinstalltheAPKonyourdevice(y/N):y ------------------------------------ InstallingUnpinnedAPK ------------------------------ Finished 132\\nAdding the Proxy’s certificate among system trusted CAs using Magisk InordertoavoidtheobligationofconfiguringtheNetworkSecurityConfigurationforeachapplication,wemustforcethe devicetoaccepttheproxy’scertificateasoneofthesystemstrustedcertificates. ThereisaMagiskmodulethatwillautomaticallyaddalluser-installedCAcertificatestothelistofsystemtrustedCAs. DownloadthelatestversionofthemoduleattheGithubReleasepage,pushthedownloadedfileovertothedeviceand import it in the Magisk Manager’s “Module” view by clicking on the + button. Finally, a restart is required by Magisk Managertoletchangestakeeffect. Fromnowon,anyCAcertificatethatisinstalledbytheuservia“Settings”,“Security&location”,“Encryption&creden- tials”, “Install from storage” (location may differ) is automatically pushed into the system’s trust store by this Magisk module. RebootandverifythattheCAcertificateislistedin“Settings”,“Security&location”,“Encryption&credentials”, “Trustedcredentials”(locationmaydiffer). Manually adding the Proxy’s certificate among system trusted CAs Alternatively,youcanfollowthefollowingstepsmanuallyinordertoachievethesameresult: • Makethe/systempartitionwritable,whichisonlypossibleonarooteddevice. Runthe‘mount’commandtomake sure the /system is writable: mount -o rw,remount /system. If this command fails, try running the following commandmount -o rw,remount -t ext4 /system • Preparetheproxy’sCAcertificatestomatchsystemcertificatesformat. Exporttheproxy’scertificatesinderformat (thisisthedefaultformatinBurpSuite)thenrunthefollowingcommands: $openssl x509 -inform DER-incacert.der -out cacert.pem $openssl x509 -inform PEM-subject_hash_old -incacert.pem |head -1 mvcacert.pem <hash>.0 • Finally,copythe<hash>.0fileintothedirectory/system/etc/security/cacertsandthenrunthefollowingcommand: chmod 644<hash>.0 By following the steps described above you allow any application to trust the proxy’s",
  "metadata": {
    "doc_id": "OWASP_MASTG",
    "chunk_id": 67
  },
  "embedding": [
    -0.028147194534540176,
    -0.028777042403817177,
    0.026801908388733864,
    -0.15419504046440125,
    -0.052422698587179184,
    -0.02173934318125248,
    0.01689796708524227,
    -0.03647313266992569,
    -0.02618386596441269,
    0.045408375561237335,
    0.021190637722611427,
    0.01179440226405859,
    0.02109643630683422,
    -0.02169586531817913,
    0.039115045219659805,
    0.04719364270567894,
    0.07601601630449295,
    -0.017982259392738342,
    -0.016571182757616043,
    0.05321134626865387,
    0.08823687583208084,
    0.0072166165336966515,
    -0.004309997893869877,
    -0.06695570051670074,
    0.022264329716563225,
    -0.045791830867528915,
    -0.044905874878168106,
    -0.029232338070869446,
    0.006060840096324682,
    0.00928389560431242,
    0.016468143090605736,
    0.03679217770695686,
    -0.07143130153417587,
    0.015280346386134624,
    -0.03340473398566246,
    -0.13296715915203094,
    -0.05066864937543869,
    0.037463512271642685,
    -0.05195176228880882,
    0.028822559863328934,
    0.022911973297595978,
    -0.0034389218781143427,
    -0.02351304702460766,
    0.057711731642484665,
    -0.011539053171873093,
    -0.0008336628670804203,
    0.007135487161576748,
    0.00909462384879589,
    0.027176108211278915,
    -0.00974862277507782,
    0.022310134023427963,
    0.06789784878492355,
    0.04221438989043236,
    0.060509178787469864,
    -0.08350610733032227,
    -0.04124089702963829,
    -0.008565142750740051,
    0.09179602563381195,
    0.03099375218153,
    0.10791593790054321,
    -0.021562635898590088,
    -0.030033860355615616,
    -0.018966246396303177,
    -0.024188034236431122,
    -0.09097244590520859,
    0.011262516491115093,
    -0.023723352700471878,
    -0.03360678255558014,
    0.04751851037144661,
    -0.0014322298811748624,
    -0.10848987102508545,
    0.05395655333995819,
    -0.050563350319862366,
    -0.018601391464471817,
    0.06928188353776932,
    0.04549027234315872,
    -0.021634990349411964,
    0.016367144882678986,
    0.02335541509091854,
    -0.14647474884986877,
    0.07988552004098892,
    -0.027881164103746414,
    -0.030933255329728127,
    0.10226932913064957,
    -0.010267636738717556,
    -0.03490840643644333,
    0.01789553463459015,
    0.037582434713840485,
    0.08942535519599915,
    0.07730032503604889,
    -0.026289260014891624,
    0.027001235634088516,
    -0.06039177253842354,
    0.004790652077645063,
    -0.015763409435749054,
    0.038100454956293106,
    -0.010218048468232155,
    -0.016847699880599976,
    -0.07318737357854843,
    0.025015847757458687,
    0.05431525036692619,
    0.0005611558444797993,
    0.010596043430268764,
    -0.020193742588162422,
    -0.012578192166984081,
    -0.05039704963564873,
    0.05626177042722702,
    0.03910444304347038,
    0.07388343662023544,
    0.04281831160187721,
    -0.026299234479665756,
    -0.03672889992594719,
    0.019200708717107773,
    -0.05398724973201752,
    -0.021417278796434402,
    0.0821278765797615,
    0.08274799585342407,
    0.012120394967496395,
    0.07666004449129105,
    -0.04233776032924652,
    -0.026248672977089882,
    -0.024515746161341667,
    0.04260091856122017,
    -0.025691013783216476,
    0.038256894797086716,
    -0.0056836348958313465,
    -0.0027395382057875395,
    1.7208104413357684e-32,
    0.06099244952201843,
    0.016535837203264236,
    -0.020387830212712288,
    -0.05433432757854462,
    -0.014270177111029625,
    0.026504136621952057,
    0.060571566224098206,
    0.08514998853206635,
    0.07727682590484619,
    -0.04136043041944504,
    -0.018814755603671074,
    -0.03692111000418663,
    0.021227972581982613,
    0.0005882012192159891,
    0.01653999462723732,
    0.0068548195995390415,
    -0.09212011098861694,
    0.04305848106741905,
    0.041315361857414246,
    0.06285939365625381,
    -0.02014169469475746,
    -0.08996976912021637,
    0.0072187697514891624,
    -0.03801535442471504,
    -0.02885010465979576,
    0.02664630115032196,
    -0.05239761248230934,
    0.0047825356014072895,
    -0.04520153999328613,
    0.04723725467920303,
    0.03482375666499138,
    -0.05387626588344574,
    -0.07473202049732208,
    0.006616413593292236,
    0.0009914323454722762,
    -0.00649963179603219,
    0.0022628020960837603,
    -0.05443131551146507,
    0.012611831538379192,
    -0.06936521083116531,
    -0.08207246661186218,
    -0.03785431385040283,
    -0.04331061244010925,
    0.017548413947224617,
    -0.047606583684682846,
    -0.13751532137393951,
    -0.05750763416290283,
    -0.020477429032325745,
    0.10137113183736801,
    0.04286593943834305,
    0.004231372848153114,
    -0.01960134319961071,
    0.0905621275305748,
    -0.14922809600830078,
    -0.03493165597319603,
    0.007109575439244509,
    -0.06780635565519333,
    0.06540330499410629,
    -0.08154162019491196,
    -0.00047752264072187245,
    -0.018321366980671883,
    -0.0469481498003006,
    -0.06985664367675781,
    0.006324174348264933,
    -0.0191225353628397,
    0.037319742143154144,
    0.01700165681540966,
    -0.06783841550350189,
    -0.03141559287905693,
    -0.010418352670967579,
    -0.05614875257015228,
    -0.026950467377901077,
    0.055005595088005066,
    0.01923266425728798,
    -0.08625764399766922,
    0.05327140912413597,
    0.010378081351518631,
    0.03916054219007492,
    0.03940743952989578,
    -0.036809735000133514,
    0.06928896903991699,
    0.0251778531819582,
    0.031410157680511475,
    -0.028499970212578773,
    -0.09388548880815506,
    -0.030269786715507507,
    0.033578697592020035,
    -0.1116112545132637,
    -0.047570712864398956,
    0.07510705292224884,
    -0.04902312904596329,
    0.07725804299116135,
    -0.013073166832327843,
    0.08174362033605576,
    -0.022106850519776344,
    -1.7091464517029404e-32,
    -0.060053203254938126,
    0.01697566919028759,
    -0.02553550899028778,
    -0.04088540002703667,
    0.03335686773061752,
    0.017725983634591103,
    0.031738992780447006,
    0.06802718341350555,
    0.009922544471919537,
    0.008363171480596066,
    0.08800127357244492,
    -0.0029101145919412374,
    0.0579611137509346,
    -0.0522741973400116,
    -0.0018716321792453527,
    -0.0058557381853461266,
    0.004158415365964174,
    -0.02567521296441555,
    -0.05549703165888786,
    0.037939123809337616,
    -0.02130061388015747,
    0.007249793969094753,
    0.07357750087976456,
    0.046710144728422165,
    0.029196804389357567,
    -0.021653853356838226,
    0.015197266824543476,
    0.025131819769740105,
    -0.015155388973653316,
    -0.03925507515668869,
    0.052367594093084335,
    0.02025769278407097,
    -0.003400548594072461,
    0.010882273316383362,
    0.04456119239330292,
    0.0567827932536602,
    -0.03988207131624222,
    0.05802857130765915,
    0.0029945215210318565,
    -0.03941516578197479,
    0.07159478217363358,
    -0.07538772374391556,
    0.04671035706996918,
    0.012251489795744419,
    0.0645284354686737,
    -0.03397386521100998,
    -0.036999668926000595,
    0.041663460433483124,
    -0.07355320453643799,
    -0.006121092475950718,
    0.06511911749839783,
    0.050730206072330475,
    0.018584243953227997,
    0.053406886756420135,
    0.02092559263110161,
    0.10678642988204956,
    0.06096060574054718,
    -0.04985503852367401,
    -0.009927778504788876,
    -0.032882798463106155,
    0.048456061631441116,
    -0.06523926556110382,
    -0.06449168175458908,
    0.052703242748975754,
    0.05161742866039276,
    0.018061412498354912,
    0.011150102131068707,
    0.03731541708111763,
    -0.05179041996598244,
    0.02576334960758686,
    -0.05370502173900604,
    -0.14400343596935272,
    -0.041931163519620895,
    -0.025684621185064316,
    0.024692803621292114,
    0.023550186306238174,
    0.04881253466010094,
    -0.08761364966630936,
    -0.09865519404411316,
    0.015683848410844803,
    0.014903371222317219,
    0.038689203560352325,
    -0.03747909516096115,
    -0.08591115474700928,
    0.040108613669872284,
    -0.018648283556103706,
    -0.09601404517889023,
    0.06540075689554214,
    0.0038485743571072817,
    0.02430114895105362,
    -0.0845656543970108,
    0.016002435237169266,
    -0.11659281700849533,
    0.022448671981692314,
    -0.004047696013003588,
    -6.773021254957712e-08,
    0.04643216356635094,
    0.05528822913765907,
    0.06311351805925369,
    -0.018949883058667183,
    -0.016374945640563965,
    0.036874301731586456,
    -0.010457949712872505,
    -0.044782329350709915,
    0.029402662068605423,
    -0.04472528025507927,
    -0.02218906208872795,
    0.021684471517801285,
    -0.0342903658747673,
    0.06066005304455757,
    0.05031494423747063,
    -0.08351245522499084,
    -0.005534842144697905,
    -0.018921958282589912,
    -0.035282716155052185,
    0.03965841606259346,
    -0.057059261947870255,
    -0.06502549350261688,
    -0.028428029268980026,
    -0.023559579625725746,
    -0.01499528530985117,
    0.04155660420656204,
    -0.010224640369415283,
    0.012305961921811104,
    0.06217401102185249,
    0.06461764127016068,
    -0.005057850852608681,
    -0.021196190267801285,
    -0.025231266394257545,
    -0.08267412334680557,
    -0.16570322215557098,
    0.16693979501724243,
    -0.0378204807639122,
    -0.1404663324356079,
    -0.016234619542956352,
    -0.0184805728495121,
    0.001191068789921701,
    0.041865210980176926,
    -0.014297949150204659,
    0.015770323574543,
    0.08003377169370651,
    0.02948235720396042,
    -0.0038681041914969683,
    0.045951973646879196,
    0.07994186133146286,
    0.023993097245693207,
    -0.06185786426067352,
    -0.05845996364951134,
    0.00551423616707325,
    -0.07169826328754425,
    -0.03582160174846649,
    -0.032079245895147324,
    -0.04713393375277519,
    -0.0899638682603836,
    0.018561188131570816,
    0.014299088157713413,
    0.07409366220235825,
    0.009958223439753056,
    -0.008516223169863224,
    0.0645451694726944
  ]
}