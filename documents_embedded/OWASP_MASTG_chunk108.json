{
  "text": "AndroidapplicationsrunonaVMwheremostofthememorycorruptionissueshavebeentakencareoff. Thisdoesnot meanthattherearenomemorycorruptionbugs. TakeCVE-2018-9522forinstance,whichisrelatedtoserializationissues usingParcels. Next,innativecode,westillseethesameissuesasweexplainedinthegeneralmemorycorruptionsection. Last,weseememorybugsinsupportingservices,suchaswiththeStagefrightattackasshownatBlackHat. Memoryleaksareoftenanissueaswell. ThiscanhappenforinstancewhenareferencetotheContextobjectispassed aroundtonon-Activityclasses,orwhenyoupassreferencestoActivityclassestoyourhelperclasses. Binary Protection Mechanisms Detectingthepresenceofbinaryprotectionmechanismsheavilydependonthelanguageusedfordevelopingtheappli- cation. Ingeneralallbinariesshouldbetested,whichincludesboththemainappexecutableaswellasalllibraries/dependencies. However,onAndroidwewillfocusonnativelibrariessincethemainexecutablesareconsideredsafeaswewillseenext. AndroidoptimizesitsDalvikbytecodefromtheappDEXfiles(e.g.classes.dex)andgeneratesanewfilecontainingthe nativecode,usuallywithan.odex,.oatextension. ThisAndroidcompiledbinaryiswrappedusingtheELFformatwhich istheformatusedbyLinuxandAndroidtopackageassemblycode. Theapp’sNDKnativelibrariesalsousetheELFformat. • PIE(PositionIndependentExecutable): – SinceAndroid7.0(APIlevel24),PICcompilationisenabledbydefaultforthemainexecutables. – WithAndroid5.0(APIlevel21),supportfornon-PIEenablednativelibrarieswasdroppedandsincethen,PIE isenforcedbythelinker. • Memorymanagement: – Garbage Collection will simply run for the main binaries and there’s nothing to be checked on the binaries themselves. – GarbageCollectiondoesnotapplytoAndroidnativelibraries. Thedeveloperisresponsiblefordoingproper manualmemorymanagement. See“MemoryCorruptionBugs”. • StackSmashingProtection: – AndroidappsgetcompiledtoDalvikbytecodewhichisconsideredmemorysafe(atleastformitigatingbuffer overflows). OtherframeworkssuchasFlutterwillnotcompileusingstackcanariesbecauseofthewaytheir language,inthiscaseDart,mitigatesbufferoverflows. – ItmustbeenabledforAndroidnativelibrariesbutitmightbedifficulttofullydetermineit. ∗ NDKlibrariesshouldhaveitenabledsincethecompilerdoesitbydefault. ∗ OthercustomC/C++librariesmightnothaveitenabled. Learnmore: • Androidexecutableformats • Androidruntime(ART) • AndroidNDK • AndroidlinkerchangesforNDKdevelopers Debuggable Apps Debugging is an essential process for developers to identify and fix errors or bugs in their Android app. By using a debugger, developers can select the device to debug their app on and set breakpoints in their Java, Kotlin, and C/C++ code. Thisallowsthemtoanalyzevariablesandevaluateexpressionsatruntime,whichhelpsthemtoidentifytheroot causeofmanyissues. Bydebuggingtheirapp,developerscanimprovethefunctionalityanduserexperienceoftheirapp, ensuringthatitrunssmoothlywithoutanyerrorsorcrashes. Everydebugger-enabledprocessrunsanextrathreadforhandlingJDWPprotocolpackets. Thisthreadisstartedonlyfor appsthathavetheandroid:debuggable=\"true\"attributeintheApplicationelementwithintheAndroidManifest. 288\\nDebugging Symbols Generally,youshouldprovidecompiledcodewithaslittleexplanationaspossible. Somemetadata,suchasdebugging information,linenumbers,anddescriptivefunctionormethodnames,makethebinaryorbytecodeeasierforthereverse engineertounderstand,butthesearen’tneededinareleasebuildandcanthereforebesafelyomittedwithoutimpacting theapp’sfunctionality. To inspect native binaries, use a standard tool like nm or objdump to examine the symbol table. A release build should generally not contain any debugging symbols. If the goal is to obfuscate the library, removing unnecessary dynamic symbolsisalsorecommended. Debugging Code and Error Logging StrictMode StrictModeisadevelopertoolfordetectingviolations, e.g.accidentaldiskornetworkaccessontheapplication’smain thread. Itcanalsobeusedtocheckforgoodcodingpractices,suchasimplementingperformantcode. HereisanexampleofStrictModewithpoliciesenabledfordiskandnetworkaccesstothemainthread: public void onCreate(){ if(DEVELOPER_MODE){ StrictMode.setThreadPolicy(newStrictMode.ThreadPolicy.Builder() .detectDiskReads() .detectDiskWrites() .detectNetwork() //or.detectAll()foralldetectableproblems .penaltyLog() .build()); StrictMode.setVmPolicy(newStrictMode.VmPolicy.Builder() .detectLeakedSqlLiteObjects() .detectLeakedClosableObjects() .penaltyLog() .penaltyDeath() .build()); } super.onCreate(); } Inserting the policy in the if statement with the DEVELOPER_MODE condition is recommended. To disable StrictMode, DEVELOPER_MODEmustbedisabledforthereleasebuild. Exception Handling Exceptions occur when an application gets into an abnormal or error state. Both Java and C++ may throw exceptions. Testingexceptionhandlingisaboutensuringthattheappwillhandleanexceptionandtransitiontoasafestatewithout exposingsensitiveinformationviatheUIortheapp’sloggingmechanisms. Make Sure That Free Security Features Are Activated Platform: android MASVSV1: MSTG-CODE-9 MASVSV2: MASVS-CODE-4 Overview Static Analysis TesttheappnativelibrariestodetermineiftheyhavethePIEandstacksmashingprotectionsenabled. Youcanuseradare2’srabin2togetthebinaryinformation. We’llusetheUnCrackableAppforAndroidLevel4v1.0APK asanexample. 289\\nAllnativelibrariesmusthavecanaryandpicbothsettotrue. That’sthecaseforlibnative-lib.so: rabin2 -Ilib/x86_64/libnative-lib.so |grep -E\"canary|pic\" canary true pic true Butnotforlibtool-checker.so: rabin2 -Ilib/x86_64/libtool-checker.so |grep -E\"canary|pic\" canary false pic true Inthisexample,libtool-checker.somustberecompiledwithstacksmashingprotectionsupport. Testing for Injection Flaws Platform: android MASVSV1: MSTG-PLATFORM-2 MASVSV2: MASVS-CODE-4 Overview Totestforinjectionflawsyouneedtofirstrelyonothertestsandcheckforfunctionalitythatmighthavebeenexposed: • “TestingDeepLinks” • “TestingforSensitiveFunctionalityExposureThroughIPC” • “TestingforOverlayAttacks” Static Analysis AnexampleofavulnerableIPCmechanismisshownbelow. YoucanuseContentProviderstoaccessdatabaseinformation,andyoucanprobeservicestoseeiftheyreturndata. If dataisnotvalidatedproperly,thecontentprovidermaybepronetoSQLinjectionwhileotherappsareinteractingwith it. SeethefollowingvulnerableimplementationofaContentProvider. <provider android:name=\".OMTG_CODING_003_SQL_Injection_Content_Provider_Implementation\" android:authorities=\"sg.vp.owasp_mobile.provider.College\"> </provider> The AndroidManifest.xml above defines a content provider that’s exported and therefore available to all other apps. ThequeryfunctionintheOMTG_CODING_003_SQL_Injection_Content_Provider_Implementation.javaclassshouldbe inspected. @Override public Cursor query(Uriuri,String[]projection,Stringselection,String[]selectionArgs,StringsortOrder){ SQLiteQueryBuilderqb =newSQLiteQueryBuilder(); qb.setTables(STUDENTS_TABLE_NAME); switch (uriMatcher.match(uri)){ case STUDENTS: qb.setProjectionMap(STUDENTS_PROJECTION_MAP); break; case STUDENT_ID: //SQLInjectionwhenprovidinganID qb.appendWhere(_ID+\"=\"+uri.getPathSegments().get(1)); Log.e(\"appendWhere\",uri.getPathSegments().get(1).toString()); break; 290\\ndefault: throw newIllegalArgumentException(\"UnknownURI\" +uri); } if(sortOrder ==null ||sortOrder ==\"\"){ /** *Bydefaultsortonstudentnames */ sortOrder =NAME; } Cursorc =qb.query(db,projection,selection,selectionArgs,null,null, sortOrder); /** *registertowatchacontentURIforchanges */ c.setNotificationUri(getContext().getContentResolver(),uri); return c; } WhiletheuserisprovidingaSTUDENT_IDatcontent://sg.vp.owasp_mobile.provider.College/students,thequery statement is prone to SQL injection. Obviously prepared statements must be used to avoid SQL injection, but input validationshouldalsobeappliedsothatonlyinputthattheappisexpectingisprocessed. AllappfunctionsthatprocessdatacominginthroughtheUIshouldimplementinputvalidation: • Foruserinterfaceinput,AndroidSaripaarv2canbeused. • ForinputfromIPCorURLschemes,avalidationfunctionshouldbecreated. Forexample,thefollowingdetermines whetherthestringisalphanumeric: public boolean isAlphaNumeric(Strings){ Stringpattern=\"^[a-zA-Z0-9]*$\"; return s.matches(pattern); } An alternative to validation functions is type conversion, with, for example, Integer.parseInt if only integers are ex- pected. TheOWASPInputValidationCheatSheetcontainsmoreinformationaboutthistopic. Dynamic Analysis ThetestershouldmanuallytesttheinputfieldswithstringslikeOR1=1--if,forexample,alocalSQLinjectionvulnerability hasbeenidentified. Onarooteddevice,thecommandcontentcanbeusedtoquerythedatafromacontentprovider. Thefollowingcommand queriesthevulnerablefunctiondescribedabove. ##contentquery--uricontent://sg.vp.owasp_mobile.provider.College/students SQL injection can be exploited with the following command. Instead of getting the record for Bob only, the user can retrievealldata. ##contentquery--uricontent://sg.vp.owasp_mobile.provider.College/students--where\"name='Bob')OR1=1--''\" Testing Local Storage for Input Validation Platform: android MASVSV1: MSTG-PLATFORM-2 MASVSV2: MASVS-CODE-4 291\\nOverview Foranypubliclyaccessibledatastorage,anyprocesscanoverridethedata. Thismeansthatinputvalidationneedstobe appliedthemomentthedataisreadbackagain. Note: Thesameistrueforprivateaccessibledataonarooteddevice Static analysis Using Shared Preferences WhenyouusetheSharedPreferences.Editortoreadorwriteint/boolean/longvalues, youcannotcheckwhetherthe data is overridden or not. However: it can hardly be used for actual",
  "metadata": {
    "doc_id": "OWASP_MASTG",
    "chunk_id": 108
  },
  "embedding": [
    -0.008022758178412914,
    -0.041015878319740295,
    0.0043533905409276485,
    -0.13718058168888092,
    0.013315258547663689,
    0.028687570244073868,
    -0.004390464164316654,
    -0.014630637131631374,
    -0.044335003942251205,
    0.02142958715558052,
    0.01958043873310089,
    -0.04420148581266403,
    0.05201483517885208,
    -0.03447967767715454,
    -0.002070673741400242,
    -0.015104399062693119,
    0.0806029662489891,
    0.00864657573401928,
    -0.08291985094547272,
    0.07277808338403702,
    0.03394405543804169,
    -0.006705097854137421,
    0.0375678651034832,
    0.05622369050979614,
    0.0664229467511177,
    0.006010056938976049,
    -0.04049837216734886,
    -0.09181652218103409,
    -0.043067000806331635,
    0.013136464171111584,
    0.02929059974849224,
    0.07886490970849991,
    0.06923843920230865,
    0.05271740257740021,
    0.03518195077776909,
    -0.006063816137611866,
    -0.06310757994651794,
    0.0017449482111260295,
    -0.013527961447834969,
    -0.05394269898533821,
    -0.03514612093567848,
    -0.0254549290984869,
    -0.039412111043930054,
    0.06506294012069702,
    -0.0217514019459486,
    -0.030905764549970627,
    -0.029440175741910934,
    -0.049894653260707855,
    0.0019435505382716656,
    0.034461963921785355,
    0.05159004032611847,
    0.04476295784115791,
    0.0299638994038105,
    0.07867835462093353,
    -0.10226310044527054,
    0.06152928248047829,
    -0.020610123872756958,
    0.08940953761339188,
    0.0617193803191185,
    0.09579278528690338,
    0.0353257991373539,
    -0.018326302990317345,
    -0.03245671093463898,
    0.0034150679130107164,
    -0.07622912526130676,
    0.032311588525772095,
    0.04941648244857788,
    -0.08192642033100128,
    0.0844697654247284,
    -0.05932603031396866,
    -0.02740871161222458,
    0.051781754940748215,
    -0.04215078055858612,
    0.009605785831809044,
    -0.014100325293838978,
    0.07772737741470337,
    0.06046507507562637,
    0.03217772766947746,
    -0.04749106988310814,
    -0.16776877641677856,
    -0.015909792855381966,
    0.0011171502992510796,
    0.029291000217199326,
    0.0771058052778244,
    0.02257593348622322,
    -0.013460440561175346,
    -0.030215086415410042,
    0.015729621052742004,
    0.03551693260669708,
    0.03301676735281944,
    -0.019576484337449074,
    0.015314104966819286,
    -0.022203711792826653,
    -0.026867695152759552,
    0.007420645095407963,
    0.03151538968086243,
    -0.09664765000343323,
    -0.027136029675602913,
    -0.06010989472270012,
    0.013067299500107765,
    0.02005510777235031,
    0.005090730264782906,
    -0.0069333589635789394,
    -0.047400858253240585,
    -0.009782584384083748,
    -0.12160924822092056,
    0.035378120839595795,
    -0.0032649144995957613,
    0.003446580609306693,
    0.013249864801764488,
    0.000518757093232125,
    -0.03050961159169674,
    0.06150137260556221,
    0.008898148313164711,
    0.04523911699652672,
    0.05401507392525673,
    -0.025708360597491264,
    -0.007282372564077377,
    0.08436380326747894,
    0.02445738948881626,
    0.04639553651213646,
    0.008252517320215702,
    0.037264421582221985,
    -0.13522210717201233,
    -0.06906148046255112,
    -0.030352545902132988,
    -0.05537866801023483,
    2.534891854094845e-32,
    -0.0069898818619549274,
    -0.003485059831291437,
    0.03945263475179672,
    0.022840773686766624,
    -0.05226881429553032,
    -0.058638181537389755,
    -0.007764772512018681,
    0.06840015202760696,
    0.005760740954428911,
    -0.1067122220993042,
    -0.04416011646389961,
    0.07244165986776352,
    -0.03352384641766548,
    0.036219846457242966,
    0.04048559069633484,
    -0.03605199605226517,
    -0.051867514848709106,
    0.08763635903596878,
    -0.024197380989789963,
    0.032494258135557175,
    0.0005783474771305919,
    -0.05397762358188629,
    -0.023223744705319405,
    -0.01273155864328146,
    -0.04271300137042999,
    -0.0037594581954181194,
    0.03866823390126228,
    0.0189787819981575,
    0.06791209429502487,
    0.04879958555102348,
    -0.08887268602848053,
    -0.05643823370337486,
    -0.05581996962428093,
    -0.058404430747032166,
    0.010763364844024181,
    -0.0008001380483619869,
    -0.06129108741879463,
    -0.04827973619103432,
    0.01035868376493454,
    -0.10659707337617874,
    -0.03545943647623062,
    0.012575663626194,
    -0.10801120102405548,
    -0.016730519011616707,
    -0.004786000121384859,
    -0.11202684044837952,
    0.01952492818236351,
    -0.05136586353182793,
    -0.024095548316836357,
    0.050085004419088364,
    0.02086634375154972,
    -0.001650407793931663,
    0.03962180018424988,
    -0.08023440092802048,
    -0.1213366910815239,
    -0.027706384658813477,
    -0.05011032149195671,
    0.017977198585867882,
    0.022262966260313988,
    0.03955963999032974,
    0.00557332020252943,
    0.004477598704397678,
    -0.002849102485924959,
    -0.004077136982232332,
    -0.0032155963126569986,
    0.008001748472452164,
    0.02083456702530384,
    -0.10377924889326096,
    -0.06874904036521912,
    -0.0032788750249892473,
    -0.008390434086322784,
    -0.0824912041425705,
    0.005868952255696058,
    0.024747878313064575,
    -0.004568279255181551,
    0.010139385238289833,
    0.10016000270843506,
    -0.016515815630555153,
    -0.07954897731542587,
    -0.05261964350938797,
    0.02111518569290638,
    -0.02860873006284237,
    0.05286088585853577,
    -0.03483344241976738,
    -0.07259047031402588,
    0.004580420441925526,
    0.03926622495055199,
    -0.166000634431839,
    -0.07699546217918396,
    0.059540361166000366,
    -0.019245486706495285,
    -0.00916848424822092,
    -0.0331137552857399,
    0.055056340992450714,
    -0.004854945931583643,
    -2.4303846757717832e-32,
    -0.005995182320475578,
    -0.049858249723911285,
    -0.04303380474448204,
    -0.07520421594381332,
    0.03201296925544739,
    -0.03231949359178543,
    -0.07861537486314774,
    0.057637859135866165,
    0.007171072531491518,
    -0.04925370588898659,
    0.028435440734028816,
    -0.00491434196010232,
    0.004517276305705309,
    -0.014619116671383381,
    0.014438814483582973,
    -0.04389530420303345,
    0.09281447529792786,
    -0.048129454255104065,
    -0.0049879057332873344,
    0.056772686541080475,
    -0.025460517033934593,
    0.10988249629735947,
    0.010160833597183228,
    0.011415178887546062,
    -0.01848943531513214,
    0.010243725031614304,
    0.002541083376854658,
    0.046851418912410736,
    0.03137041628360748,
    -0.04464954882860184,
    0.04882165789604187,
    -0.018423769623041153,
    -0.06672388315200806,
    0.03001188114285469,
    -0.013707033358514309,
    -0.047438930720090866,
    0.0027711098082363605,
    -0.0278086569160223,
    -0.031665872782468796,
    -0.03712369501590729,
    0.070885069668293,
    -0.0076326364651322365,
    -0.007553397212177515,
    0.0009936497081071138,
    0.03287661075592041,
    -0.024576909840106964,
    0.02366974577307701,
    -0.005516212433576584,
    0.0572335384786129,
    0.03855850547552109,
    0.05221414566040039,
    0.006514579989016056,
    -0.013202149420976639,
    0.0442332960665226,
    0.037116821855306625,
    0.0549127496778965,
    0.08904632925987244,
    -0.01752328872680664,
    -0.005076839588582516,
    -0.12472859770059586,
    0.020474523305892944,
    -0.01883714646100998,
    0.008990516886115074,
    -0.06926245987415314,
    0.08119893819093704,
    0.0739799365401268,
    0.08193370699882507,
    0.010323300026357174,
    -0.06634439527988434,
    0.08534333109855652,
    -0.008673458360135555,
    -0.024891700595617294,
    -0.06513672322034836,
    -0.025068460032343864,
    0.01850944198668003,
    0.05526451766490936,
    -0.02291683852672577,
    -0.09909792989492416,
    -0.1043800339102745,
    -0.09813377261161804,
    -0.012815110385417938,
    0.03137654438614845,
    -0.032580871134996414,
    0.0035212233196944,
    0.05615999177098274,
    -0.09882377833127975,
    -0.07189332693815231,
    0.011135533452033997,
    -0.03863977640867233,
    -0.011996063403785229,
    -0.04523107036948204,
    -0.04226699844002724,
    -0.0636165663599968,
    0.08095917850732803,
    -0.03824421390891075,
    -7.73804345044482e-08,
    0.03962715342640877,
    0.0007262919680215418,
    -0.026943836361169815,
    -0.0220185574144125,
    0.0984627902507782,
    -0.020369434729218483,
    -0.018325965851545334,
    0.04390047863125801,
    0.06258556246757507,
    -0.10010078549385071,
    -0.0106404609978199,
    -0.050116702914237976,
    -0.08205593377351761,
    0.006273532751947641,
    0.05214465409517288,
    -0.03985198959708214,
    -0.006901660468429327,
    0.010074789635837078,
    -0.04505673050880432,
    0.021439358592033386,
    -0.05660877749323845,
    -0.047276031225919724,
    -0.029920030385255814,
    -0.013780898414552212,
    0.06914228200912476,
    0.05068880319595337,
    0.10331419855356216,
    0.03977402299642563,
    0.07964885979890823,
    0.0018476403784006834,
    0.036785416305065155,
    0.005139543674886227,
    0.08021125942468643,
    -0.10362376272678375,
    -0.05041404813528061,
    0.11261091381311417,
    0.029489737004041672,
    -0.03621884062886238,
    0.06456917524337769,
    -0.027688097208738327,
    -0.0035965086426585913,
    0.0722709521651268,
    0.04463376849889755,
    0.0417989082634449,
    0.006377979647368193,
    -0.04079001396894455,
    -0.01533069834113121,
    0.029557103291153908,
    0.02596249431371689,
    0.021964412182569504,
    -0.1297491192817688,
    -0.012062166817486286,
    -0.010036646388471127,
    0.014644874259829521,
    -0.022381389513611794,
    0.011908662505447865,
    -0.0047433157451450825,
    -0.053862448781728745,
    0.060161132365465164,
    0.02932307869195938,
    0.14985109865665436,
    0.008940634317696095,
    0.03350779786705971,
    0.04648679867386818
  ]
}